<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Bell Curve Score Visualizer</title>
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <style>
        body {
            margin: 0;
            padding: 0;
        }
        #root {
            min-height: 100vh;
        }
    </style>
</head>
<body>
    <div id="root"></div>
    <script type="text/babel">


const PRESET_COLORS = [
  { name: 'Coral', value: '#FF6B6B', textColor: '#ffffff' },
  { name: 'Ocean', value: '#4ECDC4', textColor: '#1a1a2e' },
  { name: 'Sunset', value: '#FFE66D', textColor: '#1a1a2e' },
  { name: 'Lavender', value: '#9B7EDE', textColor: '#ffffff' },
  { name: 'Mint', value: '#95E1D3', textColor: '#1a1a2e' },
  { name: 'Peach', value: '#FFEAA7', textColor: '#1a1a2e' },
  { name: 'Sky', value: '#74B9FF', textColor: '#1a1a2e' },
  { name: 'Rose', value: '#FD79A8', textColor: '#ffffff' },
  { name: 'Lime', value: '#00B894', textColor: '#ffffff' },
  { name: 'Tangerine', value: '#E17055', textColor: '#ffffff' },
];

const SCORE_LABELS = [
  { score: 55, label: 'Very Low' },
  { score: 70, label: 'Low' },
  { score: 85, label: 'Low Average' },
  { score: 100, label: 'Average' },
  { score: 115, label: 'High Average' },
  { score: 130, label: 'Superior' },
  { score: 145, label: 'Very Superior' },
];

const PRESET_TEMPLATES = [
  {
    name: 'Cognitive Snapshot',
    description: 'Core cognitive domains with typical standard scores.',
    tests: [
      { name: 'Verbal Comprehension', score: 105 },
      { name: 'Visual Spatial', score: 98 },
      { name: 'Fluid Reasoning', score: 112 },
      { name: 'Working Memory', score: 92 },
      { name: 'Processing Speed', score: 88 },
    ],
  },
  {
    name: 'Academic Achievement',
    description: 'Sample achievement profile across subjects.',
    tests: [
      { name: 'Reading', score: 103 },
      { name: 'Math', score: 95 },
      { name: 'Writing', score: 110 },
      { name: 'Spelling', score: 99 },
    ],
  },
  {
    name: 'Strengths & Supports',
    description: 'Balanced profile with clear strengths and needs.',
    tests: [
      { name: 'Listening Comprehension', score: 120 },
      { name: 'Word Reading', score: 107 },
      { name: 'Math Calculation', score: 84 },
      { name: 'Writing Samples', score: 90 },
    ],
  },
];

const HELP_STEPS = [
  {
    title: 'Step 1: Enter Student Info',
    body: 'Add a student name and assessment date to personalize the report.',
  },
  {
    title: 'Step 2: Add Scores',
    body: 'Add each test/section score (40-160). Choose colors to differentiate tests.',
  },
  {
    title: 'Step 3: Use Templates (Optional)',
    body: 'Load a preset template to quickly add common assessment domains.',
  },
  {
    title: 'Step 4: Review & Edit Summary',
    body: 'Switch to Presentation mode to review the bell curve, tooltips, and editable summary.',
  },
  {
    title: 'Step 5: Print or Download PDF',
    body: 'Use Print Preview for final formatting and Download PDF for a shareable report.',
  },
];

const PREDEFINED_TESTS = [
  {
    name: 'Wechsler Intelligence Scale for Children - Fifth Edition (WISC-V)',
    subtests: [
      'Full Scale IQ',
      'Verbal Comprehension Index',
      'Visual Spatial Index',
      'Fluid Reasoning Index',
      'Working Memory Index',
      'Processing Speed Index',
    ]
  },
  {
    name: 'Wechsler Individual Achievement Test - Fourth Edition (WIAT-IV)',
    subtests: [
      'Total Achievement',
      'Reading Composite',
      'Mathematics Composite',
      'Written Expression Composite',
      'Oral Language Composite',
    ]
  },
  {
    name: 'Woodcock-Johnson IV Tests of Cognitive Abilities (WJ-IV COG)',
    subtests: [
      'General Intellectual Ability',
      'Comprehension-Knowledge',
      'Fluid Reasoning',
      'Short-Term Working Memory',
      'Cognitive Processing Speed',
      'Auditory Processing',
      'Long-Term Retrieval',
      'Visual Processing',
    ]
  },
  {
    name: 'Woodcock-Johnson IV Tests of Achievement (WJ-IV ACH)',
    subtests: [
      'Broad Reading',
      'Broad Mathematics',
      'Broad Written Language',
      'Academic Skills',
      'Academic Fluency',
      'Academic Applications',
    ]
  },
  {
    name: 'NEPSY-II Neuropsychological Assessment',
    subtests: [
      'Attention/Executive Functioning',
      'Language',
      'Memory and Learning',
      'Sensorimotor',
      'Social Perception',
      'Visuospatial Processing',
    ]
  },
  {
    name: 'Vineland Adaptive Behavior Scales - Third Edition (Vineland-3)',
    subtests: [
      'Adaptive Behavior Composite',
      'Communication Domain',
      'Daily Living Skills Domain',
      'Socialization Domain',
      'Motor Skills Domain',
    ]
  },
  {
    name: 'Conners 4 ADHD Assessment',
    subtests: [
      'Conners 4 ADHD Index',
      'Inattention/Executive Dysfunction',
      'Hyperactivity',
      'Impulsivity',
      'Emotional Dysregulation',
    ]
  },
  {
    name: 'Behavior Assessment System for Children - Third Edition (BASC-3)',
    subtests: [
      'Behavioral Symptoms Index',
      'Externalizing Problems',
      'Internalizing Problems',
      'Adaptive Skills',
    ]
  },
  {
    name: 'Kaufman Assessment Battery for Children (KABC-II)',
    subtests: [
      'Mental Processing Index',
      'Fluid Crystallized Index',
      'Sequential Index',
      'Simultaneous Index',
      'Learning Index',
      'Planning Index',
    ]
  },
  {
    name: 'Comprehensive Test of Phonological Processing (CTOPP-2)',
    subtests: [
      'Phonological Awareness',
      'Phonological Memory',
      'Rapid Symbolic Naming',
      'Phonological Processing Index',
    ]
  },
  {
    name: 'Comprehensive Test of Nonverbal Intelligence 2nd Edition (CTONI-2)',
    subtests: [
      'Pictorial Scale Composite',
      'Geometric Composite',
      'Full Scale',
      'Nonverbal Index',
    ]
  },
  {
    name: 'Cognitive Assessment System-Second Edition Brief (CAS-2 Brief)',
    subtests: [
      'Planned Codes',
      'Simultaneous Matrices',
      'Expressive Attention',
      'Successive Digits',
    ]
  },
  {
    name: 'Wide Range Assessment of Memory and Learning- Third Edition (WRAML-3)',
    subtests: [
      'Verbal Memory',
      'Visual Memory',
      'Attention/Concentration',
      'General Memory',
    ]
  },
  // Standalone tests/indices
  'Full Scale IQ',
  'Verbal Comprehension Index',
  'Visual Spatial Index',
  'Fluid Reasoning Index',
  'Working Memory Index',
  'Processing Speed Index',
  'Total Achievement',
  'Reading Composite',
  'Mathematics Composite',
  'Written Expression Composite',
  'Oral Language Composite',
  'General Intellectual Ability',
  'Comprehension-Knowledge',
  'Fluid Reasoning',
  'Short-Term Working Memory',
  'Cognitive Processing Speed',
  'Auditory Processing',
  'Long-Term Retrieval',
  'Visual Processing',
  'Broad Reading',
  'Broad Mathematics',
  'Broad Written Language',
  'Academic Skills',
  'Academic Fluency',
  'Academic Applications',
  'Attention/Executive Functioning',
  'Language',
  'Memory and Learning',
  'Sensorimotor',
  'Social Perception',
  'Visuospatial Processing',
  'Adaptive Behavior Composite',
  'Communication Domain',
  'Daily Living Skills Domain',
  'Socialization Domain',
  'Motor Skills Domain',
  'Conners 4 ADHD Index',
  'Inattention/Executive Dysfunction',
  'Hyperactivity',
  'Impulsivity',
  'Emotional Dysregulation',
  'Behavioral Symptoms Index',
  'Externalizing Problems',
  'Internalizing Problems',
  'Adaptive Skills',
  'Beery-Buktenica Developmental Test of Visual Motor Integration, Sixth Edition',
  'Auditory Memory Index',
  'Listening Comprehension Index',
  'Mental Processing Index',
  'Fluid Crystallized Index',
  'Sequential Index',
  'Simultaneous Index',
  'Learning Index',
  'Planning Index',
  'Phonological Awareness',
  'Phonological Memory',
  'Rapid Symbolic Naming',
  'Phonological Processing Index',
  'Pictorial Scale Composite',
  'Geometric Composite',
  'Full Scale',
  'Nonverbal Index',
  'Planned Codes',
  'Simultaneous Matrices',
  'Expressive Attention',
  'Successive Digits',
  'Verbal Memory',
  'Visual Memory',
  'Attention/Concentration',
  'General Memory',
];

// Helper function to determine if a color is light or dark
const getContrastTextColor = (hexColor) => {
  const hex = hexColor.replace('#', '');
  const r = parseInt(hex.substring(0, 2), 16);
  const g = parseInt(hex.substring(2, 4), 16);
  const b = parseInt(hex.substring(4, 6), 16);
  const luminance = (0.299 * r + 0.587 * g + 0.114 * b) / 255;
  return luminance > 0.5 ? '#1a1a2e' : '#ffffff';
};

function BellCurveApp() {
  const [mode, setMode] = React.useState('input');
  const [tests, setTests] = React.useState([]);
  const [newTest, setNewTest] = React.useState({ name: '', score: '', color: PRESET_COLORS[0].value });
  const [studentName, setStudentName] = React.useState('');
  const [assessmentDate, setAssessmentDate] = React.useState('');
  const [visibleTestIds, setVisibleTestIds] = React.useState(new Set());
  const [hoveredTestId, setHoveredTestId] = React.useState(null);
  const [summaryOverride, setSummaryOverride] = React.useState('');
  const [isPrintPreview, setIsPrintPreview] = React.useState(false);
  const [showHelpPanel, setShowHelpPanel] = React.useState(false);
  const importInputRef = React.useRef(null);

  // Branding state
  const [branding, setBranding] = React.useState({
    schoolName: '',
    schoolLogo: '',
    primaryColor: '#667eea',
    footerText: '',
  });
  const [showBrandingPanel, setShowBrandingPanel] = React.useState(false);

  // Student profiles state
  const [savedProfiles, setSavedProfiles] = React.useState([]);
  const [currentProfileId, setCurrentProfileId] = React.useState(null);
  const [showProfilesPanel, setShowProfilesPanel] = React.useState(false);

  // Bell curve label display options
  const [showLabelsOnCurve, setShowLabelsOnCurve] = React.useState(false);

  // Autocomplete state
  const [autocompleteSuggestions, setAutocompleteSuggestions] = React.useState([]);
  const [showAutocomplete, setShowAutocomplete] = React.useState(false);
  const autocompleteRef = React.useRef(null);

  // Edit test state
  const [editingTestId, setEditingTestId] = React.useState(null);
  const [editingTest, setEditingTest] = React.useState(null);

  // Theme and customization state
  const [theme, setTheme] = React.useState('dark'); // 'light' or 'dark'
  const [bellCurveColor, setBellCurveColor] = React.useState('#667eea');
  const [showThemePanel, setShowThemePanel] = React.useState(false);

  // Label customization state
  const [labelStyles, setLabelStyles] = React.useState({
    borderRadius: 4,
    padding: 6,
    maxWidth: 200,
    fontSize: 10,
  });
  const [labelPositions, setLabelPositions] = React.useState({}); // { testId: { x: offsetX, y: offsetY } }
  const [showLabelsPanel, setShowLabelsPanel] = React.useState(false);
  const [draggedLabel, setDraggedLabel] = React.useState(null);

  // Theme colors based on current theme
  const themeColors = React.useMemo(() => {
    if (theme === 'light') {
      return {
        background: 'linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%)',
        cardBg: '#ffffff',
        cardBgAlt: 'rgba(248, 249, 250, 0.95)',
        cardBorder: 'rgba(0, 0, 0, 0.15)',
        text: '#1a1a2e',
        textSecondary: '#495057',
        textMuted: '#6c757d',
        heading: '#212529',
        inputBg: '#ffffff',
        inputBorder: '#ced4da',
        inputBorderFocus: '#667eea',
        inputText: '#212529',
        inputPlaceholder: '#6c757d',
        chartBg: '#ffffff',
        chartText: '#495057',
        svgText: '#495057',
        panelBg: 'linear-gradient(135deg, #ffffff 0%, #f8f9fa 100%)',
        hoverBg: 'rgba(102, 126, 234, 0.08)',
        infoText: '#495057',
        infoPanel: '#f8f9fa',
      };
    } else {
      return {
        background: 'linear-gradient(135deg, #1a1a2e 0%, #16213e 100%)',
        cardBg: 'rgba(255, 255, 255, 0.04)',
        cardBgAlt: 'rgba(255, 255, 255, 0.06)',
        cardBorder: 'rgba(255, 255, 255, 0.08)',
        text: '#f8f9fa',
        textSecondary: 'rgba(255, 255, 255, 0.85)',
        textMuted: 'rgba(255, 255, 255, 0.5)',
        heading: '#c8d6e5',
        inputBg: 'rgba(255, 255, 255, 0.05)',
        inputBorder: 'rgba(255, 255, 255, 0.1)',
        inputBorderFocus: '#667eea',
        inputText: '#f8f9fa',
        inputPlaceholder: 'rgba(255, 255, 255, 0.4)',
        chartBg: 'rgba(255, 255, 255, 0.02)',
        chartText: 'rgba(255, 255, 255, 0.7)',
        svgText: 'rgba(255, 255, 255, 0.7)',
        panelBg: 'linear-gradient(135deg, #1a1a2e 0%, #16213e 100%)',
        hoverBg: 'rgba(102, 126, 234, 0.2)',
        infoText: 'rgba(255, 255, 255, 0.7)',
        infoPanel: 'rgba(255, 255, 255, 0.04)',
      };
    }
  }, [theme]);

  // Load branding and profiles from localStorage on mount
  React.useEffect(() => {
    try {
      const savedBranding = localStorage.getItem('bellcurve_branding');
      if (savedBranding) {
        setBranding(JSON.parse(savedBranding));
      }

      const profiles = localStorage.getItem('bellcurve_profiles');
      if (profiles) {
        setSavedProfiles(JSON.parse(profiles));
      }

      const savedTheme = localStorage.getItem('bellcurve_theme');
      if (savedTheme) {
        setTheme(savedTheme);
      } else {
        // Set initial theme on HTML element if no saved theme
        document.documentElement.setAttribute('data-theme', 'dark');
      }

      const savedCurveColor = localStorage.getItem('bellcurve_curvecolor');
      if (savedCurveColor) {
        setBellCurveColor(savedCurveColor);
      }

      const savedLabelStyles = localStorage.getItem('bellcurve_labelstyles');
      if (savedLabelStyles) {
        setLabelStyles(JSON.parse(savedLabelStyles));
      }

      const savedLabelPositions = localStorage.getItem('bellcurve_labelpositions');
      if (savedLabelPositions) {
        setLabelPositions(JSON.parse(savedLabelPositions));
      }
    } catch (error) {
      console.error('Error loading data from localStorage:', error);
    }
  }, []);

  // Save branding to localStorage whenever it changes
  React.useEffect(() => {
    try {
      localStorage.setItem('bellcurve_branding', JSON.stringify(branding));
    } catch (error) {
      console.error('Error saving branding:', error);
    }
  }, [branding]);

  // Save theme preferences to localStorage AND set data-theme on HTML element
  React.useEffect(() => {
    try {
      localStorage.setItem('bellcurve_theme', theme);
      localStorage.setItem('bellcurve_curvecolor', bellCurveColor);

      // CRITICAL FIX: Set data-theme on HTML element for CSS variables to work
      document.documentElement.setAttribute('data-theme', theme);
    } catch (error) {
      console.error('Error saving theme:', error);
    }
  }, [theme, bellCurveColor]);

  // Save label customization to localStorage
  React.useEffect(() => {
    try {
      localStorage.setItem('bellcurve_labelstyles', JSON.stringify(labelStyles));
      localStorage.setItem('bellcurve_labelpositions', JSON.stringify(labelPositions));
    } catch (error) {
      console.error('Error saving label settings:', error);
    }
  }, [labelStyles, labelPositions]);

  React.useEffect(() => {
    const handleAfterPrint = () => {
      setIsPrintPreview(false);
    };
    window.addEventListener('afterprint', handleAfterPrint);
    return () => window.removeEventListener('afterprint', handleAfterPrint);
  }, []);

  React.useEffect(() => {
    if (mode !== 'presentation') {
      setIsPrintPreview(false);
    }
  }, [mode]);

  // Save current profile
  const saveCurrentProfile = () => {
    if (!studentName) {
      alert('Please enter a student name before saving');
      return;
    }

    const profile = {
      id: currentProfileId || Date.now(),
      studentName,
      assessmentDate,
      tests: tests.map(t => ({ ...t })),
      summaryOverride,
      savedAt: new Date().toISOString(),
    };

    const updatedProfiles = currentProfileId
      ? savedProfiles.map(p => p.id === currentProfileId ? profile : p)
      : [...savedProfiles, profile];

    setSavedProfiles(updatedProfiles);
    setCurrentProfileId(profile.id);

    try {
      localStorage.setItem('bellcurve_profiles', JSON.stringify(updatedProfiles));
      alert(`Profile saved successfully!\nStudent: ${studentName}\nTests saved: ${tests.length}\nAssessment date: ${assessmentDate || 'Not set'}`);
    } catch (error) {
      console.error('Error saving profile:', error);
      alert('Error saving profile. Please try again.');
    }
  };

  // Load a profile
  const loadProfile = (profile) => {
    setStudentName(profile.studentName);
    setAssessmentDate(profile.assessmentDate || '');
    setTests(profile.tests ? profile.tests.map(t => ({ ...t })) : []);
    setSummaryOverride(profile.summaryOverride || '');
    setCurrentProfileId(profile.id);
    setVisibleTestIds(new Set(profile.tests ? profile.tests.map(t => t.id) : []));
    setShowProfilesPanel(false);
    setMode('input');

    // Show confirmation message
    const testCount = profile.tests ? profile.tests.length : 0;
    alert(`Profile loaded successfully!\nStudent: ${profile.studentName}\nTests loaded: ${testCount}`);
  };

  // Delete a profile
  const deleteProfile = (profileId) => {
    if (confirm('Are you sure you want to delete this profile?')) {
      const updatedProfiles = savedProfiles.filter(p => p.id !== profileId);
      setSavedProfiles(updatedProfiles);

      try {
        localStorage.setItem('bellcurve_profiles', JSON.stringify(updatedProfiles));
        if (currentProfileId === profileId) {
          setCurrentProfileId(null);
        }
      } catch (error) {
        console.error('Error deleting profile:', error);
      }
    }
  };

  // Start a new profile
  const startNewProfile = () => {
    if (tests.length > 0 || studentName) {
      if (!confirm('Start a new profile? Any unsaved changes will be lost.')) {
        return;
      }
    }
    setStudentName('');
    setAssessmentDate('');
    setTests([]);
    setSummaryOverride('');
    setCurrentProfileId(null);
    setVisibleTestIds(new Set());
    setShowProfilesPanel(false);
  };

  // Handle logo upload
  const handleLogoUpload = (e) => {
    const file = e.target.files[0];
    if (file) {
      const reader = new FileReader();
      reader.onloadend = () => {
        setBranding({ ...branding, schoolLogo: reader.result });
      };
      reader.readAsDataURL(file);
    }
  };

  // Print/Export PDF functionality
  const handlePrint = () => {
    window.print();
  };

  const handleDownloadPdf = () => {
    setIsPrintPreview(true);
    setTimeout(() => {
      window.print();
    }, 100);
  };

  // Label drag handlers
  const handleLabelDragStart = (e, testId, startX, startY) => {
    e.preventDefault();
    e.stopPropagation();

    const clientX = e.type === 'touchstart' ? e.touches[0].clientX : e.clientX;
    const clientY = e.type === 'touchstart' ? e.touches[0].clientY : e.clientY;

    setDraggedLabel({
      testId,
      startX: clientX,
      startY: clientY,
      initialOffsetX: labelPositions[testId]?.x || 0,
      initialOffsetY: labelPositions[testId]?.y || 0,
    });
  };

  // Handle drag move and end via useEffect
  React.useEffect(() => {
    if (!draggedLabel) return;

    const handleMove = (e) => {
      e.preventDefault();
      const clientX = e.type === 'touchmove' ? e.touches[0].clientX : e.clientX;
      const clientY = e.type === 'touchmove' ? e.touches[0].clientY : e.clientY;

      const deltaX = clientX - draggedLabel.startX;
      const deltaY = clientY - draggedLabel.startY;

      // Update label position with normalized coordinates
      setLabelPositions(prev => ({
        ...prev,
        [draggedLabel.testId]: {
          x: draggedLabel.initialOffsetX + deltaX,
          y: draggedLabel.initialOffsetY + deltaY,
        },
      }));
    };

    const handleEnd = () => {
      setDraggedLabel(null);
    };

    document.addEventListener('mousemove', handleMove);
    document.addEventListener('mouseup', handleEnd);
    document.addEventListener('touchmove', handleMove);
    document.addEventListener('touchend', handleEnd);

    return () => {
      document.removeEventListener('mousemove', handleMove);
      document.removeEventListener('mouseup', handleEnd);
      document.removeEventListener('touchmove', handleMove);
      document.removeEventListener('touchend', handleEnd);
    };
  }, [draggedLabel]);

  const handleExportProfiles = () => {
    if (savedProfiles.length === 0) {
      alert('No saved profiles to export yet.');
      return;
    }

    const payload = {
      exportedAt: new Date().toISOString(),
      version: '1.0',
      profiles: savedProfiles,
    };
    const blob = new Blob([JSON.stringify(payload, null, 2)], { type: 'application/json' });
    const url = URL.createObjectURL(blob);
    const anchor = document.createElement('a');
    anchor.href = url;
    anchor.download = `bell-curve-profiles-${new Date().toISOString().slice(0, 10)}.json`;
    anchor.click();
    URL.revokeObjectURL(url);
  };

  const handleImportProfiles = (event) => {
    const file = event.target.files?.[0];
    if (!file) return;

    const reader = new FileReader();
    reader.onload = () => {
      try {
        const parsed = JSON.parse(reader.result);
        const incomingProfiles = Array.isArray(parsed) ? parsed : parsed.profiles;
        if (!Array.isArray(incomingProfiles)) {
          throw new Error('Invalid file format.');
        }
        const confirmImport = confirm('Import profiles? Existing profiles will be merged.');
        if (!confirmImport) {
          event.target.value = '';
          return;
        }
        const merged = [...savedProfiles, ...incomingProfiles];
        const deduped = Array.from(new Map(merged.map(p => [p.id, p])).values());
        setSavedProfiles(deduped);
        localStorage.setItem('bellcurve_profiles', JSON.stringify(deduped));
        alert(`Imported ${incomingProfiles.length} profile(s) successfully.`);
      } catch (error) {
        console.error('Error importing profiles:', error);
        alert('Unable to import profiles. Please check the file format.');
      } finally {
        event.target.value = '';
      }
    };
    reader.readAsText(file);
  };

  const applyTemplate = (template) => {
    if (tests.length > 0) {
      const confirmReplace = confirm('Apply template? This will replace existing tests.');
      if (!confirmReplace) return;
    }
    const templatedTests = template.tests.map((test, index) => ({
      ...test,
      id: Date.now() + index,
      color: PRESET_COLORS[index % PRESET_COLORS.length].value,
    }));
    setTests(templatedTests);
    setSummaryOverride('');
    setVisibleTestIds(new Set(templatedTests.map(t => t.id)));
  };

  // Autocomplete handlers
  const handleTestNameChange = (e) => {
    const value = e.target.value;
    setNewTest({ ...newTest, name: value });

    if (value.trim().length > 0) {
      const filtered = PREDEFINED_TESTS.filter(test => {
        if (typeof test === 'string') {
          return test.toLowerCase().includes(value.toLowerCase());
        } else {
          // Check parent test name or any subtest name
          return test.name.toLowerCase().includes(value.toLowerCase()) ||
                 test.subtests.some(subtest => subtest.toLowerCase().includes(value.toLowerCase()));
        }
      });
      setAutocompleteSuggestions(filtered);
      setShowAutocomplete(filtered.length > 0);
    } else {
      setAutocompleteSuggestions([]);
      setShowAutocomplete(false);
    }
  };

  const handleSuggestionClick = (suggestion) => {
    // Check if suggestion is a parent test with subtests
    if (typeof suggestion === 'object' && suggestion.subtests) {
      // Auto-add all subtests with the same color
      const sharedColor = newTest.color;
      const newTests = suggestion.subtests.map((subtest, index) => ({
        name: subtest,
        score: 100, // Default score, user can edit
        id: Date.now() + index,
        color: sharedColor,
      }));
      setTests([...tests, ...newTests]);
      setVisibleTestIds(prev => new Set([...prev, ...newTests.map(t => t.id)]));
      const nextColorIndex = (tests.length + newTests.length) % PRESET_COLORS.length;
      setNewTest({ name: '', score: '', color: PRESET_COLORS[nextColorIndex].value });
    } else {
      // Single test/subtest - just populate the input field
      const testName = typeof suggestion === 'string' ? suggestion : suggestion.name;
      setNewTest({ ...newTest, name: testName });
    }
    setShowAutocomplete(false);
    setAutocompleteSuggestions([]);
  };

  // Close autocomplete when clicking outside
  React.useEffect(() => {
    const handleClickOutside = (event) => {
      if (autocompleteRef.current && !autocompleteRef.current.contains(event.target)) {
        setShowAutocomplete(false);
      }
    };
    document.addEventListener('mousedown', handleClickOutside);
    return () => document.removeEventListener('mousedown', handleClickOutside);
  }, []);

  const addTest = () => {
    if (newTest.name && newTest.score) {
      const score = parseInt(newTest.score);
      if (score >= 40 && score <= 160) {
        const newId = Date.now();
        setTests([...tests, { ...newTest, score, id: newId }]);
        setVisibleTestIds(prev => new Set([...prev, newId]));
        const nextColorIndex = (tests.length + 1) % PRESET_COLORS.length;
        setNewTest({ name: '', score: '', color: PRESET_COLORS[nextColorIndex].value });
      }
    }
  };

  const removeTest = (id) => {
    setTests(tests.filter(t => t.id !== id));
    setVisibleTestIds(prev => {
      const newSet = new Set(prev);
      newSet.delete(id);
      return newSet;
    });
  };

  const startEditingTest = (test) => {
    setEditingTestId(test.id);
    setEditingTest({ ...test });
  };

  const cancelEditingTest = () => {
    setEditingTestId(null);
    setEditingTest(null);
  };

  const saveEditedTest = () => {
    if (editingTest && editingTest.name && editingTest.score) {
      const score = parseInt(editingTest.score);
      if (score >= 40 && score <= 160) {
        setTests(tests.map(t => t.id === editingTestId ? { ...editingTest, score } : t));
        setEditingTestId(null);
        setEditingTest(null);
      }
    }
  };

  const toggleTestVisibility = (id) => {
    setVisibleTestIds(prev => {
      const newSet = new Set(prev);
      if (newSet.has(id)) {
        newSet.delete(id);
      } else {
        newSet.add(id);
      }
      return newSet;
    });
  };

  const showAllTests = () => {
    setVisibleTestIds(new Set(tests.map(t => t.id)));
  };

  const hideAllTests = () => {
    setVisibleTestIds(new Set());
  };

  // Chart dimensions with proper padding for the curve peak and tooltips
  const chartTopPadding = 120; // Increased from 80 to accommodate tooltips/labels
  const chartBottomY = 340; // Increased proportionally to maintain curve shape

  // Generate bell curve path
  const generateBellCurve = () => {
    const points = [];
    const width = 800;
    const mean = 100;
    const stdDev = 15;
    
    for (let x = 0; x <= width; x += 2) {
      const score = 40 + (x / width) * 120;
      const z = (score - mean) / stdDev;
      const y = Math.exp(-0.5 * z * z) / (stdDev * Math.sqrt(2 * Math.PI));
      const scaledY = chartBottomY - (y * stdDev * (chartBottomY - chartTopPadding) * 2.5);
      points.push(`${x},${scaledY}`);
    }
    
    return `M ${points.join(' L ')} L 800,${chartBottomY} L 0,${chartBottomY} Z`;
  };

  const getScoreX = (score) => {
    return ((score - 40) / 120) * 800;
  };

  const getScoreY = (score) => {
    const mean = 100;
    const stdDev = 15;
    const z = (score - mean) / stdDev;
    const y = Math.exp(-0.5 * z * z) / (stdDev * Math.sqrt(2 * Math.PI));
    return chartBottomY - (y * stdDev * (chartBottomY - chartTopPadding) * 2.5);
  };

  const bellPath = React.useMemo(() => generateBellCurve(), []);

  // Generate average range area (85-115)
  const generateAverageArea = () => {
    const points = [];
    const mean = 100;
    const stdDev = 15;
    
    const startX = getScoreX(85);
    const endX = getScoreX(115);
    
    for (let x = startX; x <= endX; x += 2) {
      const score = 40 + (x / 800) * 120;
      const z = (score - mean) / stdDev;
      const y = Math.exp(-0.5 * z * z) / (stdDev * Math.sqrt(2 * Math.PI));
      const scaledY = chartBottomY - (y * stdDev * (chartBottomY - chartTopPadding) * 2.5);
      points.push(`${x},${scaledY}`);
    }
    
    return `M ${startX},${chartBottomY} L ${points.join(' L ')} L ${endX},${chartBottomY} Z`;
  };

  const averageAreaPath = React.useMemo(() => generateAverageArea(), []);

  const getScoreDescription = (score) => {
    if (score < 70) return 'Very Low';
    if (score < 85) return 'Low';
    if (score < 115) return 'Average';
    if (score < 130) return 'High';
    return 'Very High';
  };

  // Calculate percentile rank from standard score
  const getPercentileRank = (score) => {
    const mean = 100;
    const stdDev = 15;
    const z = (score - mean) / stdDev;

    // Approximation of cumulative normal distribution
    const t = 1 / (1 + 0.2316419 * Math.abs(z));
    const d = 0.3989423 * Math.exp(-z * z / 2);
    const probability = d * t * (0.3193815 + t * (-0.3565638 + t * (1.781478 + t * (-1.821256 + t * 1.330274))));

    let percentile;
    if (z >= 0) {
      percentile = (1 - probability) * 100;
    } else {
      percentile = probability * 100;
    }

    // Round to appropriate precision
    if (percentile >= 99) return '>99';
    if (percentile < 1) return '<1';
    return Math.round(percentile).toString();
  };

  // Format percentile with proper ordinal suffix (1st, 2nd, 3rd, etc.)
  const formatPercentile = (percentileStr) => {
    if (percentileStr === '>99' || percentileStr === '<1') return percentileStr;

    const num = parseInt(percentileStr);
    const lastDigit = num % 10;
    const lastTwoDigits = num % 100;

    // Special cases: 11th, 12th, 13th
    if (lastTwoDigits >= 11 && lastTwoDigits <= 13) {
      return num + 'th';
    }

    // Regular cases
    if (lastDigit === 1) return num + 'st';
    if (lastDigit === 2) return num + 'nd';
    if (lastDigit === 3) return num + 'rd';
    return num + 'th';
  };

  // Generate comprehensive assessment summary
  const generateSummary = () => {
    if (tests.length === 0) return '';

    const sortedTests = [...tests].sort((a, b) => b.score - a.score);

    // Categorize scores
    const veryHigh = tests.filter(t => t.score >= 130);
    const high = tests.filter(t => t.score >= 115 && t.score < 130);
    const average = tests.filter(t => t.score >= 85 && t.score < 115);
    const low = tests.filter(t => t.score >= 70 && t.score < 85);
    const veryLow = tests.filter(t => t.score < 70);

    let summary = [];

    // Strengths
    if (veryHigh.length > 0 || high.length > 0) {
      const strengths = [...veryHigh, ...high];
      summary.push(`${studentName || 'The student'} demonstrates notable strengths in ${strengths.map(t => `${t.name} (${t.score}, ${formatPercentile(getPercentileRank(t.score))} percentile)`).join(', ')}.`);
    }

    // Average performance areas
    if (average.length > 0) {
      summary.push(`Performance in the average range was noted for ${average.map(t => t.name).join(', ')}, indicating age-appropriate development in these areas.`);
    }

    // Areas of concern
    if (low.length > 0 || veryLow.length > 0) {
      const concerns = [...low, ...veryLow];
      summary.push(`Areas that may benefit from additional support include ${concerns.map(t => `${t.name} (${t.score}, ${formatPercentile(getPercentileRank(t.score))} percentile)`).join(', ')}.`);
    }

    // Score variability
    const highest = sortedTests[0];
    const lowest = sortedTests[sortedTests.length - 1];
    const range = highest.score - lowest.score;

    if (range >= 30) {
      summary.push(`There is significant variability in performance across assessed areas, with scores ranging from ${lowest.score} (${lowest.name}) to ${highest.score} (${highest.name}). This ${range}-point difference suggests an uneven cognitive profile with distinct strengths and weaknesses.`);
    } else if (range >= 15) {
      summary.push(`Performance shows moderate variability across assessed areas, with scores ranging from ${lowest.score} to ${highest.score}.`);
    } else {
      summary.push(`Performance is relatively consistent across assessed areas, with scores ranging from ${lowest.score} to ${highest.score}.`);
    }

    // Recommendations
    summary.push(`These results should be interpreted in the context of ${studentName || 'the student'}'s educational history, behavioral observations, and other relevant information. Follow-up discussions with the educational team are recommended to develop appropriate interventions and support strategies.`);

    return summary.join(' ');
  };

  // Get visible tests based on selection
  const getVisibleTests = () => {
    return tests.filter(t => visibleTestIds.has(t.id));
  };

  // Calculate stacked positions for overlapping scores
  const getStackedPositions = (visibleTests) => {
    const markerRadius = 18;
    const stackGap = 8;
    const proximityThreshold = 5; // scores within 5 points are considered "close"

    // Sort by score
    const sorted = [...visibleTests].sort((a, b) => a.score - b.score);

    // Group tests by proximity
    const groups = [];
    let currentGroup = [];

    sorted.forEach((test, index) => {
      if (currentGroup.length === 0) {
        currentGroup.push(test);
      } else {
        const lastTest = currentGroup[currentGroup.length - 1];
        if (Math.abs(test.score - lastTest.score) <= proximityThreshold) {
          currentGroup.push(test);
        } else {
          groups.push([...currentGroup]);
          currentGroup = [test];
        }
      }
    });
    if (currentGroup.length > 0) {
      groups.push(currentGroup);
    }

    // Calculate positions with stacking
    const positions = [];

    groups.forEach(group => {
      // Find the average score position for the group
      const avgScore = group.reduce((sum, t) => sum + t.score, 0) / group.length;
      const baseX = getScoreX(avgScore);
      const baseY = getScoreY(avgScore);

      group.forEach((test, stackIndex) => {
        const x = getScoreX(test.score);
        const y = baseY - (stackIndex * (markerRadius * 2 + stackGap));
        positions.push({
          test,
          x,
          y,
          baseY, // For the vertical line
          isStacked: group.length > 1,
          stackIndex,
        });
      });
    });

    return positions;
  };

  // Calculate label positions with collision avoidance - bubbles and labels separated
  const getLabelPositionsWithCollisionAvoidance = (stackedPositions) => {
    if (!stackedPositions || stackedPositions.length === 0) return [];

    const labelHeight = 18; // Height of label rect
    const labelSpacing = 12; // Vertical spacing between labels
    const markerRadius = 18; // Radius of marker circle
    const bubbleLabelGap = 16; // Gap between bottom of bubble stack and first label
    const horizontalGroupThreshold = 50; // Group bubbles within this x distance

    // Group stackedPositions by x proximity to identify bubble stacks
    const groups = [];
    const sortedByX = [...stackedPositions].sort((a, b) => a.x - b.x);

    let currentGroup = [sortedByX[0]];
    for (let i = 1; i < sortedByX.length; i++) {
      if (Math.abs(sortedByX[i].x - currentGroup[0].x) <= horizontalGroupThreshold) {
        currentGroup.push(sortedByX[i]);
      } else {
        groups.push(currentGroup);
        currentGroup = [sortedByX[i]];
      }
    }
    groups.push(currentGroup);

    // For each group, calculate bubble stack extent and position labels below
    const labelData = [];

    groups.forEach(group => {
      // Find the lowest bubble in this group (highest y value, since y increases downward)
      const lowestBubbleY = Math.max(...group.map(item => item.y));
      const bubbleStackBottom = lowestBubbleY + markerRadius;

      // Labels start below the bubble stack
      let currentLabelY = bubbleStackBottom + bubbleLabelGap + labelHeight / 2;

      // Sort group by y-position (top to bottom) to maintain visual order
      const sortedGroup = [...group].sort((a, b) => a.y - b.y);

      sortedGroup.forEach((item) => {
        const { test, x, y } = item;
        const rectWidth = Math.max(test.name.length * 7 + 12, 60);

        // Determine text anchor based on x position
        let textAnchor = 'middle';
        let adjustedX = x;

        if (x < 100) {
          textAnchor = 'start';
          adjustedX = x + 25;
        } else if (x > 700) {
          textAnchor = 'end';
          adjustedX = x - 25;
        }

        const rectX = textAnchor === 'middle'
          ? adjustedX - rectWidth / 2
          : textAnchor === 'start'
            ? adjustedX - 6
            : adjustedX - rectWidth + 6;

        labelData.push({
          test,
          markerX: x,
          markerY: y,
          textAnchor,
          adjustedX,
          rectWidth,
          rectHeight: labelHeight,
          rectX,
          labelY: currentLabelY,
          needsConnector: true, // Always show connector since labels are below bubbles
        });

        // Move to next label position
        currentLabelY += labelHeight + labelSpacing;
      });
    });

    return labelData;
  };

  const computedSummary = summaryOverride.trim() ? summaryOverride : generateSummary();

  return (
    <div
      className={isPrintPreview ? 'print-preview' : ''}
      style={{
        minHeight: '100vh',
        background: isPrintPreview
          ? '#ffffff'
          : themeColors.background,
        fontFamily: "'Nunito', 'Segoe UI', sans-serif",
        color: isPrintPreview ? '#1a1a2e' : themeColors.text,
        padding: '0',
      }}
    >
      <style>{`
        @import url('https://fonts.googleapis.com/css2?family=Nunito:wght@400;600;700;800&family=Playfair+Display:wght@600;700&display=swap');

        /* Theme CSS Variables */
        :root[data-theme="light"] {
          --ui-bg: #ffffff;
          --ui-bg-alt: rgba(248, 249, 250, 0.95);
          --ui-bg-hover: rgba(102, 126, 234, 0.08);
          --ui-border: rgba(0, 0, 0, 0.15);
          --ui-border-light: rgba(0, 0, 0, 0.1);
          --ui-text: #1a1a2e;
          --ui-text-secondary: #495057;
          --ui-text-muted: #6c757d;
          --input-bg: #ffffff;
          --input-bg-focus: #ffffff;
          --input-border: #ced4da;
          --input-text: #212529;
          --input-placeholder: #6c757d;
          --button-inactive-bg: rgba(0, 0, 0, 0.08);
          --button-inactive-text: rgba(0, 0, 0, 0.6);
          --button-inactive-hover-bg: rgba(0, 0, 0, 0.15);
          --button-inactive-hover-text: rgba(0, 0, 0, 0.9);
        }

        :root[data-theme="dark"] {
          --ui-bg: rgba(255, 255, 255, 0.06);
          --ui-bg-alt: rgba(255, 255, 255, 0.04);
          --ui-bg-hover: rgba(255, 255, 255, 0.1);
          --ui-border: rgba(255, 255, 255, 0.08);
          --ui-border-light: rgba(255, 255, 255, 0.1);
          --ui-text: rgba(255, 255, 255, 0.85);
          --ui-text-secondary: rgba(255, 255, 255, 0.7);
          --ui-text-muted: rgba(255, 255, 255, 0.5);
          --input-bg: rgba(255, 255, 255, 0.05);
          --input-bg-focus: rgba(255, 255, 255, 0.1);
          --input-border: rgba(255, 255, 255, 0.1);
          --input-text: #f8f9fa;
          --input-placeholder: rgba(255, 255, 255, 0.4);
          --button-inactive-bg: rgba(255, 255, 255, 0.08);
          --button-inactive-text: rgba(255, 255, 255, 0.6);
          --button-inactive-hover-bg: rgba(255, 255, 255, 0.15);
          --button-inactive-hover-text: rgba(255, 255, 255, 0.9);
        }

        * {
          box-sizing: border-box;
        }

        
        .mode-btn {
          padding: 14px 32px;
          border: none;
          border-radius: 12px;
          font-size: 15px;
          font-weight: 700;
          cursor: pointer;
          transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
          font-family: 'Nunito', sans-serif;
          text-transform: uppercase;
          letter-spacing: 1px;
        }
        
        .mode-btn.active {
          background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
          color: white;
          box-shadow: 0 8px 30px rgba(102, 126, 234, 0.4);
          transform: translateY(-2px);
        }
        
        .mode-btn.inactive {
          background: var(--button-inactive-bg);
          color: var(--button-inactive-text);
          backdrop-filter: blur(10px);
        }

        .mode-btn.inactive:hover {
          background: var(--button-inactive-hover-bg);
          color: var(--button-inactive-hover-text);
        }
        
        .input-field {
          padding: 14px 18px;
          border: 2px solid var(--input-border);
          border-radius: 12px;
          font-size: 15px;
          background: var(--input-bg);
          color: var(--input-text);
          font-family: 'Nunito', sans-serif;
          transition: all 0.3s ease;
          backdrop-filter: blur(10px);
        }

        .input-field:focus {
          outline: none;
          border-color: #667eea;
          background: var(--input-bg-focus);
          box-shadow: 0 0 20px rgba(102, 126, 234, 0.2);
        }

        .input-field::placeholder {
          color: var(--input-placeholder);
        }
        
        .add-btn {
          padding: 14px 28px;
          background: linear-gradient(135deg, #00b894 0%, #00cec9 100%);
          border: none;
          border-radius: 12px;
          color: white;
          font-size: 15px;
          font-weight: 700;
          cursor: pointer;
          transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
          font-family: 'Nunito', sans-serif;
          text-transform: uppercase;
          letter-spacing: 1px;
        }
        
        .add-btn:hover {
          transform: translateY(-3px);
          box-shadow: 0 10px 30px rgba(0, 184, 148, 0.4);
        }
        
        .add-btn:disabled {
          opacity: 0.5;
          cursor: not-allowed;
          transform: none;
        }
        
        .test-card {
          background: var(--ui-bg);
          border-radius: 16px;
          padding: 18px 22px;
          display: flex;
          align-items: center;
          gap: 16px;
          backdrop-filter: blur(10px);
          border: 1px solid var(--ui-border);
          transition: all 0.3s ease;
          animation: slideIn 0.4s ease-out;
        }

        @keyframes slideIn {
          from {
            opacity: 0;
            transform: translateX(-20px);
          }
          to {
            opacity: 1;
            transform: translateX(0);
          }
        }

        .test-card:hover {
          background: var(--ui-bg-hover);
          border-color: var(--ui-border-light);
        }
        
        .remove-btn {
          background: rgba(255, 107, 107, 0.2);
          border: none;
          border-radius: 8px;
          color: #ff6b6b;
          cursor: pointer;
          padding: 8px 12px;
          font-size: 13px;
          font-weight: 600;
          transition: all 0.3s ease;
          font-family: 'Nunito', sans-serif;
        }
        
        .remove-btn:hover {
          background: rgba(255, 107, 107, 0.4);
          transform: scale(1.05);
        }
        
        .color-picker {
          display: flex;
          gap: 8px;
          flex-wrap: wrap;
        }
        
        .color-swatch {
          width: 32px;
          height: 32px;
          border-radius: 8px;
          cursor: pointer;
          transition: all 0.2s ease;
          border: 3px solid transparent;
        }
        
        .color-swatch:hover {
          transform: scale(1.15);
        }
        
        .color-swatch.selected {
          border-color: var(--ui-text);
          box-shadow: 0 0 15px var(--ui-text-muted);
        }
        
        .legend-item {
          display: flex;
          align-items: center;
          gap: 12px;
          padding: 12px 18px;
          background: var(--ui-bg);
          border-radius: 12px;
          backdrop-filter: blur(10px);
          border: 1px solid var(--ui-border);
        }
        
        .score-marker {
          transition: all 0.2s ease;
          cursor: pointer;
        }
        
        .presentation-header {
          text-align: center;
          margin-bottom: 40px;
        }
        
        .chart-container {
          background: var(--ui-bg-alt);
          border-radius: 24px;
          padding: 40px;
          backdrop-filter: blur(20px);
          border: 1px solid var(--ui-border);
          box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
        }
        
        .info-panel {
          background: linear-gradient(135deg, rgba(102, 126, 234, 0.15) 0%, rgba(118, 75, 162, 0.15) 100%);
          border-radius: 16px;
          padding: 24px;
          border: 1px solid rgba(102, 126, 234, 0.3);
          margin-top: 20px;
        }
        
        .checkbox-card {
          display: flex;
          align-items: center;
          gap: 14px;
          padding: 16px 20px;
          background: var(--ui-bg-alt);
          border-radius: 12px;
          cursor: pointer;
          transition: all 0.2s ease;
          border: 2px solid transparent;
          user-select: none;
        }

        .checkbox-card:hover {
          background: var(--button-inactive-bg);
        }

        .checkbox-card.checked {
          border-color: currentColor;
          background: var(--ui-bg);
        }

        .custom-checkbox {
          width: 24px;
          height: 24px;
          border-radius: 6px;
          border: 2px solid var(--ui-text-muted);
          display: flex;
          align-items: center;
          justify-content: center;
          transition: all 0.2s ease;
          flex-shrink: 0;
        }
        
        .custom-checkbox.checked {
          border-color: currentColor;
          background: currentColor;
        }
        
        .checkmark {
          color: #1a1a2e;
          font-size: 14px;
          font-weight: 800;
        }
        
        .control-btn {
          padding: 10px 18px;
          border: none;
          border-radius: 8px;
          font-size: 13px;
          font-weight: 600;
          cursor: pointer;
          transition: all 0.2s ease;
          font-family: 'Nunito', sans-serif;
          background: var(--button-inactive-bg);
          color: var(--ui-text-secondary);
        }

        .control-btn:hover {
          background: var(--button-inactive-hover-bg);
          color: var(--ui-text);
        }
        
        .tooltip {
          pointer-events: none;
          transition: opacity 0.2s ease;
        }

        .print-preview {
          background: #ffffff !important;
          color: #1a1a2e !important;
        }

        .print-preview .no-print {
          display: none !important;
        }

        .print-preview .print-only {
          display: block !important;
        }

        .print-preview .chart-container {
          box-shadow: none !important;
          border: 1px solid #ddd !important;
          background: #ffffff !important;
        }

        .print-preview .presentation-header {
          border-bottom: 2px solid #667eea;
          padding-bottom: 20px;
          margin-bottom: 30px;
        }

        /* Print Styles for PDF Export */
        @media print {
          body {
            background: white !important;
          }

          .no-print {
            display: none !important;
          }

          .print-only {
            display: block !important;
          }

          .chart-container {
            box-shadow: none !important;
            border: 2px solid #333 !important;
            break-inside: avoid;
            page-break-inside: avoid;
            background: white !important;
          }

          .presentation-header {
            border-bottom: 2px solid #667eea;
            padding-bottom: 20px;
            margin-bottom: 30px;
            color: #1a1a2e !important;
          }

          .presentation-header h2 {
            color: #1a1a2e !important;
          }

          .chart-title {
            color: #1a1a2e !important;
          }

          /* Make all text dark for print */
          text, p, span, div {
            color: #1a1a2e !important;
          }

          /* Ensure curve is visible - uses custom color from state */
          svg path[d*="M"] {
            stroke-width: 3 !important;
          }

          /* Ensure test markers are visible */
          circle {
            stroke: #333 !important;
          }

          /* Legend items */
          .legend-item {
            color: #1a1a2e !important;
          }

          /* Info panel */
          .info-panel {
            background: #f8f9fa !important;
            border: 1px solid #ddd !important;
            color: #1a1a2e !important;
          }

          .info-panel h4, .info-panel p {
            color: #1a1a2e !important;
          }

          /* Summary section */
          .editable-summary {
            background: white !important;
            border: 1px solid #ddd !important;
            color: #1a1a2e !important;
          }

          /* Ensure colors are visible in print */
          * {
            -webkit-print-color-adjust: exact !important;
            print-color-adjust: exact !important;
            color-adjust: exact !important;
          }

          @page {
            margin: 0.75in;
            size: letter;
          }
        }

        .print-only {
          display: none;
        }

        .profile-card {
          background: var(--ui-bg);
          border-radius: 12px;
          padding: 16px;
          cursor: pointer;
          transition: all 0.2s ease;
          border: 1px solid var(--ui-border);
        }

        .profile-card:hover {
          background: var(--ui-bg-hover);
          border-color: var(--ui-border-light);
          transform: translateY(-2px);
        }

        .delete-profile-btn {
          background: rgba(255, 107, 107, 0.2);
          border: none;
          border-radius: 6px;
          color: #ff6b6b;
          cursor: pointer;
          padding: 6px 10px;
          font-size: 12px;
          font-weight: 600;
          transition: all 0.2s ease;
        }

        .delete-profile-btn:hover {
          background: rgba(255, 107, 107, 0.4);
        }

        .print-header {
          display: flex;
          justify-content: space-between;
          align-items: center;
          margin-bottom: 30px;
          padding-bottom: 20px;
          border-bottom: 3px solid #667eea;
        }

        .print-logo {
          max-width: 150px;
          max-height: 80px;
          object-fit: contain;
        }

        .print-footer {
          margin-top: 40px;
          padding-top: 20px;
          border-top: 2px solid #eee;
          text-align: center;
          font-size: 12px;
          color: #666;
        }

        /* Responsive adjustments */
        @media (max-width: 1024px) {
          .mode-btn {
            padding: 12px 24px;
            font-size: 13px;
          }
        }

        @media (max-width: 768px) {
          .mode-btn {
            padding: 10px 18px;
            font-size: 12px;
          }
        }

        @media (max-width: 640px) {
          .mode-btn {
            padding: 8px 14px;
            font-size: 11px;
          }
        }
      `}</style>

      {/* Header */}
      <div className="app-header" style={{
        padding: '24px 40px',
        borderBottom: `1px solid ${themeColors.cardBorder}`,
        display: 'flex',
        justifyContent: 'space-between',
        alignItems: 'center',
        background: themeColors.cardBgAlt,
        backdropFilter: 'blur(20px)',
        minHeight: '90px',
        gap: '20px',
        flexWrap: 'wrap',
      }}>
        <div style={{
          display: 'flex',
          flexDirection: 'column',
          justifyContent: 'center',
          minWidth: '280px',
          flex: '0 1 auto',
        }}>
          <h1 style={{
            fontFamily: "'Playfair Display', serif",
            fontSize: '28px',
            fontWeight: 700,
            margin: 0,
            lineHeight: 1.2,
            background: theme === 'light'
              ? 'linear-gradient(135deg, #1a1a2e 0%, #667eea 100%)'
              : 'linear-gradient(135deg, #f8f9fa 0%, #c8d6e5 100%)',
            WebkitBackgroundClip: 'text',
            WebkitTextFillColor: 'transparent',
            letterSpacing: '-0.5px',
            whiteSpace: 'nowrap',
            overflow: 'hidden',
            textOverflow: 'ellipsis',
            maxWidth: '100%',
          }}>
            Score Distribution Visualizer
          </h1>
          <p style={{
            margin: '6px 0 0 0',
            color: themeColors.textMuted,
            fontSize: '12px',
            fontWeight: 600,
            letterSpacing: '1.5px',
            textTransform: 'uppercase',
            lineHeight: 1.4,
          }}>
            Bell Curve Analysis Tool
          </p>
        </div>

        <div style={{
          display: 'flex',
          gap: '10px',
          alignItems: 'center',
          flexWrap: 'wrap',
          justifyContent: 'flex-end',
          flex: '1 1 auto',
        }}>
          <button
            className="mode-btn inactive no-print"
            onClick={() => setShowHelpPanel(true)}
            title="View the walkthrough guide"
          >
             Help
          </button>
          <button
            className="mode-btn inactive no-print"
            onClick={() => setShowBrandingPanel(true)}
            title="Configure school branding"
          >
             Branding
          </button>
          <button
            className="mode-btn inactive no-print"
            onClick={() => setShowThemePanel(true)}
            title="Customize theme and colors"
          >
             Theme
          </button>
          <button
            className="mode-btn inactive no-print"
            onClick={() => setShowProfilesPanel(true)}
            title="Manage student profiles"
          >
             Profiles
          </button>
          <button
            className="mode-btn inactive no-print"
            onClick={() => setShowLabelsPanel(true)}
            title="Customize label styles and positions"
          >
             Labels
          </button>
          <button
            className={`mode-btn ${mode === 'input' ? 'active' : 'inactive'} no-print`}
            onClick={() => setMode('input')}
          >
             Input Mode
          </button>
          <button
            className={`mode-btn ${mode === 'presentation' ? 'active' : 'inactive'} no-print`}
            onClick={() => setMode('presentation')}
          >
             Presentation
          </button>
          {mode === 'presentation' && tests.length > 0 && (
            <>
              <button
                className="mode-btn inactive no-print"
                onClick={() => setIsPrintPreview(!isPrintPreview)}
                title="Toggle print preview"
              >
                {isPrintPreview ? ' Exit Preview' : ' Print Preview'}
              </button>
              <button
                className="mode-btn inactive no-print"
                onClick={handleDownloadPdf}
                title="Download or save as PDF"
              >
                 Download PDF
              </button>
            </>
          )}
        </div>
      </div>

      {/* Branding Configuration Panel */}
      {showBrandingPanel && (
        <div style={{
          position: 'fixed',
          top: 0,
          left: 0,
          right: 0,
          bottom: 0,
          background: 'rgba(0, 0, 0, 0.8)',
          backdropFilter: 'blur(10px)',
          display: 'flex',
          alignItems: 'center',
          justifyContent: 'center',
          zIndex: 1000,
          padding: '20px',
        }} className="no-print">
          <div style={{
            background: themeColors.panelBg,
            borderRadius: '24px',
            padding: '40px',
            maxWidth: '600px',
            width: '100%',
            border: `1px solid ${themeColors.cardBorder}`,
            maxHeight: '80vh',
            overflowY: 'auto',
          }}>
            <h2 style={{
              margin: '0 0 30px 0',
              fontSize: '28px',
              fontWeight: 700,
              color: themeColors.heading,
            }}>
               Custom Branding
            </h2>

            <div style={{ display: 'flex', flexDirection: 'column', gap: '24px' }}>
              <div>
                <label style={{
                  display: 'block',
                  marginBottom: '8px',
                  fontSize: '14px',
                  fontWeight: 600,
                  color: themeColors.textSecondary,
                }}>
                  School Name
                </label>
                <input
                  type="text"
                  value={branding.schoolName}
                  onChange={(e) => setBranding({ ...branding, schoolName: e.target.value })}
                  className="input-field"
                  placeholder="Enter school name"
                  style={{ width: '100%' }}
                />
              </div>

              <div>
                <label style={{
                  display: 'block',
                  marginBottom: '8px',
                  fontSize: '14px',
                  fontWeight: 600,
                  color: themeColors.textSecondary,
                }}>
                  School Logo
                </label>
                <input
                  type="file"
                  accept="image/*"
                  onChange={handleLogoUpload}
                  className="input-field"
                  style={{ width: '100%' }}
                />
                {branding.schoolLogo && (
                  <div style={{ marginTop: '12px', textAlign: 'center' }}>
                    <img
                      src={branding.schoolLogo}
                      alt="School Logo Preview"
                      style={{
                        maxWidth: '200px',
                        maxHeight: '100px',
                        objectFit: 'contain',
                        border: `2px solid ${themeColors.inputBorder}`,
                        borderRadius: '8px',
                        padding: '10px',
                        background: themeColors.inputBg,
                      }}
                    />
                  </div>
                )}
              </div>

              <div>
                <label style={{
                  display: 'block',
                  marginBottom: '8px',
                  fontSize: '14px',
                  fontWeight: 600,
                  color: themeColors.textSecondary,
                }}>
                  Primary Color
                </label>
                <input
                  type="color"
                  value={branding.primaryColor}
                  onChange={(e) => setBranding({ ...branding, primaryColor: e.target.value })}
                  style={{
                    width: '100%',
                    height: '50px',
                    border: `2px solid ${themeColors.inputBorder}`,
                    borderRadius: '12px',
                    cursor: 'pointer',
                    background: themeColors.inputBg,
                  }}
                />
              </div>

              <div>
                <label style={{
                  display: 'block',
                  marginBottom: '8px',
                  fontSize: '14px',
                  fontWeight: 600,
                  color: themeColors.textSecondary,
                }}>
                  Report Footer Text
                </label>
                <textarea
                  value={branding.footerText}
                  onChange={(e) => setBranding({ ...branding, footerText: e.target.value })}
                  className="input-field"
                  placeholder="Optional footer text for printed reports"
                  style={{ width: '100%', minHeight: '80px', resize: 'vertical' }}
                />
              </div>
            </div>

            <div style={{ display: 'flex', gap: '12px', marginTop: '30px' }}>
              <button
                className="add-btn"
                onClick={() => setShowBrandingPanel(false)}
                style={{ flex: 1 }}
              >
                Save & Close
              </button>
              <button
                className="control-btn"
                onClick={() => setShowBrandingPanel(false)}
                style={{ padding: '14px 28px' }}
              >
                Cancel
              </button>
            </div>
          </div>
        </div>
      )}

      {/* Labels Customization Panel */}
      {showLabelsPanel && (
        <div style={{
          position: 'fixed',
          top: 0,
          left: 0,
          right: 0,
          bottom: 0,
          background: 'rgba(0, 0, 0, 0.8)',
          backdropFilter: 'blur(10px)',
          display: 'flex',
          alignItems: 'center',
          justifyContent: 'center',
          zIndex: 1000,
          padding: '20px',
        }} className="no-print">
          <div style={{
            background: themeColors.panelBg,
            borderRadius: '24px',
            padding: '40px',
            maxWidth: '600px',
            width: '100%',
            border: `1px solid ${themeColors.cardBorder}`,
            maxHeight: '80vh',
            overflowY: 'auto',
          }}>
            <h2 style={{
              margin: '0 0 30px 0',
              fontSize: '28px',
              fontWeight: 700,
              color: themeColors.heading,
            }}>
               Label Customization
            </h2>

            <div style={{ display: 'flex', flexDirection: 'column', gap: '24px' }}>
              {/* Border Radius */}
              <div>
                <label style={{
                  display: 'block',
                  marginBottom: '8px',
                  fontSize: '14px',
                  fontWeight: 600,
                  color: themeColors.textSecondary,
                }}>
                  Border Radius: {labelStyles.borderRadius}px
                </label>
                <input
                  type="range"
                  min="0"
                  max="16"
                  step="1"
                  value={labelStyles.borderRadius}
                  onChange={(e) => setLabelStyles({ ...labelStyles, borderRadius: parseInt(e.target.value) })}
                  style={{
                    width: '100%',
                    height: '8px',
                    borderRadius: '4px',
                    background: themeColors.inputBg,
                    cursor: 'pointer',
                  }}
                />
              </div>

              {/* Padding */}
              <div>
                <label style={{
                  display: 'block',
                  marginBottom: '8px',
                  fontSize: '14px',
                  fontWeight: 600,
                  color: themeColors.textSecondary,
                }}>
                  Padding: {labelStyles.padding}px
                </label>
                <input
                  type="range"
                  min="4"
                  max="16"
                  step="1"
                  value={labelStyles.padding}
                  onChange={(e) => setLabelStyles({ ...labelStyles, padding: parseInt(e.target.value) })}
                  style={{
                    width: '100%',
                    height: '8px',
                    borderRadius: '4px',
                    background: themeColors.inputBg,
                    cursor: 'pointer',
                  }}
                />
              </div>

              {/* Max Width */}
              <div>
                <label style={{
                  display: 'block',
                  marginBottom: '8px',
                  fontSize: '14px',
                  fontWeight: 600,
                  color: themeColors.textSecondary,
                }}>
                  Max Width: {labelStyles.maxWidth}px
                </label>
                <input
                  type="range"
                  min="100"
                  max="400"
                  step="10"
                  value={labelStyles.maxWidth}
                  onChange={(e) => setLabelStyles({ ...labelStyles, maxWidth: parseInt(e.target.value) })}
                  style={{
                    width: '100%',
                    height: '8px',
                    borderRadius: '4px',
                    background: themeColors.inputBg,
                    cursor: 'pointer',
                  }}
                />
              </div>

              {/* Font Size */}
              <div>
                <label style={{
                  display: 'block',
                  marginBottom: '8px',
                  fontSize: '14px',
                  fontWeight: 600,
                  color: themeColors.textSecondary,
                }}>
                  Font Size: {labelStyles.fontSize}px
                </label>
                <input
                  type="range"
                  min="8"
                  max="14"
                  step="1"
                  value={labelStyles.fontSize}
                  onChange={(e) => setLabelStyles({ ...labelStyles, fontSize: parseInt(e.target.value) })}
                  style={{
                    width: '100%',
                    height: '8px',
                    borderRadius: '4px',
                    background: themeColors.inputBg,
                    cursor: 'pointer',
                  }}
                />
              </div>

              {/* Reset Positions Button */}
              <div style={{
                padding: '20px',
                background: themeColors.cardBgAlt,
                borderRadius: '12px',
                border: `1px solid ${themeColors.cardBorder}`,
              }}>
                <label style={{
                  display: 'block',
                  marginBottom: '12px',
                  fontSize: '14px',
                  fontWeight: 600,
                  color: themeColors.textSecondary,
                }}>
                  Label Positions
                </label>
                <p style={{
                  margin: '0 0 12px 0',
                  fontSize: '12px',
                  color: themeColors.textMuted,
                  lineHeight: 1.5,
                }}>
                  Drag labels on the chart to reposition them. Click the button below to reset all labels to their default positions.
                </p>
                <button
                  className="control-btn"
                  onClick={() => setLabelPositions({})}
                  style={{ width: '100%' }}
                >
                  Reset Label Positions
                </button>
              </div>
            </div>

            <div style={{ display: 'flex', gap: '12px', marginTop: '30px' }}>
              <button
                className="add-btn"
                onClick={() => setShowLabelsPanel(false)}
                style={{ flex: 1 }}
              >
                Save & Close
              </button>
              <button
                className="control-btn"
                onClick={() => setShowLabelsPanel(false)}
                style={{ padding: '14px 28px' }}
              >
                Cancel
              </button>
            </div>
          </div>
        </div>
      )}

      {/* Theme Customization Panel */}
      {showThemePanel && (
        <div style={{
          position: 'fixed',
          top: 0,
          left: 0,
          right: 0,
          bottom: 0,
          background: 'rgba(0, 0, 0, 0.8)',
          backdropFilter: 'blur(10px)',
          display: 'flex',
          alignItems: 'center',
          justifyContent: 'center',
          zIndex: 1000,
          padding: '20px',
        }} className="no-print">
          <div style={{
            background: themeColors.panelBg,
            borderRadius: '24px',
            padding: '40px',
            maxWidth: '600px',
            width: '100%',
            border: `1px solid ${themeColors.cardBorder}`,
            maxHeight: '80vh',
            overflowY: 'auto',
          }}>
            <h2 style={{
              margin: '0 0 30px 0',
              fontSize: '28px',
              fontWeight: 700,
              color: themeColors.text,
            }}>
               Theme Customization
            </h2>

            <div style={{ display: 'flex', flexDirection: 'column', gap: '32px' }}>
              {/* Theme Mode Selection */}
              <div>
                <label style={{
                  display: 'block',
                  marginBottom: '16px',
                  fontSize: '14px',
                  fontWeight: 600,
                  color: themeColors.textSecondary,
                  textTransform: 'uppercase',
                  letterSpacing: '1px',
                }}>
                  Display Mode
                </label>
                <div style={{ display: 'flex', gap: '12px' }}>
                  <button
                    className={theme === 'dark' ? 'add-btn' : 'control-btn'}
                    onClick={() => setTheme('dark')}
                    style={{ flex: 1, padding: '16px' }}
                  >
                     Dark Mode
                  </button>
                  <button
                    className={theme === 'light' ? 'add-btn' : 'control-btn'}
                    onClick={() => setTheme('light')}
                    style={{ flex: 1, padding: '16px' }}
                  >
                     Light Mode
                  </button>
                </div>
                <p style={{
                  marginTop: '12px',
                  fontSize: '13px',
                  color: themeColors.textMuted,
                  lineHeight: '1.6',
                }}>
                  Choose between dark and light interface themes
                </p>
              </div>

              {/* Bell Curve Color Selection */}
              <div>
                <label style={{
                  display: 'block',
                  marginBottom: '16px',
                  fontSize: '14px',
                  fontWeight: 600,
                  color: themeColors.textSecondary,
                  textTransform: 'uppercase',
                  letterSpacing: '1px',
                }}>
                  Bell Curve Color
                </label>
                <div style={{ display: 'grid', gridTemplateColumns: 'repeat(5, 1fr)', gap: '12px' }}>
                  {['#667eea', '#4ECDC4', '#FF6B6B', '#9B7EDE', '#00B894', '#E17055', '#FFE66D', '#FD79A8', '#74B9FF', '#764ba2'].map((color) => (
                    <div
                      key={color}
                      style={{
                        width: '100%',
                        aspectRatio: '1',
                        borderRadius: '12px',
                        backgroundColor: color,
                        cursor: 'pointer',
                        border: bellCurveColor === color ? '4px solid ' + themeColors.text : '2px solid ' + themeColors.cardBorder,
                        transition: 'all 0.2s ease',
                        boxShadow: bellCurveColor === color ? `0 4px 12px ${color}66` : 'none',
                      }}
                      onClick={() => setBellCurveColor(color)}
                      title={color}
                    />
                  ))}
                </div>
                <p style={{
                  marginTop: '12px',
                  fontSize: '13px',
                  color: themeColors.textMuted,
                  lineHeight: '1.6',
                }}>
                  Customize the color of the bell curve visualization
                </p>
              </div>

              {/* Preview */}
              <div style={{
                background: themeColors.cardBg,
                border: `1px solid ${themeColors.cardBorder}`,
                borderRadius: '16px',
                padding: '20px',
              }}>
                <p style={{
                  margin: '0 0 12px 0',
                  fontSize: '13px',
                  fontWeight: 600,
                  color: themeColors.textSecondary,
                  textTransform: 'uppercase',
                  letterSpacing: '1px',
                }}>
                  Preview
                </p>
                <div style={{
                  background: theme === 'light' ? '#ffffff' : '#1a1a2e',
                  borderRadius: '12px',
                  padding: '16px',
                  display: 'flex',
                  alignItems: 'center',
                  justifyContent: 'center',
                }}>
                  <div style={{
                    width: '60px',
                    height: '60px',
                    borderRadius: '50%',
                    background: `linear-gradient(135deg, ${bellCurveColor} 0%, ${bellCurveColor}99 100%)`,
                    boxShadow: `0 4px 20px ${bellCurveColor}40`,
                  }} />
                </div>
              </div>
            </div>

            <div style={{ display: 'flex', gap: '12px', marginTop: '30px' }}>
              <button
                className="add-btn"
                onClick={() => setShowThemePanel(false)}
                style={{ flex: 1 }}
              >
                Save & Close
              </button>
              <button
                className="control-btn"
                onClick={() => setShowThemePanel(false)}
                style={{ padding: '14px 28px' }}
              >
                Cancel
              </button>
            </div>
          </div>
        </div>
      )}

      {/* Profiles Management Panel */}
      {showProfilesPanel && (
        <div style={{
          position: 'fixed',
          top: 0,
          left: 0,
          right: 0,
          bottom: 0,
          background: 'rgba(0, 0, 0, 0.8)',
          backdropFilter: 'blur(10px)',
          display: 'flex',
          alignItems: 'center',
          justifyContent: 'center',
          zIndex: 1000,
          padding: '20px',
        }} className="no-print">
          <div style={{
            background: themeColors.panelBg,
            borderRadius: '24px',
            padding: '40px',
            maxWidth: '700px',
            width: '100%',
            border: `1px solid ${themeColors.cardBorder}`,
            maxHeight: '80vh',
            overflowY: 'auto',
          }}>
            <h2 style={{
              margin: '0 0 30px 0',
              fontSize: '28px',
              fontWeight: 700,
              color: themeColors.heading,
            }}>
               Student Profiles
            </h2>

            <div style={{ marginBottom: '24px' }}>
              <button
                className="add-btn"
                onClick={startNewProfile}
                style={{ width: '100%' }}
              >
                 Start New Profile
              </button>
            </div>

            <div style={{ display: 'flex', gap: '12px', marginBottom: '24px' }}>
              <button
                className="control-btn"
                onClick={handleExportProfiles}
                style={{ flex: 1, padding: '14px 18px' }}
              >
                 Export Profiles
              </button>
              <button
                className="control-btn"
                onClick={() => importInputRef.current?.click()}
                style={{ flex: 1, padding: '14px 18px' }}
              >
                 Import Profiles
              </button>
              <input
                ref={importInputRef}
                type="file"
                accept="application/json"
                onChange={handleImportProfiles}
                style={{ display: 'none' }}
              />
            </div>

            {savedProfiles.length === 0 ? (
              <div style={{
                textAlign: 'center',
                padding: '60px 20px',
                color: themeColors.textMuted,
              }}>
                <div style={{ fontSize: '48px', marginBottom: '16px' }}></div>
                <p style={{ margin: 0, fontSize: '16px' }}>
                  No saved profiles yet. Save your first student profile!
                </p>
              </div>
            ) : (
              <div style={{ display: 'flex', flexDirection: 'column', gap: '12px' }}>
                {savedProfiles.map((profile) => (
                  <div key={profile.id} className="profile-card">
                    <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'start' }}>
                      <div style={{ flex: 1 }} onClick={() => loadProfile(profile)}>
                        <div style={{ fontWeight: 700, fontSize: '18px', marginBottom: '8px', color: themeColors.text }}>
                          {profile.studentName}
                        </div>
                        <div style={{ fontSize: '13px', color: themeColors.textSecondary, marginBottom: '4px' }}>
                          Assessment: {profile.assessmentDate ? new Date(profile.assessmentDate).toLocaleDateString() : 'No date'}
                        </div>
                        <div style={{ fontSize: '13px', color: themeColors.textSecondary, marginBottom: '4px' }}>
                          Tests: {profile.tests.length}
                        </div>
                        <div style={{ fontSize: '12px', color: themeColors.textMuted }}>
                          Saved: {new Date(profile.savedAt).toLocaleDateString()} {new Date(profile.savedAt).toLocaleTimeString()}
                        </div>
                        {currentProfileId === profile.id && (
                          <div style={{
                            display: 'inline-block',
                            marginTop: '8px',
                            padding: '4px 10px',
                            background: 'rgba(0, 184, 148, 0.2)',
                            color: '#00b894',
                            borderRadius: '6px',
                            fontSize: '11px',
                            fontWeight: 700,
                            textTransform: 'uppercase',
                            letterSpacing: '0.5px',
                          }}>
                            Currently Loaded
                          </div>
                        )}
                      </div>
                      <button
                        className="delete-profile-btn"
                        onClick={(e) => {
                          e.stopPropagation();
                          deleteProfile(profile.id);
                        }}
                      >
                        Delete
                      </button>
                    </div>
                  </div>
                ))}
              </div>
            )}

            <div style={{ display: 'flex', gap: '12px', marginTop: '30px' }}>
              <button
                className="control-btn"
                onClick={() => setShowProfilesPanel(false)}
                style={{ flex: 1, padding: '14px 28px' }}
              >
                Close
              </button>
            </div>
          </div>
        </div>
      )}

      {/* Help & Walkthrough Panel */}
      {showHelpPanel && (
        <div style={{
          position: 'fixed',
          top: 0,
          left: 0,
          right: 0,
          bottom: 0,
          background: 'rgba(0, 0, 0, 0.8)',
          backdropFilter: 'blur(10px)',
          display: 'flex',
          alignItems: 'center',
          justifyContent: 'center',
          zIndex: 1000,
          padding: '20px',
        }} className="no-print">
          <div style={{
            background: themeColors.panelBg,
            borderRadius: '24px',
            padding: '40px',
            maxWidth: '700px',
            width: '100%',
            border: `1px solid ${themeColors.cardBorder}`,
            maxHeight: '80vh',
            overflowY: 'auto',
          }}>
            <h2 style={{
              margin: '0 0 30px 0',
              fontSize: '28px',
              fontWeight: 700,
              color: themeColors.heading,
            }}>
               Quick Walkthrough
            </h2>

            <div style={{ display: 'flex', flexDirection: 'column', gap: '18px' }}>
              {HELP_STEPS.map((step, index) => (
                <div key={step.title} style={{
                  background: themeColors.cardBg,
                  borderRadius: '16px',
                  padding: '18px 20px',
                  border: `1px solid ${themeColors.cardBorder}`,
                }}>
                  <div style={{
                    fontSize: '14px',
                    fontWeight: 700,
                    color: themeColors.heading,
                    marginBottom: '8px',
                    textTransform: 'uppercase',
                    letterSpacing: '1px',
                  }}>
                    {index + 1}. {step.title}
                  </div>
                  <div style={{ fontSize: '15px', color: themeColors.text }}>
                    {step.body}
                  </div>
                </div>
              ))}
            </div>

            <div style={{ display: 'flex', gap: '12px', marginTop: '30px' }}>
              <button
                className="add-btn"
                onClick={() => setShowHelpPanel(false)}
                style={{ flex: 1 }}
              >
                Got it
              </button>
              <button
                className="control-btn"
                onClick={() => setShowHelpPanel(false)}
                style={{ padding: '14px 28px' }}
              >
                Close
              </button>
            </div>
          </div>
        </div>
      )}

      <div style={{ padding: '40px', maxWidth: '1400px', margin: '0 auto' }}>
        {mode === 'input' ? (
          /* INPUT MODE */
          <div style={{ display: 'grid', gridTemplateColumns: '1fr 1fr', gap: '40px' }}>
            {/* Left Panel - Form */}
            <div>
              {/* Student Info */}
              <div style={{
                background: themeColors.cardBg,
                borderRadius: '20px',
                padding: '28px',
                marginBottom: '28px',
                border: `1px solid ${themeColors.cardBorder}`,
              }}>
                <h3 style={{
                  margin: '0 0 20px 0',
                  fontSize: '18px',
                  fontWeight: 700,
                  color: themeColors.text,
                  letterSpacing: '1px',
                  textTransform: 'uppercase',
                }}>
                   Student Information
                </h3>
                <div style={{ display: 'flex', gap: '16px', marginBottom: '16px' }}>
                  <input
                    type="text"
                    placeholder="Student Name"
                    value={studentName}
                    onChange={(e) => setStudentName(e.target.value)}
                    className="input-field"
                    style={{ flex: 1, background: themeColors.inputBg, color: themeColors.text, border: `2px solid ${themeColors.inputBorder}` }}
                  />
                  <input
                    type="date"
                    value={assessmentDate}
                    onChange={(e) => setAssessmentDate(e.target.value)}
                    className="input-field"
                    style={{ width: '180px', background: themeColors.inputBg, color: themeColors.text, border: `2px solid ${themeColors.inputBorder}` }}
                  />
                </div>
                <button
                  className="add-btn"
                  onClick={saveCurrentProfile}
                  disabled={!studentName}
                  style={{ width: '100%' }}
                  title="Save this student's profile and assessments"
                >
                   Save Profile
                </button>
                {currentProfileId && (
                  <div style={{
                    marginTop: '12px',
                    padding: '8px 12px',
                    background: 'rgba(0, 184, 148, 0.15)',
                    borderRadius: '8px',
                    fontSize: '13px',
                    color: '#00b894',
                    textAlign: 'center',
                    fontWeight: 600,
                  }}>
                     Profile saved
                  </div>
                )}
              </div>

              {/* Add Test */}
              <div style={{
                background: themeColors.cardBg,
                borderRadius: '20px',
                padding: '28px',
                marginBottom: '28px',
                border: `1px solid ${themeColors.cardBorder}`,
              }}>
                <h3 style={{
                  margin: '0 0 20px 0',
                  fontSize: '18px',
                  fontWeight: 700,
                  color: themeColors.text,
                  letterSpacing: '1px',
                  textTransform: 'uppercase',
                }}>
                   Add Test Score
                </h3>

                <div style={{ display: 'flex', gap: '16px', marginBottom: '20px' }}>
                  <div style={{ flex: 2, position: 'relative' }} ref={autocompleteRef}>
                    <input
                      type="text"
                      placeholder="Test/Section Name"
                      value={newTest.name}
                      onChange={handleTestNameChange}
                      className="input-field"
                      style={{ width: '100%', background: themeColors.inputBg, color: themeColors.text, border: `2px solid ${themeColors.inputBorder}` }}
                    />
                    {showAutocomplete && autocompleteSuggestions.length > 0 && (
                      <div style={{
                        position: 'absolute',
                        top: '100%',
                        left: 0,
                        right: 0,
                        background: theme === 'light' ? '#ffffff' : '#1a1a2e',
                        border: `1px solid ${themeColors.cardBorder}`,
                        borderRadius: '12px',
                        marginTop: '4px',
                        maxHeight: '300px',
                        overflowY: 'auto',
                        zIndex: 1000,
                        boxShadow: '0 8px 24px rgba(0, 0, 0, 0.3)',
                      }}>
                        {autocompleteSuggestions.map((suggestion, index) => {
                          const isParentTest = typeof suggestion === 'object' && suggestion.subtests;
                          const displayName = typeof suggestion === 'string' ? suggestion : suggestion.name;
                          const subtestCount = isParentTest ? suggestion.subtests.length : 0;

                          return (
                            <div
                              key={index}
                              onClick={() => handleSuggestionClick(suggestion)}
                              style={{
                                padding: '12px 16px',
                                cursor: 'pointer',
                                borderBottom: index < autocompleteSuggestions.length - 1 ? `1px solid ${themeColors.cardBorder}` : 'none',
                                transition: 'all 0.2s ease',
                              }}
                              onMouseEnter={(e) => {
                                e.currentTarget.style.background = theme === 'light' ? 'rgba(102, 126, 234, 0.1)' : 'rgba(102, 126, 234, 0.2)';
                              }}
                              onMouseLeave={(e) => {
                                e.currentTarget.style.background = 'transparent';
                              }}
                            >
                              <div style={{
                                fontSize: '14px',
                                color: isParentTest ? '#4ECDC4' : themeColors.text,
                                fontWeight: isParentTest ? 600 : 400,
                              }}>
                                {isParentTest && ' '}{displayName}
                              </div>
                              {isParentTest && (
                                <div style={{
                                  fontSize: '11px',
                                  color: theme === 'light' ? 'rgba(78, 205, 196, 0.8)' : 'rgba(78, 205, 196, 0.7)',
                                  marginTop: '4px',
                                  fontStyle: 'italic',
                                }}>
                                   Auto-adds {subtestCount} subtest{subtestCount !== 1 ? 's' : ''}
                                </div>
                              )}
                            </div>
                          );
                        })}
                      </div>
                    )}
                  </div>
                  <input
                    type="number"
                    placeholder="Score (40-160)"
                    value={newTest.score}
                    onChange={(e) => setNewTest({ ...newTest, score: e.target.value })}
                    className="input-field"
                    style={{ flex: 1, background: themeColors.inputBg, color: themeColors.text, border: `2px solid ${themeColors.inputBorder}` }}
                    min="40"
                    max="160"
                  />
                </div>

                <div style={{ marginBottom: '20px' }}>
                  <label style={{
                    display: 'block',
                    marginBottom: '12px',
                    fontSize: '13px',
                    fontWeight: 600,
                    color: themeColors.textSecondary,
                    textTransform: 'uppercase',
                    letterSpacing: '1px',
                  }}>
                    Select Color
                  </label>
                  <div className="color-picker">
                    {PRESET_COLORS.map((color) => (
                      <div
                        key={color.value}
                        className={`color-swatch ${newTest.color === color.value ? 'selected' : ''}`}
                        style={{ backgroundColor: color.value }}
                        onClick={() => setNewTest({ ...newTest, color: color.value })}
                        title={color.name}
                      />
                    ))}
                    <input
                      type="color"
                      value={newTest.color}
                      onChange={(e) => setNewTest({ ...newTest, color: e.target.value })}
                      title="Custom color"
                      style={{
                        width: '32px',
                        height: '32px',
                        borderRadius: '8px',
                        border: `3px solid ${themeColors.inputBorder}`,
                        cursor: 'pointer',
                        background: 'transparent',
                      }}
                    />
                  </div>
                </div>

                <button
                  className="add-btn"
                  onClick={addTest}
                  disabled={!newTest.name || !newTest.score}
                  style={{ width: '100%' }}
                >
                  Add to Chart
                </button>
              </div>

              {/* Test List */}
              <div style={{
                background: themeColors.cardBg,
                borderRadius: '20px',
                padding: '28px',
                border: `1px solid ${themeColors.cardBorder}`,
              }}>
                <h3 style={{
                  margin: '0 0 20px 0',
                  fontSize: '18px',
                  fontWeight: 700,
                  color: themeColors.text,
                  letterSpacing: '1px',
                  textTransform: 'uppercase',
                }}>
                   Added Tests ({tests.length})
                </h3>

                {tests.length === 0 ? (
                  <div style={{
                    textAlign: 'center',
                    padding: '40px',
                    color: themeColors.textMuted,
                    fontSize: '15px',
                  }}>
                    No tests added yet. Add your first test above!
                  </div>
                ) : (
                  <div style={{ display: 'flex', flexDirection: 'column', gap: '12px' }}>
                    {tests.map((test) => {
                      const isEditing = editingTestId === test.id;

                      return (
                        <div key={test.id} className="test-card" style={{ background: themeColors.cardBg, border: `1px solid ${themeColors.cardBorder}` }}>
                          {isEditing ? (
                            <>
                              <div style={{ flex: 1, display: 'flex', flexDirection: 'column', gap: '12px' }}>
                                <input
                                  type="text"
                                  value={editingTest.name}
                                  onChange={(e) => setEditingTest({ ...editingTest, name: e.target.value })}
                                  className="input-field"
                                  placeholder="Test name"
                                  style={{ fontSize: '14px', background: themeColors.inputBg, color: themeColors.text, border: `2px solid ${themeColors.inputBorder}` }}
                                />
                                <div style={{ display: 'flex', gap: '12px', alignItems: 'center' }}>
                                  <input
                                    type="number"
                                    value={editingTest.score}
                                    onChange={(e) => setEditingTest({ ...editingTest, score: e.target.value })}
                                    className="input-field"
                                    placeholder="Score"
                                    min="40"
                                    max="160"
                                    style={{ flex: 1, fontSize: '14px', background: themeColors.inputBg, color: themeColors.text, border: `2px solid ${themeColors.inputBorder}` }}
                                  />
                                  <div style={{ display: 'flex', gap: '8px', flexWrap: 'wrap' }}>
                                    {PRESET_COLORS.map((color) => (
                                      <div
                                        key={color.value}
                                        style={{
                                          width: '28px',
                                          height: '28px',
                                          borderRadius: '50%',
                                          backgroundColor: color.value,
                                          cursor: 'pointer',
                                          border: editingTest.color === color.value ? `3px solid ${themeColors.text}` : `2px solid ${themeColors.inputBorder}`,
                                          transition: 'all 0.2s ease',
                                        }}
                                        onClick={() => setEditingTest({ ...editingTest, color: color.value })}
                                        title={color.name}
                                      />
                                    ))}
                                  </div>
                                </div>
                              </div>
                              <div style={{ display: 'flex', gap: '8px', flexDirection: 'column' }}>
                                <button
                                  className="control-btn"
                                  onClick={saveEditedTest}
                                  style={{ padding: '8px 16px', fontSize: '13px', background: 'rgba(0, 184, 148, 0.2)', color: '#00b894' }}
                                >
                                   Save
                                </button>
                                <button
                                  className="control-btn"
                                  onClick={cancelEditingTest}
                                  style={{ padding: '8px 16px', fontSize: '13px', background: 'rgba(255, 107, 107, 0.2)', color: '#ff6b6b' }}
                                >
                                   Cancel
                                </button>
                              </div>
                            </>
                          ) : (
                            <>
                              <div
                                style={{
                                  width: '14px',
                                  height: '40px',
                                  borderRadius: '7px',
                                  backgroundColor: test.color,
                                  flexShrink: 0,
                                }}
                              />
                              <div style={{ flex: 1 }}>
                                <div style={{ fontWeight: 700, fontSize: '15px', marginBottom: '4px', color: themeColors.text }}>
                                  {test.name}
                                </div>
                                <div style={{
                                  fontSize: '13px',
                                  color: themeColors.textMuted,
                                }}>
                                  Score: {test.score} ({formatPercentile(getPercentileRank(test.score))} %ile)  {getScoreDescription(test.score)}
                                </div>
                              </div>
                              <div style={{ display: 'flex', gap: '8px' }}>
                                <button
                                  className="control-btn"
                                  onClick={() => startEditingTest(test)}
                                  style={{ padding: '8px 16px', fontSize: '13px' }}
                                >
                                   Edit
                                </button>
                                <button
                                  className="remove-btn"
                                  onClick={() => removeTest(test.id)}
                                >
                                  Remove
                                </button>
                              </div>
                            </>
                          )}
                        </div>
                      );
                    })}
                  </div>
                )}
              </div>
            </div>

            {/* Right Panel - Preview */}
            <div>
              <div className="chart-container">
                <h3 style={{
                  margin: '0 0 24px 0',
                  fontSize: '18px',
                  fontWeight: 700,
                  color: themeColors.heading,
                  letterSpacing: '1px',
                  textTransform: 'uppercase',
                }}>
                   Live Preview
                </h3>
                
                <svg viewBox="0 0 800 420" style={{ width: '100%', height: 'auto', overflow: 'visible' }}>
                  {/* Grid lines */}
                  {[55, 70, 85, 100, 115, 130, 145].map((score) => (
                    <line
                      key={score}
                      x1={getScoreX(score)}
                      y1={chartTopPadding}
                      x2={getScoreX(score)}
                      y2={chartBottomY}
                      stroke={theme === 'dark' ? 'rgba(255, 255, 255, 0.1)' : 'rgba(0, 0, 0, 0.1)'}
                      strokeDasharray="4,4"
                    />
                  ))}

                  {/* Average range highlight (85-115) */}
                  <path
                    d={averageAreaPath}
                    fill={theme === 'dark' ? 'rgba(0, 0, 0, 0.25)' : 'rgba(0, 0, 0, 0.05)'}
                  />

                  {/* Bell curve */}
                  <path
                    d={bellPath}
                    fill={`${bellCurveColor}26`}
                    stroke="url(#curveGradient)"
                    strokeWidth="3"
                  />

                  {/* Gradient definition */}
                  <defs>
                    <linearGradient id="curveGradient" x1="0%" y1="0%" x2="100%" y2="0%">
                      <stop offset="0%" stopColor={bellCurveColor} />
                      <stop offset="50%" stopColor={bellCurveColor} stopOpacity="0.7" />
                      <stop offset="100%" stopColor={bellCurveColor} />
                    </linearGradient>
                  </defs>

                  {/* Score labels */}
                  {SCORE_LABELS.map(({ score, label }) => (
                    <g key={score}>
                      <text
                        x={getScoreX(score)}
                        y="370"
                        textAnchor="middle"
                        fill={themeColors.chartText}
                        fontSize="12"
                        fontWeight="600"
                        fontFamily="Nunito, sans-serif"
                      >
                        {score}
                      </text>
                      <text
                        x={getScoreX(score)}
                        y="390"
                        textAnchor="middle"
                        fill={themeColors.textMuted}
                        fontSize="9"
                        fontFamily="Nunito, sans-serif"
                      >
                        {label}
                      </text>
                    </g>
                  ))}

                  {/* Average range label */}
                  <text
                    x={getScoreX(100)}
                    y="410"
                    textAnchor="middle"
                    fill={themeColors.textMuted}
                    fontSize="10"
                    fontFamily="Nunito, sans-serif"
                    fontWeight="600"
                  >
                     Average Range (85-115) 
                  </text>

                  {/* Score markers with stacking */}
                  {getStackedPositions(tests).map(({ test, x, y, baseY }) => (
                    <g key={test.id} className="score-marker">
                      {/* Vertical line to base of curve */}
                      <line
                        x1={x}
                        y1={baseY}
                        x2={x}
                        y2={chartBottomY}
                        stroke={test.color}
                        strokeWidth="2"
                        strokeDasharray="4,4"
                        opacity="0.6"
                      />
                      {/* Connector line if stacked */}
                      {y < baseY && (
                        <line
                          x1={x}
                          y1={y + 12}
                          x2={x}
                          y2={baseY}
                          stroke={test.color}
                          strokeWidth="2"
                          opacity="0.4"
                        />
                      )}
                      {/* Marker dot */}
                      <circle
                        cx={x}
                        cy={y}
                        r="12"
                        fill={test.color}
                        stroke="white"
                        strokeWidth="3"
                      />
                      {/* Score label on marker */}
                      <text
                        x={x}
                        y={y + 4}
                        textAnchor="middle"
                        fill={getContrastTextColor(test.color)}
                        fontSize="9"
                        fontWeight="700"
                        fontFamily="Nunito, sans-serif"
                      >
                        {test.score}
                      </text>
                    </g>
                  ))}
                </svg>

                {/* Legend */}
                {tests.length > 0 && (
                  <div style={{
                    display: 'flex',
                    flexWrap: 'wrap',
                    gap: '10px',
                    marginTop: '24px',
                  }}>
                    {tests.map((test) => (
                      <div key={test.id} className="legend-item">
                        <div
                          style={{
                            width: '16px',
                            height: '16px',
                            borderRadius: '50%',
                            backgroundColor: test.color,
                          }}
                        />
                        <span style={{ fontSize: '13px', fontWeight: 600 }}>
                          {test.name}: {test.score}
                        </span>
                      </div>
                    ))}
                  </div>
                )}
              </div>

              {/* Info Panel */}
              <div className="info-panel" style={{ background: themeColors.infoPanel, border: `1px solid ${themeColors.cardBorder}` }}>
                <h4 style={{
                  margin: '0 0 12px 0',
                  fontSize: '14px',
                  fontWeight: 700,
                  color: themeColors.heading,
                }}>
                   Understanding the Bell Curve
                </h4>
                <p style={{
                  margin: 0,
                  fontSize: '13px',
                  lineHeight: '1.7',
                  color: themeColors.infoText,
                }}>
                  The <strong>shaded area</strong> represents the average range (85-115), where most scores fall.
                  Scores are measured on a standard scale where 100 is the mean average and each 15 points
                  represents one standard deviation from the mean.
                </p>
              </div>
            </div>
          </div>
        ) : (
          /* PRESENTATION MODE */
          <div>
            {/* Print-only header with branding */}
            <div className="print-only print-header" style={{ display: 'none' }}>
              <div>
                {branding.schoolLogo && (
                  <img
                    src={branding.schoolLogo}
                    alt="School Logo"
                    className="print-logo"
                  />
                )}
              </div>
              <div style={{ textAlign: 'right' }}>
                {branding.schoolName && (
                  <h1 style={{
                    margin: '0 0 8px 0',
                    fontSize: '24px',
                    fontWeight: 700,
                    color: '#1a1a2e',
                  }}>
                    {branding.schoolName}
                  </h1>
                )}
                <p style={{
                  margin: 0,
                  fontSize: '14px',
                  color: '#666',
                }}>
                  Student Assessment Report
                </p>
              </div>
            </div>

            <div className="presentation-header">
              {studentName && (
                <h2 style={{
                  fontFamily: "'Playfair Display', serif",
                  fontSize: '42px',
                  fontWeight: 700,
                  margin: '0 0 10px 0',
                  background: theme === 'light'
                    ? 'linear-gradient(135deg, #1a1a2e 0%, #667eea 100%)'
                    : 'linear-gradient(135deg, #f8f9fa 0%, #c8d6e5 100%)',
                  WebkitBackgroundClip: 'text',
                  WebkitTextFillColor: 'transparent',
                }}>
                  {studentName}'s Score Profile
                </h2>
              )}
              {assessmentDate && (
                <p style={{
                  color: themeColors.textMuted,
                  fontSize: '16px',
                  margin: 0,
                }}>
                  Assessment Date: {new Date(assessmentDate).toLocaleDateString('en-US', {
                    year: 'numeric',
                    month: 'long',
                    day: 'numeric'
                  })}
                </p>
              )}
            </div>

            <div className="chart-container" style={{ marginBottom: '32px' }}>
              {/* Hover instruction and label toggle */}
              <div style={{
                display: 'flex',
                justifyContent: 'space-between',
                alignItems: 'center',
                marginBottom: '16px',
              }}>
                <p style={{
                  margin: 0,
                  fontSize: '13px',
                  color: themeColors.textMuted,
                }}>
                   Hover over any score marker to see the test name
                </p>
                <button
                  className="control-btn no-print"
                  onClick={() => setShowLabelsOnCurve(!showLabelsOnCurve)}
                  style={{ fontSize: '12px' }}
                >
                  {showLabelsOnCurve ? ' Hide Labels' : ' Show Labels'}
                </button>
              </div>
              
              <svg viewBox="0 0 800 480" style={{ width: '100%', height: 'auto', overflow: 'visible' }}>
                {/* Grid lines */}
                {[55, 70, 85, 100, 115, 130, 145].map((score) => (
                  <line
                    key={score}
                    x1={getScoreX(score)}
                    y1={chartTopPadding}
                    x2={getScoreX(score)}
                    y2={chartBottomY}
                    stroke={theme === 'dark' ? 'rgba(255, 255, 255, 0.1)' : 'rgba(0, 0, 0, 0.1)'}
                    strokeDasharray="4,4"
                  />
                ))}

                {/* Average range highlight (85-115) */}
                <path
                  d={averageAreaPath}
                  fill={theme === 'dark' ? 'rgba(0, 0, 0, 0.25)' : 'rgba(0, 0, 0, 0.05)'}
                />

                {/* Bell curve */}
                <path
                  d={bellPath}
                  fill={`${bellCurveColor}26`}
                  stroke="url(#curveGradientPres)"
                  strokeWidth="3"
                />

                {/* Gradient definition */}
                <defs>
                  <linearGradient id="curveGradientPres" x1="0%" y1="0%" x2="100%" y2="0%">
                    <stop offset="0%" stopColor={bellCurveColor} />
                    <stop offset="50%" stopColor={bellCurveColor} stopOpacity="0.7" />
                    <stop offset="100%" stopColor={bellCurveColor} />
                  </linearGradient>
                  <filter id="glow">
                    <feGaussianBlur stdDeviation="3" result="coloredBlur"/>
                    <feMerge>
                      <feMergeNode in="coloredBlur"/>
                      <feMergeNode in="SourceGraphic"/>
                    </feMerge>
                  </filter>
                  <filter id="tooltipShadow">
                    <feDropShadow dx="0" dy="2" stdDeviation="4" floodOpacity="0.5"/>
                  </filter>
                </defs>

                {/* Score labels on x-axis */}
                {SCORE_LABELS.map(({ score, label }) => (
                  <g key={score}>
                    <text
                      x={getScoreX(score)}
                      y="370"
                      textAnchor="middle"
                      fill={themeColors.text}
                      fontSize="14"
                      fontWeight="700"
                      fontFamily="Nunito, sans-serif"
                    >
                      {score}
                    </text>
                    <text
                      x={getScoreX(score)}
                      y="390"
                      textAnchor="middle"
                      fill={themeColors.textSecondary}
                      fontSize="11"
                      fontFamily="Nunito, sans-serif"
                    >
                      {label}
                    </text>
                    <text
                      x={getScoreX(score)}
                      y="405"
                      textAnchor="middle"
                      fill={themeColors.textMuted}
                      fontSize="9"
                      fontFamily="Nunito, sans-serif"
                      fontStyle="italic"
                    >
                      {formatPercentile(getPercentileRank(score))} %ile
                    </text>
                  </g>
                ))}

                {/* Average range indicator */}
                <text
                  x={getScoreX(100)}
                  y="430"
                  textAnchor="middle"
                  fill={themeColors.textSecondary}
                  fontSize="12"
                  fontFamily="Nunito, sans-serif"
                  fontWeight="600"
                >
                   Average Range (85-115) 
                </text>

                {/* Score markers with stacking and hover */}
                {getStackedPositions(getVisibleTests()).map(({ test, x, y, baseY, isStacked }) => {
                  const isHovered = hoveredTestId === test.id;
                  const isHidden = hoveredTestId !== null && !isHovered;
                  const textColor = getContrastTextColor(test.color);
                  
                  return (
                    <g 
                      key={test.id} 
                      className="score-marker"
                      onMouseEnter={() => setHoveredTestId(test.id)}
                      onMouseLeave={() => setHoveredTestId(null)}
                      style={{ 
                        cursor: 'pointer',
                        opacity: isHidden ? 0.15 : 1,
                        transition: 'opacity 0.2s ease',
                      }}
                    >
                      {/* Vertical line to base of curve */}
                      <line
                        x1={x}
                        y1={baseY}
                        x2={x}
                        y2={chartBottomY}
                        stroke={test.color}
                        strokeWidth="2"
                        strokeDasharray="6,4"
                        opacity={isHidden ? 0.3 : 0.7}
                      />
                      {/* Connector line if stacked */}
                      {y < baseY && (
                        <line
                          x1={x}
                          y1={y + 18}
                          x2={x}
                          y2={baseY}
                          stroke={test.color}
                          strokeWidth="2"
                          opacity={isHidden ? 0.2 : 0.5}
                        />
                      )}
                      {/* Marker dot */}
                      <circle
                        cx={x}
                        cy={y}
                        r={isHovered ? 22 : 18}
                        fill={test.color}
                        stroke="white"
                        strokeWidth={isHovered ? 4 : 3}
                        filter={isHovered ? "url(#glow)" : "none"}
                        style={{ transition: 'all 0.2s ease' }}
                      />
                      {/* Score on marker */}
                      <text
                        x={x}
                        y={y + 5}
                        textAnchor="middle"
                        fill={textColor}
                        fontSize={isHovered ? "14" : "12"}
                        fontWeight="800"
                        fontFamily="Nunito, sans-serif"
                        style={{ transition: 'all 0.2s ease' }}
                      >
                        {test.score}
                      </text>
                      
                      {/* Tooltip on hover */}
                      {isHovered && (
                        <g className="tooltip">
                          {/* Tooltip background - dark background for better contrast */}
                          <rect
                            x={x - Math.max(test.name.length * 4.5 + 16, 80)}
                            y={y - 80}
                            width={Math.max(test.name.length * 9 + 32, 160)}
                            height="54"
                            rx="10"
                            fill="#1a1a2e"
                            stroke={test.color}
                            strokeWidth="2"
                            filter="url(#tooltipShadow)"
                          />
                          {/* Tooltip arrow */}
                          <polygon
                            points={`${x - 10},${y - 26} ${x + 10},${y - 26} ${x},${y - 18}`}
                            fill="#1a1a2e"
                            stroke={test.color}
                            strokeWidth="2"
                          />
                          {/* Cover the arrow's top stroke */}
                          <rect
                            x={x - 9}
                            y={y - 28}
                            width="18"
                            height="4"
                            fill="#1a1a2e"
                          />
                          {/* Tooltip text - test name */}
                          <text
                            x={x}
                            y={y - 56}
                            textAnchor="middle"
                            fill="#ffffff"
                            fontSize="14"
                            fontWeight="700"
                            fontFamily="Nunito, sans-serif"
                          >
                            {test.name}
                          </text>
                          {/* Tooltip text - percentile */}
                          <text
                            x={x}
                            y={y - 38}
                            textAnchor="middle"
                            fill={test.color}
                            fontSize="12"
                            fontWeight="600"
                            fontFamily="Nunito, sans-serif"
                          >
                            {formatPercentile(getPercentileRank(test.score))} Percentile
                          </text>
                        </g>
                      )}
                    </g>
                  );
                })}

                {/* Test name labels with collision avoidance - always shown in print, toggle in screen view */}
                {(showLabelsOnCurve || typeof window !== 'undefined') && (() => {
                  const stackedPositions = getStackedPositions(getVisibleTests());
                  const labelPositionsData = getLabelPositionsWithCollisionAvoidance(stackedPositions);

                  return labelPositionsData.map((labelInfo) => {
                    const { test, markerX, markerY, labelY, adjustedX, textAnchor, rectX, rectWidth, rectHeight, needsConnector } = labelInfo;

                    // Apply custom position offset if exists
                    const customPos = labelPositions[test.id];
                    const finalLabelY = customPos ? labelY + customPos.y : labelY;
                    const finalAdjustedX = customPos ? adjustedX + customPos.x : adjustedX;
                    const finalRectX = customPos ? rectX + customPos.x : rectX;

                    // Recalculate rect dimensions based on custom styles
                    const textLength = test.name.length * (labelStyles.fontSize * 0.6);
                    const finalRectWidth = Math.min(textLength + labelStyles.padding * 2, labelStyles.maxWidth);
                    const finalRectHeight = labelStyles.fontSize + labelStyles.padding * 2;

                    return (
                      <g key={`label-${test.id}`} className={showLabelsOnCurve ? '' : 'print-only'} style={{ display: showLabelsOnCurve ? 'block' : 'none' }}>
                        {/* Connector line from bubble to label */}
                        {needsConnector && (
                          <g>
                            {/* Vertical line from bottom of bubble to top of label */}
                            <line
                              x1={markerX}
                              y1={markerY + 18}
                              x2={customPos ? markerX + customPos.x : markerX}
                              y2={finalLabelY - finalRectHeight / 2 - 2}
                              stroke={test.color}
                              strokeWidth="1.5"
                              strokeDasharray="3,3"
                              opacity="0.6"
                            />
                          </g>
                        )}

                        {/* Label background for better readability */}
                        <rect
                          x={finalRectX}
                          y={finalLabelY - finalRectHeight / 2}
                          width={finalRectWidth}
                          height={finalRectHeight}
                          rx={labelStyles.borderRadius}
                          fill={themeColors.cardBg}
                          stroke={test.color}
                          strokeWidth="2"
                          style={{ cursor: 'grab' }}
                          onMouseDown={(e) => handleLabelDragStart(e, test.id, finalRectX, finalLabelY)}
                          onTouchStart={(e) => handleLabelDragStart(e, test.id, finalRectX, finalLabelY)}
                        />

                        {/* Test name label */}
                        <text
                          x={finalAdjustedX}
                          y={finalLabelY + labelStyles.fontSize / 3}
                          textAnchor={textAnchor}
                          fill={test.color}
                          fontSize={labelStyles.fontSize}
                          fontWeight="700"
                          fontFamily="Nunito, sans-serif"
                          style={{ pointerEvents: 'none', userSelect: 'none' }}
                        >
                          {test.name}
                        </text>
                      </g>
                    );
                  });
                })()}
              </svg>
            </div>

            {/* Test Selection Panel */}
            {tests.length > 0 && (
              <div style={{
                background: themeColors.cardBg,
                borderRadius: '20px',
                padding: '28px',
                marginBottom: '32px',
                border: `1px solid ${themeColors.cardBorder}`,
              }}>
                <div style={{
                  display: 'flex',
                  justifyContent: 'space-between',
                  alignItems: 'center',
                  marginBottom: '20px',
                }}>
                  <h3 style={{
                    margin: 0,
                    fontSize: '18px',
                    fontWeight: 700,
                    color: themeColors.heading,
                    letterSpacing: '1px',
                    textTransform: 'uppercase',
                  }}>
                     Select Tests to Display
                  </h3>
                  <div style={{ display: 'flex', gap: '10px' }}>
                    <button className="control-btn" onClick={showAllTests}>
                      Show All
                    </button>
                    <button className="control-btn" onClick={hideAllTests}>
                      Hide All
                    </button>
                  </div>
                </div>
                
                <div style={{
                  display: 'grid',
                  gridTemplateColumns: 'repeat(auto-fill, minmax(280px, 1fr))',
                  gap: '12px',
                }}>
                  {tests.map((test) => {
                    const isChecked = visibleTestIds.has(test.id);
                    return (
                      <div
                        key={test.id}
                        className={`checkbox-card ${isChecked ? 'checked' : ''}`}
                        onClick={() => toggleTestVisibility(test.id)}
                        style={{ color: test.color }}
                      >
                        <div 
                          className={`custom-checkbox ${isChecked ? 'checked' : ''}`}
                          style={{ borderColor: isChecked ? test.color : undefined, background: isChecked ? test.color : 'transparent' }}
                        >
                          {isChecked && <span className="checkmark" style={{ color: getContrastTextColor(test.color) }}></span>}
                        </div>
                        <div
                          style={{
                            width: '12px',
                            height: '36px',
                            borderRadius: '6px',
                            backgroundColor: test.color,
                            flexShrink: 0,
                          }}
                        />
                        <div style={{ flex: 1 }}>
                          <div style={{
                            fontWeight: 700,
                            fontSize: '15px',
                            color: themeColors.text,
                            marginBottom: '2px',
                          }}>
                            {test.name}
                          </div>
                          <div style={{
                            fontSize: '13px',
                            color: themeColors.textMuted,
                          }}>
                            Score: <span style={{ color: test.color, fontWeight: 700 }}>{test.score}</span> ({formatPercentile(getPercentileRank(test.score))})  {getScoreDescription(test.score)}
                          </div>
                        </div>
                      </div>
                    );
                  })}
                </div>
              </div>
            )}

            {/* Score Summary Cards */}
            {getVisibleTests().length > 0 && (
              <div style={{
                display: 'grid',
                gridTemplateColumns: 'repeat(auto-fit, minmax(200px, 1fr))',
                gap: '16px',
                marginBottom: '32px',
              }}>
                {getVisibleTests().map((test) => (
                  <div
                    key={test.id}
                    style={{
                      background: themeColors.cardBg,
                      borderRadius: '16px',
                      padding: '20px',
                      borderLeft: `5px solid ${test.color}`,
                      backdropFilter: 'blur(10px)',
                      border: `1px solid ${themeColors.cardBorder}`,
                      borderLeftWidth: '5px',
                      borderLeftColor: test.color,
                    }}
                  >
                    <div style={{
                      display: 'flex',
                      alignItems: 'center',
                      gap: '10px',
                      marginBottom: '10px',
                    }}>
                      <div
                        style={{
                          width: '16px',
                          height: '16px',
                          borderRadius: '50%',
                          backgroundColor: test.color,
                        }}
                      />
                      <h4 style={{
                        margin: 0,
                        fontSize: '15px',
                        fontWeight: 700,
                        color: themeColors.heading,
                      }}>
                        {test.name}
                      </h4>
                    </div>
                    <div style={{
                      fontSize: '32px',
                      fontWeight: 800,
                      color: test.color,
                      marginBottom: '4px',
                    }}>
                      {test.score}
                    </div>
                    <div style={{
                      fontSize: '14px',
                      color: themeColors.textSecondary,
                      fontWeight: 700,
                      marginBottom: '6px',
                    }}>
                      {formatPercentile(getPercentileRank(test.score))} Percentile
                    </div>
                    <div style={{
                      fontSize: '13px',
                      color: themeColors.textMuted,
                      fontWeight: 600,
                    }}>
                      {getScoreDescription(test.score)} Range
                    </div>
                  </div>
                ))}
              </div>
            )}

            {tests.length === 0 && (
              <div style={{
                textAlign: 'center',
                padding: '80px 40px',
                background: themeColors.cardBgAlt,
                borderRadius: '20px',
                color: themeColors.textMuted,
              }}>
                <div style={{ fontSize: '48px', marginBottom: '16px' }}></div>
                <p style={{ fontSize: '18px', margin: 0 }}>
                  Switch to Input Mode to add test scores
                </p>
              </div>
            )}

            {/* Assessment Summary */}
            {tests.length > 0 && (
              <>
                <div style={{
                  background: themeColors.cardBg,
                  borderRadius: '20px',
                  padding: '28px',
                  marginBottom: '32px',
                  border: `1px solid ${themeColors.cardBorder}`,
                }}>
                  <h3 style={{
                    margin: '0 0 20px 0',
                    fontSize: '18px',
                    fontWeight: 700,
                    color: themeColors.heading,
                    letterSpacing: '1px',
                    textTransform: 'uppercase',
                  }}>
                     Editable Summary
                  </h3>
                  <p style={{
                    margin: '0 0 12px 0',
                    fontSize: '13px',
                    color: themeColors.textSecondary,
                  }}>
                    Customize the auto-generated summary for this student. Leave blank to use the default narrative.
                  </p>
                  <textarea
                    value={summaryOverride}
                    onChange={(e) => setSummaryOverride(e.target.value)}
                    placeholder={generateSummary()}
                    className="input-field"
                    style={{ width: '100%', minHeight: '140px', resize: 'vertical', background: themeColors.inputBg, color: themeColors.text, border: `2px solid ${themeColors.inputBorder}` }}
                  />
                  <div style={{ display: 'flex', justifyContent: 'flex-end', marginTop: '12px' }}>
                    <button
                      className="control-btn"
                      onClick={() => setSummaryOverride('')}
                    >
                      Reset to Auto Summary
                    </button>
                  </div>
                </div>

                <div style={{
                  background: themeColors.cardBg,
                  borderRadius: '20px',
                  padding: '28px',
                  marginBottom: '32px',
                  border: `1px solid ${themeColors.cardBorder}`,
                }}>
                  <h3 style={{
                    margin: '0 0 20px 0',
                    fontSize: '18px',
                    fontWeight: 700,
                    color: themeColors.heading,
                    letterSpacing: '1px',
                    textTransform: 'uppercase',
                  }}>
                     Assessment Summary
                  </h3>
                  <div style={{
                    fontSize: '15px',
                    lineHeight: '1.8',
                    color: themeColors.text,
                    textAlign: 'justify',
                  }}>
                    {computedSummary}
                  </div>
                </div>
              </>
            )}

            {/* Parent-Friendly Explanation (visible in print) */}
            {tests.length > 0 && (
              <div className="print-only" style={{
                display: 'none',
                background: '#f8f9fa',
                borderRadius: '12px',
                padding: '24px',
                marginBottom: '24px',
                border: '1px solid #ddd',
              }}>
                <h3 style={{
                  margin: '0 0 16px 0',
                  fontSize: '18px',
                  fontWeight: 700,
                  color: '#1a1a2e',
                }}>
                  Understanding Your Child's Assessment Results
                </h3>
                <p style={{
                  margin: '0 0 12px 0',
                  fontSize: '14px',
                  lineHeight: '1.6',
                  color: '#333',
                }}>
                  This report shows your child's test scores plotted on a bell curve, which represents how scores typically distribute across a population. The bell curve helps visualize where your child's performance falls relative to expected norms.
                </p>
                <p style={{
                  margin: '0 0 12px 0',
                  fontSize: '14px',
                  lineHeight: '1.6',
                  color: '#333',
                }}>
                  <strong>The Average Range (85-115):</strong> Most students score in this range (about 68% of all test-takers). Scores in this range indicate typical, age-appropriate performance.
                </p>
                <p style={{
                  margin: 0,
                  fontSize: '14px',
                  lineHeight: '1.6',
                  color: '#333',
                }}>
                  <strong>Score Scale:</strong> Scores are standardized with an average of 100 and typically range from 40 to 160. Each 15-point increment represents one standard deviation from the average.
                </p>
              </div>
            )}

            {/* Interpretation Guide */}
            {tests.length > 0 && (
              <div style={{
                background: themeColors.cardBg,
                borderRadius: '20px',
                padding: '28px',
                border: `1px solid ${themeColors.cardBorder}`,
              }}>
                <h3 style={{
                  margin: '0 0 20px 0',
                  fontSize: '18px',
                  fontWeight: 700,
                  color: themeColors.heading,
                }}>
                   Score Interpretation Guide
                </h3>
                <div style={{
                  display: 'grid',
                  gridTemplateColumns: 'repeat(auto-fit, minmax(200px, 1fr))',
                  gap: '16px',
                }}>
                  {[
                    { range: '130+', label: 'Very High', desc: 'Top 2%' },
                    { range: '115-129', label: 'High', desc: 'Top 16%' },
                    { range: '85-114', label: 'Average', desc: 'Middle 68%' },
                    { range: '70-84', label: 'Low', desc: 'Bottom 16%' },
                    { range: 'Below 70', label: 'Very Low', desc: 'Bottom 2%' },
                  ].map((item) => (
                    <div
                      key={item.range}
                      style={{
                        padding: '16px',
                        background: themeColors.cardBgAlt,
                        borderRadius: '12px',
                      }}
                    >
                      <div style={{
                        fontSize: '16px',
                        fontWeight: 700,
                        marginBottom: '4px',
                        color: themeColors.text,
                      }}>
                        {item.range}
                      </div>
                      <div style={{
                        fontSize: '13px',
                        color: themeColors.textSecondary,
                      }}>
                        {item.label}  {item.desc}
                      </div>
                    </div>
                  ))}
                </div>
              </div>
            )}

            {/* Print-only footer with branding */}
            <div className="print-only print-footer" style={{ display: 'none' }}>
              {branding.footerText && (
                <p style={{ margin: '0 0 10px 0' }}>
                  {branding.footerText}
                </p>
              )}
              <p style={{ margin: 0 }}>
                Generated on {new Date().toLocaleDateString('en-US', {
                  year: 'numeric',
                  month: 'long',
                  day: 'numeric'
                })}
                {branding.schoolName && `  ${branding.schoolName}`}
              </p>
            </div>
          </div>
        )}
      </div>
    </div>
  );
}



        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<BellCurveApp />);
    </script>
</body>
</html>
