<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Bell Curve Score Visualizer</title>
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <style>
        body {
            margin: 0;
            padding: 0;
        }
        #root {
            min-height: 100vh;
        }
    </style>
</head>
<body>
    <div id="root"></div>
    <script type="text/babel">


const PRESET_COLORS = [
  { name: 'Coral', value: '#FF6B6B', textColor: '#ffffff' },
  { name: 'Ocean', value: '#4ECDC4', textColor: '#1a1a2e' },
  { name: 'Sunset', value: '#FFE66D', textColor: '#1a1a2e' },
  { name: 'Lavender', value: '#9B7EDE', textColor: '#ffffff' },
  { name: 'Mint', value: '#95E1D3', textColor: '#1a1a2e' },
  { name: 'Peach', value: '#FFEAA7', textColor: '#1a1a2e' },
  { name: 'Sky', value: '#74B9FF', textColor: '#1a1a2e' },
  { name: 'Rose', value: '#FD79A8', textColor: '#ffffff' },
  { name: 'Lime', value: '#00B894', textColor: '#ffffff' },
  { name: 'Tangerine', value: '#E17055', textColor: '#ffffff' },
];

const SCORE_LABELS = [
  { score: 55, label: 'Very Low' },
  { score: 70, label: 'Low' },
  { score: 85, label: 'Low Average' },
  { score: 100, label: 'Average' },
  { score: 115, label: 'High Average' },
  { score: 130, label: 'Superior' },
  { score: 145, label: 'Very Superior' },
];

const PRESET_TEMPLATES = [
  {
    name: 'Cognitive Snapshot',
    description: 'Core cognitive domains with typical standard scores.',
    tests: [
      { name: 'Verbal Comprehension', score: 105 },
      { name: 'Visual Spatial', score: 98 },
      { name: 'Fluid Reasoning', score: 112 },
      { name: 'Working Memory', score: 92 },
      { name: 'Processing Speed', score: 88 },
    ],
  },
  {
    name: 'Academic Achievement',
    description: 'Sample achievement profile across subjects.',
    tests: [
      { name: 'Reading', score: 103 },
      { name: 'Math', score: 95 },
      { name: 'Writing', score: 110 },
      { name: 'Spelling', score: 99 },
    ],
  },
  {
    name: 'Strengths & Supports',
    description: 'Balanced profile with clear strengths and needs.',
    tests: [
      { name: 'Listening Comprehension', score: 120 },
      { name: 'Word Reading', score: 107 },
      { name: 'Math Calculation', score: 84 },
      { name: 'Writing Samples', score: 90 },
    ],
  },
];

const HELP_STEPS = [
  {
    title: 'Step 1: Enter Student Info',
    body: 'Add a student name and assessment date to personalize the report.',
  },
  {
    title: 'Step 2: Add Scores',
    body: 'Add each test/section score (40-160). Choose colors to differentiate tests.',
  },
  {
    title: 'Step 3: Use Templates (Optional)',
    body: 'Load a preset template to quickly add common assessment domains.',
  },
  {
    title: 'Step 4: Review & Edit Summary',
    body: 'Switch to Presentation mode to review the bell curve, tooltips, and editable summary.',
  },
  {
    title: 'Step 5: Print or Download PDF',
    body: 'Use Print Preview for final formatting and Download PDF for a shareable report.',
  },
];

const PREDEFINED_TESTS = [
  {
    name: 'Wechsler Intelligence Scale for Children - Fifth Edition (WISC-V)',
    subtests: [
      'Full Scale IQ',
      'Verbal Comprehension Index',
      'Visual Spatial Index',
      'Fluid Reasoning Index',
      'Working Memory Index',
      'Processing Speed Index',
    ]
  },
  {
    name: 'Wechsler Individual Achievement Test - Fourth Edition (WIAT-IV)',
    subtests: [
      'Total Achievement',
      'Reading Composite',
      'Mathematics Composite',
      'Written Expression Composite',
      'Oral Language Composite',
    ]
  },
  {
    name: 'Woodcock-Johnson IV Tests of Cognitive Abilities (WJ-IV COG)',
    subtests: [
      'General Intellectual Ability',
      'Comprehension-Knowledge',
      'Fluid Reasoning',
      'Short-Term Working Memory',
      'Cognitive Processing Speed',
      'Auditory Processing',
      'Long-Term Retrieval',
      'Visual Processing',
    ]
  },
  {
    name: 'Woodcock-Johnson IV Tests of Achievement (WJ-IV ACH)',
    subtests: [
      'Broad Reading',
      'Broad Mathematics',
      'Broad Written Language',
      'Academic Skills',
      'Academic Fluency',
      'Academic Applications',
    ]
  },
  {
    name: 'NEPSY-II Neuropsychological Assessment',
    subtests: [
      'Attention/Executive Functioning',
      'Language',
      'Memory and Learning',
      'Sensorimotor',
      'Social Perception',
      'Visuospatial Processing',
    ]
  },
  {
    name: 'Vineland Adaptive Behavior Scales - Third Edition (Vineland-3)',
    subtests: [
      'Adaptive Behavior Composite',
      'Communication Domain',
      'Daily Living Skills Domain',
      'Socialization Domain',
      'Motor Skills Domain',
    ]
  },
  {
    name: 'Conners 4 ADHD Assessment',
    subtests: [
      'Conners 4 ADHD Index',
      'Inattention/Executive Dysfunction',
      'Hyperactivity',
      'Impulsivity',
      'Emotional Dysregulation',
    ]
  },
  {
    name: 'Behavior Assessment System for Children - Third Edition (BASC-3)',
    subtests: [
      'Behavioral Symptoms Index',
      'Externalizing Problems',
      'Internalizing Problems',
      'Adaptive Skills',
    ]
  },
  {
    name: 'Kaufman Assessment Battery for Children (KABC-II)',
    subtests: [
      'Mental Processing Index',
      'Fluid Crystallized Index',
      'Sequential Index',
      'Simultaneous Index',
      'Learning Index',
      'Planning Index',
    ]
  },
  {
    name: 'Comprehensive Test of Phonological Processing (CTOPP-2)',
    subtests: [
      'Phonological Awareness',
      'Phonological Memory',
      'Rapid Symbolic Naming',
      'Phonological Processing Index',
    ]
  },
  {
    name: 'Comprehensive Test of Nonverbal Intelligence 2nd Edition (CTONI-2)',
    subtests: [
      'Pictorial Scale Composite',
      'Geometric Composite',
      'Full Scale',
      'Nonverbal Index',
    ]
  },
  {
    name: 'Cognitive Assessment System-Second Edition Brief (CAS-2 Brief)',
    subtests: [
      'Planned Codes',
      'Simultaneous Matrices',
      'Expressive Attention',
      'Successive Digits',
    ]
  },
  {
    name: 'Wide Range Assessment of Memory and Learning- Third Edition (WRAML-3)',
    subtests: [
      'Verbal Memory',
      'Visual Memory',
      'Attention/Concentration',
      'General Memory',
    ]
  },
  // Standalone tests/indices
  'Full Scale IQ',
  'Verbal Comprehension Index',
  'Visual Spatial Index',
  'Fluid Reasoning Index',
  'Working Memory Index',
  'Processing Speed Index',
  'Total Achievement',
  'Reading Composite',
  'Mathematics Composite',
  'Written Expression Composite',
  'Oral Language Composite',
  'General Intellectual Ability',
  'Comprehension-Knowledge',
  'Fluid Reasoning',
  'Short-Term Working Memory',
  'Cognitive Processing Speed',
  'Auditory Processing',
  'Long-Term Retrieval',
  'Visual Processing',
  'Broad Reading',
  'Broad Mathematics',
  'Broad Written Language',
  'Academic Skills',
  'Academic Fluency',
  'Academic Applications',
  'Attention/Executive Functioning',
  'Language',
  'Memory and Learning',
  'Sensorimotor',
  'Social Perception',
  'Visuospatial Processing',
  'Adaptive Behavior Composite',
  'Communication Domain',
  'Daily Living Skills Domain',
  'Socialization Domain',
  'Motor Skills Domain',
  'Conners 4 ADHD Index',
  'Inattention/Executive Dysfunction',
  'Hyperactivity',
  'Impulsivity',
  'Emotional Dysregulation',
  'Behavioral Symptoms Index',
  'Externalizing Problems',
  'Internalizing Problems',
  'Adaptive Skills',
  'Beery-Buktenica Developmental Test of Visual Motor Integration, Sixth Edition',
  'Auditory Memory Index',
  'Listening Comprehension Index',
  'Mental Processing Index',
  'Fluid Crystallized Index',
  'Sequential Index',
  'Simultaneous Index',
  'Learning Index',
  'Planning Index',
  'Phonological Awareness',
  'Phonological Memory',
  'Rapid Symbolic Naming',
  'Phonological Processing Index',
  'Pictorial Scale Composite',
  'Geometric Composite',
  'Full Scale',
  'Nonverbal Index',
  'Planned Codes',
  'Simultaneous Matrices',
  'Expressive Attention',
  'Successive Digits',
  'Verbal Memory',
  'Visual Memory',
  'Attention/Concentration',
  'General Memory',
];

// Helper function to determine if a color is light or dark
const getContrastTextColor = (hexColor) => {
  const hex = hexColor.replace('#', '');
  const r = parseInt(hex.substring(0, 2), 16);
  const g = parseInt(hex.substring(2, 4), 16);
  const b = parseInt(hex.substring(4, 6), 16);
  const luminance = (0.299 * r + 0.587 * g + 0.114 * b) / 255;
  return luminance > 0.5 ? '#1a1a2e' : '#ffffff';
};

function BellCurveApp() {
  const [mode, setMode] = React.useState('input');
  const [tests, setTests] = React.useState([]);
  const [newTest, setNewTest] = React.useState({ name: '', score: '', color: PRESET_COLORS[0].value });
  const [studentName, setStudentName] = React.useState('');
  const [assessmentDate, setAssessmentDate] = React.useState('');
  const [visibleTestIds, setVisibleTestIds] = React.useState(new Set());
  const [hoveredTestId, setHoveredTestId] = React.useState(null);
  const [activeTestId, setActiveTestId] = React.useState(null);
  const [openClusterId, setOpenClusterId] = React.useState(null); // For cluster marker popover
  const [summaryOverride, setSummaryOverride] = React.useState('');

  // Refs for sidebar rows (for auto-scroll)
  const sidebarRowRefs = React.useRef({});
  const [printMode, setPrintMode] = React.useState(false);
  const [showHelpPanel, setShowHelpPanel] = React.useState(false);
  const importInputRef = React.useRef(null);

  // Branding state
  const [branding, setBranding] = React.useState({
    schoolName: '',
    schoolLogo: '',
    primaryColor: '#667eea',
    footerText: '',
  });
  const [showBrandingPanel, setShowBrandingPanel] = React.useState(false);

  // Student profiles state
  const [savedProfiles, setSavedProfiles] = React.useState([]);
  const [currentProfileId, setCurrentProfileId] = React.useState(null);
  const [showProfilesPanel, setShowProfilesPanel] = React.useState(false);

  // Autocomplete state
  const [autocompleteSuggestions, setAutocompleteSuggestions] = React.useState([]);
  const [showAutocomplete, setShowAutocomplete] = React.useState(false);
  const autocompleteRef = React.useRef(null);
  const autocompleteInputRef = React.useRef(null);
  const autocompleteMenuRef = React.useRef(null);
  const [autocompleteStyles, setAutocompleteStyles] = React.useState(null);

  // Edit test state
  const [editingTestId, setEditingTestId] = React.useState(null);
  const [editingTest, setEditingTest] = React.useState(null);

  // Theme and customization state
  const [theme, setTheme] = React.useState('dark'); // 'light' or 'dark'
  const [bellCurveColor, setBellCurveColor] = React.useState('#667eea');
  const [showThemePanel, setShowThemePanel] = React.useState(false);

  // Theme colors based on current theme (driven by CSS variables)
  const themeColors = React.useMemo(() => ({
    background: 'var(--bg)',
    cardBg: 'var(--surface)',
    cardBorder: 'var(--border)',
    text: 'var(--text)',
    textSecondary: 'var(--text-muted)',
    textMuted: 'var(--text-subtle)',
    inputBg: 'var(--input-bg)',
    inputBorder: 'var(--border)',
    chartBg: 'var(--surface-2)',
    panelBg: 'var(--surface-2)',
    primary: 'var(--primary)',
  }), [theme]);

  // Load branding and profiles from localStorage on mount
  React.useEffect(() => {
    try {
      const savedBranding = localStorage.getItem('bellcurve_branding');
      if (savedBranding) {
        setBranding(JSON.parse(savedBranding));
      }

      const profiles = localStorage.getItem('bellcurve_profiles');
      if (profiles) {
        setSavedProfiles(JSON.parse(profiles));
      }

      const savedTheme = localStorage.getItem('bellcurve_theme');
      if (savedTheme) {
        setTheme(savedTheme);
      }

      const savedCurveColor = localStorage.getItem('bellcurve_curvecolor');
      if (savedCurveColor) {
        setBellCurveColor(savedCurveColor);
      }
    } catch (error) {
      console.error('Error loading data from localStorage:', error);
    }
  }, []);

  // Save branding to localStorage whenever it changes
  React.useEffect(() => {
    try {
      localStorage.setItem('bellcurve_branding', JSON.stringify(branding));
    } catch (error) {
      console.error('Error saving branding:', error);
    }
  }, [branding]);

  // Save theme preferences to localStorage and update CSS variables
  React.useEffect(() => {
    try {
      localStorage.setItem('bellcurve_theme', theme);
      localStorage.setItem('bellcurve_curvecolor', bellCurveColor);
      // Update data-theme attribute for CSS variables
      document.documentElement.setAttribute('data-theme', theme);
    } catch (error) {
      console.error('Error saving theme:', error);
    }
  }, [theme, bellCurveColor]);

  React.useEffect(() => {
    const handleAfterPrint = () => {
      setPrintMode(false);
    };
    window.addEventListener('afterprint', handleAfterPrint);
    return () => window.removeEventListener('afterprint', handleAfterPrint);
  }, []);

  React.useEffect(() => {
    if (mode !== 'presentation') {
      setPrintMode(false);
    }
  }, [mode]);

  // Save current profile
  const saveCurrentProfile = () => {
    if (!studentName) {
      alert('Please enter a student name before saving');
      return;
    }

    const profile = {
      id: currentProfileId || Date.now(),
      studentName,
      assessmentDate,
      tests: tests.map(t => ({ ...t })),
      summaryOverride,
      savedAt: new Date().toISOString(),
    };

    const updatedProfiles = currentProfileId
      ? savedProfiles.map(p => p.id === currentProfileId ? profile : p)
      : [...savedProfiles, profile];

    setSavedProfiles(updatedProfiles);
    setCurrentProfileId(profile.id);

    try {
      localStorage.setItem('bellcurve_profiles', JSON.stringify(updatedProfiles));
      alert(`Profile saved successfully!\nStudent: ${studentName}\nTests saved: ${tests.length}\nAssessment date: ${assessmentDate || 'Not set'}`);
    } catch (error) {
      console.error('Error saving profile:', error);
      alert('Error saving profile. Please try again.');
    }
  };

  // Load a profile
  const loadProfile = (profile) => {
    setStudentName(profile.studentName);
    setAssessmentDate(profile.assessmentDate || '');
    setTests(profile.tests ? profile.tests.map(t => ({ ...t })) : []);
    setSummaryOverride(profile.summaryOverride || '');
    setCurrentProfileId(profile.id);
    setVisibleTestIds(new Set(profile.tests ? profile.tests.map(t => t.id) : []));
    setShowProfilesPanel(false);
    setMode('input');

    // Show confirmation message
    const testCount = profile.tests ? profile.tests.length : 0;
    alert(`Profile loaded successfully!\nStudent: ${profile.studentName}\nTests loaded: ${testCount}`);
  };

  // Delete a profile
  const deleteProfile = (profileId) => {
    if (confirm('Are you sure you want to delete this profile?')) {
      const updatedProfiles = savedProfiles.filter(p => p.id !== profileId);
      setSavedProfiles(updatedProfiles);

      try {
        localStorage.setItem('bellcurve_profiles', JSON.stringify(updatedProfiles));
        if (currentProfileId === profileId) {
          setCurrentProfileId(null);
        }
      } catch (error) {
        console.error('Error deleting profile:', error);
      }
    }
  };

  // Start a new profile
  const startNewProfile = () => {
    if (tests.length > 0 || studentName) {
      if (!confirm('Start a new profile? Any unsaved changes will be lost.')) {
        return;
      }
    }
    setStudentName('');
    setAssessmentDate('');
    setTests([]);
    setSummaryOverride('');
    setCurrentProfileId(null);
    setVisibleTestIds(new Set());
    setShowProfilesPanel(false);
  };

  // Handle logo upload
  const handleLogoUpload = (e) => {
    const file = e.target.files[0];
    if (file) {
      const reader = new FileReader();
      reader.onloadend = () => {
        setBranding({ ...branding, schoolLogo: reader.result });
      };
      reader.readAsDataURL(file);
    }
  };

  // Print/Export PDF functionality
  const handlePrint = () => {
    window.print();
  };

  const handleDownloadPdf = () => {
    setPrintMode(true);
    setTimeout(() => {
      window.print();
    }, 200);
  };

  // Helper: get dot style based on number of selected tests
  const getDotStyle = (count) => {
    if (count <= 12) return { dotRadius: 6, fontSize: '9', clusterMode: false };
    if (count <= 24) return { dotRadius: 4, fontSize: '7', clusterMode: false };
    return { dotRadius: 5, fontSize: '8', clusterMode: true };
  };

  const handleExportProfiles = () => {
    if (savedProfiles.length === 0) {
      alert('No saved profiles to export yet.');
      return;
    }

    const payload = {
      exportedAt: new Date().toISOString(),
      version: '1.0',
      profiles: savedProfiles,
    };
    const blob = new Blob([JSON.stringify(payload, null, 2)], { type: 'application/json' });
    const url = URL.createObjectURL(blob);
    const anchor = document.createElement('a');
    anchor.href = url;
    anchor.download = `bell-curve-profiles-${new Date().toISOString().slice(0, 10)}.json`;
    anchor.click();
    URL.revokeObjectURL(url);
  };

  const handleImportProfiles = (event) => {
    const file = event.target.files?.[0];
    if (!file) return;

    const reader = new FileReader();
    reader.onload = () => {
      try {
        const parsed = JSON.parse(reader.result);
        const incomingProfiles = Array.isArray(parsed) ? parsed : parsed.profiles;
        if (!Array.isArray(incomingProfiles)) {
          throw new Error('Invalid file format.');
        }
        const confirmImport = confirm('Import profiles? Existing profiles will be merged.');
        if (!confirmImport) {
          event.target.value = '';
          return;
        }
        const merged = [...savedProfiles, ...incomingProfiles];
        const deduped = Array.from(new Map(merged.map(p => [p.id, p])).values());
        setSavedProfiles(deduped);
        localStorage.setItem('bellcurve_profiles', JSON.stringify(deduped));
        alert(`Imported ${incomingProfiles.length} profile(s) successfully.`);
      } catch (error) {
        console.error('Error importing profiles:', error);
        alert('Unable to import profiles. Please check the file format.');
      } finally {
        event.target.value = '';
      }
    };
    reader.readAsText(file);
  };

  const applyTemplate = (template) => {
    if (tests.length > 0) {
      const confirmReplace = confirm('Apply template? This will replace existing tests.');
      if (!confirmReplace) return;
    }
    const templatedTests = template.tests.map((test, index) => ({
      ...test,
      id: Date.now() + index,
      color: PRESET_COLORS[index % PRESET_COLORS.length].value,
    }));
    setTests(templatedTests);
    setSummaryOverride('');
    setVisibleTestIds(new Set(templatedTests.map(t => t.id)));
  };

  // Autocomplete handlers
  const handleTestNameChange = (e) => {
    const value = e.target.value;
    setNewTest({ ...newTest, name: value });

    if (value.trim().length > 0) {
      const filtered = PREDEFINED_TESTS.filter(test => {
        if (typeof test === 'string') {
          return test.toLowerCase().includes(value.toLowerCase());
        } else {
          // Check parent test name or any subtest name
          return test.name.toLowerCase().includes(value.toLowerCase()) ||
                 test.subtests.some(subtest => subtest.toLowerCase().includes(value.toLowerCase()));
        }
      });
      setAutocompleteSuggestions(filtered);
      setShowAutocomplete(filtered.length > 0);
    } else {
      setAutocompleteSuggestions([]);
      setShowAutocomplete(false);
    }
  };

  const handleSuggestionClick = (suggestion) => {
    // Check if suggestion is a parent test with subtests
    if (typeof suggestion === 'object' && suggestion.subtests) {
      // Auto-add all subtests with the same color
      const sharedColor = newTest.color;
      const newTests = suggestion.subtests.map((subtest, index) => ({
        name: subtest,
        score: 100, // Default score, user can edit
        id: Date.now() + index,
        color: sharedColor,
      }));
      setTests([...tests, ...newTests]);
      setVisibleTestIds(prev => new Set([...prev, ...newTests.map(t => t.id)]));
      const nextColorIndex = (tests.length + newTests.length) % PRESET_COLORS.length;
      setNewTest({ name: '', score: '', color: PRESET_COLORS[nextColorIndex].value });
    } else {
      // Single test/subtest - just populate the input field
      const testName = typeof suggestion === 'string' ? suggestion : suggestion.name;
      setNewTest({ ...newTest, name: testName });
    }
    setShowAutocomplete(false);
    setAutocompleteSuggestions([]);
  };

  // Close autocomplete when clicking outside
  React.useEffect(() => {
    const handleClickOutside = (event) => {
      const isInsideInput = autocompleteRef.current?.contains(event.target);
      const isInsideMenu = autocompleteMenuRef.current?.contains(event.target);
      if (!isInsideInput && !isInsideMenu) {
        setShowAutocomplete(false);
      }
    };
    document.addEventListener('mousedown', handleClickOutside);
    return () => document.removeEventListener('mousedown', handleClickOutside);
  }, []);

  const updateAutocompletePosition = React.useCallback(() => {
    if (!autocompleteInputRef.current) {
      return;
    }
    const rect = autocompleteInputRef.current.getBoundingClientRect();
    const viewportPadding = 16;
    const availableWidth = Math.max(window.innerWidth - viewportPadding * 2, 0);
    const width = Math.min(rect.width, availableWidth);
    const left = Math.min(
      Math.max(rect.left, viewportPadding),
      window.innerWidth - width - viewportPadding
    );
    setAutocompleteStyles({
      position: 'fixed',
      top: rect.bottom + 6,
      left,
      width,
      zIndex: 10000,
    });
  }, []);

  React.useLayoutEffect(() => {
    if (!showAutocomplete || autocompleteSuggestions.length === 0) {
      return undefined;
    }
    updateAutocompletePosition();
    const handleReposition = () => updateAutocompletePosition();
    window.addEventListener('resize', handleReposition);
    window.addEventListener('scroll', handleReposition, true);
    return () => {
      window.removeEventListener('resize', handleReposition);
      window.removeEventListener('scroll', handleReposition, true);
    };
  }, [showAutocomplete, autocompleteSuggestions.length, updateAutocompletePosition]);

  const addTest = () => {
    if (newTest.name && newTest.score) {
      const score = parseInt(newTest.score);
      if (score >= 40 && score <= 160) {
        const newId = Date.now();
        setTests([...tests, { ...newTest, score, id: newId }]);
        setVisibleTestIds(prev => new Set([...prev, newId]));
        const nextColorIndex = (tests.length + 1) % PRESET_COLORS.length;
        setNewTest({ name: '', score: '', color: PRESET_COLORS[nextColorIndex].value });
      }
    }
  };

  const removeTest = (id) => {
    setTests(tests.filter(t => t.id !== id));
    setVisibleTestIds(prev => {
      const newSet = new Set(prev);
      newSet.delete(id);
      return newSet;
    });
  };

  const startEditingTest = (test) => {
    setEditingTestId(test.id);
    setEditingTest({ ...test });
  };

  const cancelEditingTest = () => {
    setEditingTestId(null);
    setEditingTest(null);
  };

  const saveEditedTest = () => {
    if (editingTest && editingTest.name && editingTest.score) {
      const score = parseInt(editingTest.score);
      if (score >= 40 && score <= 160) {
        setTests(tests.map(t => t.id === editingTestId ? { ...editingTest, score } : t));
        setEditingTestId(null);
        setEditingTest(null);
      }
    }
  };

  const toggleTestVisibility = (id) => {
    setVisibleTestIds(prev => {
      const newSet = new Set(prev);
      if (newSet.has(id)) {
        newSet.delete(id);
      } else {
        newSet.add(id);
      }
      return newSet;
    });
  };

  const showAllTests = () => {
    setVisibleTestIds(new Set(tests.map(t => t.id)));
  };

  const hideAllTests = () => {
    setVisibleTestIds(new Set());
  };

  // Chart dimensions with proper padding for the curve peak
  const chartTopPadding = 80;
  const chartBottomY = 300;

  // Generate bell curve path
  const generateBellCurve = () => {
    const points = [];
    const width = 800;
    const mean = 100;
    const stdDev = 15;
    
    for (let x = 0; x <= width; x += 2) {
      const score = 40 + (x / width) * 120;
      const z = (score - mean) / stdDev;
      const y = Math.exp(-0.5 * z * z) / (stdDev * Math.sqrt(2 * Math.PI));
      const scaledY = chartBottomY - (y * stdDev * (chartBottomY - chartTopPadding) * 2.5);
      points.push(`${x},${scaledY}`);
    }
    
    return `M ${points.join(' L ')} L 800,${chartBottomY} L 0,${chartBottomY} Z`;
  };

  const getScoreX = (score) => {
    return ((score - 40) / 120) * 800;
  };

  const getScoreY = (score) => {
    const mean = 100;
    const stdDev = 15;
    const z = (score - mean) / stdDev;
    const y = Math.exp(-0.5 * z * z) / (stdDev * Math.sqrt(2 * Math.PI));
    return chartBottomY - (y * stdDev * (chartBottomY - chartTopPadding) * 2.5);
  };

  const bellPath = React.useMemo(() => generateBellCurve(), []);

  // Generate average range area (85-115)
  const generateAverageArea = () => {
    const points = [];
    const mean = 100;
    const stdDev = 15;
    
    const startX = getScoreX(85);
    const endX = getScoreX(115);
    
    for (let x = startX; x <= endX; x += 2) {
      const score = 40 + (x / 800) * 120;
      const z = (score - mean) / stdDev;
      const y = Math.exp(-0.5 * z * z) / (stdDev * Math.sqrt(2 * Math.PI));
      const scaledY = chartBottomY - (y * stdDev * (chartBottomY - chartTopPadding) * 2.5);
      points.push(`${x},${scaledY}`);
    }
    
    return `M ${startX},${chartBottomY} L ${points.join(' L ')} L ${endX},${chartBottomY} Z`;
  };

  const averageAreaPath = React.useMemo(() => generateAverageArea(), []);

  const getScoreDescription = (score) => {
    if (score < 70) return 'Very Low';
    if (score < 85) return 'Low';
    if (score < 115) return 'Average';
    if (score < 130) return 'High';
    return 'Very High';
  };

  // Calculate percentile rank from standard score
  const getPercentileRank = (score) => {
    const mean = 100;
    const stdDev = 15;
    const z = (score - mean) / stdDev;

    // Approximation of cumulative normal distribution
    const t = 1 / (1 + 0.2316419 * Math.abs(z));
    const d = 0.3989423 * Math.exp(-z * z / 2);
    const probability = d * t * (0.3193815 + t * (-0.3565638 + t * (1.781478 + t * (-1.821256 + t * 1.330274))));

    let percentile;
    if (z >= 0) {
      percentile = (1 - probability) * 100;
    } else {
      percentile = probability * 100;
    }

    // Round to appropriate precision
    if (percentile >= 99) return '>99';
    if (percentile < 1) return '<1';
    return Math.round(percentile).toString();
  };

  // Format percentile with proper ordinal suffix (1st, 2nd, 3rd, etc.)
  const formatPercentile = (percentileStr) => {
    if (percentileStr === '>99' || percentileStr === '<1') return percentileStr;

    const num = parseInt(percentileStr);
    const lastDigit = num % 10;
    const lastTwoDigits = num % 100;

    // Special cases: 11th, 12th, 13th
    if (lastTwoDigits >= 11 && lastTwoDigits <= 13) {
      return num + 'th';
    }

    // Regular cases
    if (lastDigit === 1) return num + 'st';
    if (lastDigit === 2) return num + 'nd';
    if (lastDigit === 3) return num + 'rd';
    return num + 'th';
  };

  // Generate comprehensive assessment summary
  const generateSummary = () => {
    if (tests.length === 0) return '';

    const sortedTests = [...tests].sort((a, b) => b.score - a.score);

    // Categorize scores
    const veryHigh = tests.filter(t => t.score >= 130);
    const high = tests.filter(t => t.score >= 115 && t.score < 130);
    const average = tests.filter(t => t.score >= 85 && t.score < 115);
    const low = tests.filter(t => t.score >= 70 && t.score < 85);
    const veryLow = tests.filter(t => t.score < 70);

    let summary = [];

    // Strengths
    if (veryHigh.length > 0 || high.length > 0) {
      const strengths = [...veryHigh, ...high];
      summary.push(`${studentName || 'The student'} demonstrates notable strengths in ${strengths.map(t => `${t.name} (${t.score}, ${formatPercentile(getPercentileRank(t.score))} percentile)`).join(', ')}.`);
    }

    // Average performance areas
    if (average.length > 0) {
      summary.push(`Performance in the average range was noted for ${average.map(t => t.name).join(', ')}, indicating age-appropriate development in these areas.`);
    }

    // Areas of concern
    if (low.length > 0 || veryLow.length > 0) {
      const concerns = [...low, ...veryLow];
      summary.push(`Areas that may benefit from additional support include ${concerns.map(t => `${t.name} (${t.score}, ${formatPercentile(getPercentileRank(t.score))} percentile)`).join(', ')}.`);
    }

    // Score variability
    const highest = sortedTests[0];
    const lowest = sortedTests[sortedTests.length - 1];
    const range = highest.score - lowest.score;

    if (range >= 30) {
      summary.push(`There is significant variability in performance across assessed areas, with scores ranging from ${lowest.score} (${lowest.name}) to ${highest.score} (${highest.name}). This ${range}-point difference suggests an uneven cognitive profile with distinct strengths and weaknesses.`);
    } else if (range >= 15) {
      summary.push(`Performance shows moderate variability across assessed areas, with scores ranging from ${lowest.score} to ${highest.score}.`);
    } else {
      summary.push(`Performance is relatively consistent across assessed areas, with scores ranging from ${lowest.score} to ${highest.score}.`);
    }

    // Recommendations
    summary.push(`These results should be interpreted in the context of ${studentName || 'the student'}'s educational history, behavioral observations, and other relevant information. Follow-up discussions with the educational team are recommended to develop appropriate interventions and support strategies.`);

    return summary.join(' ');
  };

  // Get visible tests based on selection
  const getVisibleTests = () => {
    return tests.filter(t => visibleTestIds.has(t.id));
  };

  // Calculate stacked positions for overlapping scores
  const getStackedPositions = (visibleTests) => {
    const markerRadius = 18;
    const stackGap = 8;
    const proximityThreshold = 5; // scores within 5 points are considered "close"
    
    // Sort by score
    const sorted = [...visibleTests].sort((a, b) => a.score - b.score);
    
    // Group tests by proximity
    const groups = [];
    let currentGroup = [];
    
    sorted.forEach((test, index) => {
      if (currentGroup.length === 0) {
        currentGroup.push(test);
      } else {
        const lastTest = currentGroup[currentGroup.length - 1];
        if (Math.abs(test.score - lastTest.score) <= proximityThreshold) {
          currentGroup.push(test);
        } else {
          groups.push([...currentGroup]);
          currentGroup = [test];
        }
      }
    });
    if (currentGroup.length > 0) {
      groups.push(currentGroup);
    }
    
    // Calculate positions with stacking
    const positions = [];
    
    groups.forEach(group => {
      // Find the average score position for the group
      const avgScore = group.reduce((sum, t) => sum + t.score, 0) / group.length;
      const baseX = getScoreX(avgScore);
      const baseY = getScoreY(avgScore);
      
      group.forEach((test, stackIndex) => {
        const x = getScoreX(test.score);
        const y = baseY - (stackIndex * (markerRadius * 2 + stackGap));
        positions.push({
          test,
          x,
          y,
          baseY, // For the vertical line
          isStacked: group.length > 1,
          stackIndex,
        });
      });
    });
    
    return positions;
  };

  // Group tests by exact score for cluster markers
  const groupTestsByScore = (visibleTests) => {
    const groups = new Map();
    visibleTests.forEach(test => {
      const score = test.score;
      if (!groups.has(score)) {
        groups.set(score, []);
      }
      groups.get(score).push(test);
    });
    return groups;
  };

  // Get the focused test (activeTestId takes precedence over hoveredTestId)
  const getFocusedTest = () => {
    const visibleTests = getVisibleTests();
    if (activeTestId) {
      const test = visibleTests.find(t => t.id === activeTestId);
      if (test) return test;
    }
    if (hoveredTestId) {
      const test = visibleTests.find(t => t.id === hoveredTestId);
      if (test) return test;
    }
    // Default to first visible test
    return visibleTests.length > 0 ? visibleTests[0] : null;
  };

  const focusedTest = getFocusedTest();
  const focusedTestId = focusedTest?.id || null;

  // Auto-scroll sidebar when focused test changes from chart interaction
  React.useEffect(() => {
    const testIdToScroll = activeTestId || hoveredTestId;
    if (testIdToScroll && sidebarRowRefs.current[testIdToScroll]) {
      sidebarRowRefs.current[testIdToScroll].scrollIntoView({
        behavior: 'smooth',
        block: 'nearest',
      });
    }
  }, [activeTestId, hoveredTestId]);

  // Close cluster popover on outside click or Escape
  React.useEffect(() => {
    const handleKeyDown = (e) => {
      if (e.key === 'Escape') {
        setOpenClusterId(null);
      }
    };
    const handleClickOutside = (e) => {
      // Check if click is outside the cluster popover
      if (openClusterId && !e.target.closest('.cluster-popover') && !e.target.closest('.cluster-marker')) {
        setOpenClusterId(null);
      }
    };
    document.addEventListener('keydown', handleKeyDown);
    document.addEventListener('mousedown', handleClickOutside);
    return () => {
      document.removeEventListener('keydown', handleKeyDown);
      document.removeEventListener('mousedown', handleClickOutside);
    };
  }, [openClusterId]);

  const computedSummary = summaryOverride.trim() ? summaryOverride : generateSummary();

  return (
    <div
      className={printMode ? 'print-mode' : ''}
      style={{
        minHeight: '100vh',
        background: printMode
          ? '#ffffff'
          : themeColors.background,
        fontFamily: "'Nunito', 'Segoe UI', sans-serif",
        color: printMode ? '#1a1a2e' : themeColors.text,
        padding: '0',
      }}
    >
      <style>{`
        @import url('https://fonts.googleapis.com/css2?family=Nunito:wght@400;600;700;800&family=Playfair+Display:wght@600;700&display=swap');

        /* Theme CSS Variables */
        :root {
          --bg: linear-gradient(135deg, #f7f9fd 0%, #e6edf8 100%);
          --surface: #ffffff;
          --surface-2: #f2f5fb;
          --text: #1b1f2e;
          --text-muted: #3b455c;
          --text-subtle: #5b657a;
          --border: #d2d8e5;
          --shadow: 0 20px 60px rgba(27, 31, 46, 0.14);
          --primary: #5b6eea;
          --primary-contrast: #ffffff;
          --input-bg: #ffffff;
          --input-text: #1b1f2e;
          --input-placeholder: #6f798f;
          --chip-bg: rgba(91, 110, 234, 0.12);
          --chip-text: #3647a8;
          --header-bg: #f4f7fc;
          --header-border: #d2d8e5;
          --title-gradient: linear-gradient(135deg, #1f2a52 0%, #4b5ec2 100%);
          --info-bg: linear-gradient(135deg, rgba(91, 110, 234, 0.12) 0%, rgba(118, 75, 162, 0.12) 100%);
          --info-border: rgba(91, 110, 234, 0.35);
          --chart-grid: rgba(27, 31, 46, 0.18);
          --chart-label: #2c344b;
          --chart-label-muted: #4b556b;
          --chart-label-subtle: #6c7489;
          --chart-average: rgba(27, 31, 46, 0.08);
          --chart-bell-fill: rgba(91, 110, 234, 0.15);

          --ui-btn-inactive-bg: rgba(27, 31, 46, 0.08);
          --ui-btn-inactive-text: var(--text-muted);
          --ui-btn-inactive-hover-bg: rgba(27, 31, 46, 0.14);
          --ui-btn-inactive-hover-text: var(--text);
          --ui-card-bg: var(--surface);
          --ui-card-hover-bg: var(--surface-2);
          --ui-card-border: var(--border);
          --ui-input-bg: var(--input-bg);
          --ui-input-border: var(--border);
          --ui-input-focus-bg: #eef2ff;
          --ui-input-text: var(--input-text);
          --ui-input-placeholder: var(--input-placeholder);
          --ui-control-bg: var(--surface-2);
          --ui-control-hover-bg: #e4e9f6;
          --ui-control-text: var(--text);
          --ui-control-hover-text: var(--text);
          --ui-checkbox-border: #b8c1d6;
          --ui-chart-bg: var(--surface);
          --ui-swatch-border: rgba(27, 31, 46, 0.4);
          --ui-swatch-shadow: rgba(27, 31, 46, 0.2);
          --ui-dropdown-bg: #ffffff;
          --ui-dropdown-item-hover: #f2f5fb;
        }

        [data-theme="dark"] {
          --bg: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
          --surface: rgba(255, 255, 255, 0.04);
          --surface-2: rgba(255, 255, 255, 0.06);
          --text: #f8f9fa;
          --text-muted: rgba(255, 255, 255, 0.85);
          --text-subtle: rgba(255, 255, 255, 0.5);
          --border: rgba(255, 255, 255, 0.08);
          --shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
          --primary: #667eea;
          --primary-contrast: #ffffff;
          --input-bg: rgba(255, 255, 255, 0.05);
          --input-text: #f8f9fa;
          --input-placeholder: rgba(255, 255, 255, 0.4);
          --chip-bg: rgba(102, 126, 234, 0.2);
          --chip-text: #f8f9fa;
          --header-bg: rgba(0, 0, 0, 0.2);
          --header-border: rgba(255, 255, 255, 0.08);
          --title-gradient: linear-gradient(135deg, #f8f9fa 0%, #c8d6e5 100%);
          --info-bg: linear-gradient(135deg, rgba(102, 126, 234, 0.15) 0%, rgba(118, 75, 162, 0.15) 100%);
          --info-border: rgba(102, 126, 234, 0.3);
          --chart-grid: rgba(255, 255, 255, 0.1);
          --chart-label: rgba(255, 255, 255, 0.8);
          --chart-label-muted: rgba(255, 255, 255, 0.5);
          --chart-label-subtle: rgba(255, 255, 255, 0.4);
          --chart-average: rgba(0, 0, 0, 0.25);
          --chart-bell-fill: rgba(102, 126, 234, 0.15);

          --ui-btn-inactive-bg: rgba(255, 255, 255, 0.08);
          --ui-btn-inactive-text: rgba(255, 255, 255, 0.6);
          --ui-btn-inactive-hover-bg: rgba(255, 255, 255, 0.15);
          --ui-btn-inactive-hover-text: rgba(255, 255, 255, 0.9);
          --ui-card-bg: rgba(255, 255, 255, 0.04);
          --ui-card-hover-bg: rgba(255, 255, 255, 0.08);
          --ui-card-border: rgba(255, 255, 255, 0.1);
          --ui-input-bg: rgba(255, 255, 255, 0.05);
          --ui-input-border: rgba(255, 255, 255, 0.1);
          --ui-input-focus-bg: rgba(255, 255, 255, 0.1);
          --ui-input-text: #f8f9fa;
          --ui-input-placeholder: rgba(255, 255, 255, 0.4);
          --ui-control-bg: rgba(255, 255, 255, 0.1);
          --ui-control-hover-bg: rgba(255, 255, 255, 0.2);
          --ui-control-text: rgba(255, 255, 255, 0.8);
          --ui-control-hover-text: white;
          --ui-checkbox-border: rgba(255, 255, 255, 0.3);
          --ui-chart-bg: rgba(255, 255, 255, 0.02);
          --ui-swatch-border: white;
          --ui-swatch-shadow: rgba(255, 255, 255, 0.5);
          --ui-dropdown-bg: #2a2a4a;
          --ui-dropdown-item-hover: #3a3a5a;
        }

        * {
          box-sizing: border-box;
        }

        .mode-btn {
          padding: 14px 32px;
          border: none;
          border-radius: 12px;
          font-size: 15px;
          font-weight: 700;
          cursor: pointer;
          transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
          font-family: 'Nunito', sans-serif;
          text-transform: uppercase;
          letter-spacing: 1px;
        }

        .mode-btn.active {
          background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
          color: white;
          box-shadow: 0 8px 30px rgba(102, 126, 234, 0.4);
          transform: translateY(-2px);
        }

        .mode-btn.inactive {
          background: var(--ui-btn-inactive-bg);
          color: var(--ui-btn-inactive-text);
          backdrop-filter: blur(10px);
        }

        .mode-btn.inactive:hover {
          background: var(--ui-btn-inactive-hover-bg);
          color: var(--ui-btn-inactive-hover-text);
        }
        
        .input-field {
          padding: 14px 18px;
          border: 2px solid var(--ui-input-border);
          border-radius: 12px;
          font-size: 15px;
          background: var(--ui-input-bg);
          color: var(--ui-input-text);
          font-family: 'Nunito', sans-serif;
          transition: all 0.3s ease;
          backdrop-filter: blur(10px);
        }

        .input-field:focus {
          outline: none;
          border-color: #667eea;
          background: var(--ui-input-focus-bg);
          box-shadow: 0 0 20px rgba(102, 126, 234, 0.2);
        }

        .input-field::placeholder {
          color: var(--ui-input-placeholder);
        }
        
        .add-btn {
          padding: 14px 28px;
          background: linear-gradient(135deg, #00b894 0%, #00cec9 100%);
          border: none;
          border-radius: 12px;
          color: white;
          font-size: 15px;
          font-weight: 700;
          cursor: pointer;
          transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
          font-family: 'Nunito', sans-serif;
          text-transform: uppercase;
          letter-spacing: 1px;
        }
        
        .add-btn:hover {
          transform: translateY(-3px);
          box-shadow: 0 10px 30px rgba(0, 184, 148, 0.4);
        }
        
        .add-btn:disabled {
          opacity: 0.5;
          cursor: not-allowed;
          transform: none;
        }
        
        .test-card {
          background: var(--ui-card-bg);
          border-radius: 16px;
          padding: 18px 22px;
          display: flex;
          align-items: center;
          gap: 16px;
          backdrop-filter: blur(10px);
          border: 1px solid var(--ui-card-border);
          transition: all 0.3s ease;
          animation: slideIn 0.4s ease-out;
        }

        @keyframes slideIn {
          from {
            opacity: 0;
            transform: translateX(-20px);
          }
          to {
            opacity: 1;
            transform: translateX(0);
          }
        }

        .test-card:hover {
          background: var(--ui-card-hover-bg);
          border-color: var(--ui-card-border);
        }
        
        .remove-btn {
          background: rgba(255, 107, 107, 0.2);
          border: none;
          border-radius: 8px;
          color: #ff6b6b;
          cursor: pointer;
          padding: 8px 12px;
          font-size: 13px;
          font-weight: 600;
          transition: all 0.3s ease;
          font-family: 'Nunito', sans-serif;
        }
        
        .remove-btn:hover {
          background: rgba(255, 107, 107, 0.4);
          transform: scale(1.05);
        }
        
        .color-picker {
          display: flex;
          gap: 8px;
          flex-wrap: wrap;
        }
        
        .color-swatch {
          width: 32px;
          height: 32px;
          border-radius: 8px;
          cursor: pointer;
          transition: all 0.2s ease;
          border: 3px solid transparent;
        }
        
        .color-swatch:hover {
          transform: scale(1.15);
        }
        
        .color-swatch.selected {
          border-color: var(--ui-swatch-border);
          box-shadow: 0 0 15px var(--ui-swatch-shadow);
        }

        .legend-item {
          display: flex;
          align-items: center;
          gap: 12px;
          padding: 12px 18px;
          background: var(--ui-card-bg);
          border-radius: 12px;
          backdrop-filter: blur(10px);
          border: 1px solid var(--ui-card-border);
        }
        
        .score-marker {
          transition: all 0.2s ease;
          cursor: pointer;
        }
        
        .presentation-header {
          text-align: center;
          margin-bottom: 40px;
        }
        
        .chart-container {
          background: var(--ui-chart-bg);
          border-radius: 24px;
          padding: 40px;
          backdrop-filter: blur(20px);
          border: 1px solid var(--ui-card-border);
          box-shadow: var(--shadow);
        }
        
        .info-panel {
          background: var(--info-bg);
          border-radius: 16px;
          padding: 24px;
          border: 1px solid var(--info-border);
          margin-top: 20px;
        }
        
        .checkbox-card {
          display: flex;
          align-items: center;
          gap: 14px;
          padding: 16px 20px;
          background: var(--ui-card-bg);
          border-radius: 12px;
          cursor: pointer;
          transition: all 0.2s ease;
          border: 2px solid transparent;
          user-select: none;
        }

        .checkbox-card:hover {
          background: var(--ui-card-hover-bg);
        }

        .checkbox-card.checked {
          border-color: currentColor;
          background: var(--ui-card-bg);
        }

        .custom-checkbox {
          width: 24px;
          height: 24px;
          border-radius: 6px;
          border: 2px solid var(--ui-checkbox-border);
          display: flex;
          align-items: center;
          justify-content: center;
          transition: all 0.2s ease;
          flex-shrink: 0;
        }
        
        .custom-checkbox.checked {
          border-color: currentColor;
          background: currentColor;
        }
        
        .checkmark {
          color: var(--text);
          font-size: 14px;
          font-weight: 800;
        }
        
        .control-btn {
          padding: 10px 18px;
          border: none;
          border-radius: 8px;
          font-size: 13px;
          font-weight: 600;
          cursor: pointer;
          transition: all 0.2s ease;
          font-family: 'Nunito', sans-serif;
          background: var(--ui-control-bg);
          color: var(--ui-control-text);
        }

        .control-btn:hover {
          background: var(--ui-control-hover-bg);
          color: var(--ui-control-hover-text);
        }
        
        .tooltip {
          pointer-events: none;
          transition: opacity 0.2s ease;
        }

        /* Print mode toolbar */
        .print-toolbar {
          position: sticky;
          top: 0;
          z-index: 1000;
          display: flex;
          align-items: center;
          justify-content: space-between;
          padding: 12px 32px;
          background: #1a1a2e;
          color: white;
          box-shadow: 0 2px 12px rgba(0,0,0,0.2);
        }
        .print-toolbar button {
          padding: 8px 20px;
          border-radius: 8px;
          border: none;
          cursor: pointer;
          font-family: 'Nunito', sans-serif;
          font-weight: 700;
          font-size: 14px;
          transition: all 0.15s ease;
        }
        .print-toolbar .btn-back {
          background: rgba(255,255,255,0.15);
          color: white;
        }
        .print-toolbar .btn-back:hover {
          background: rgba(255,255,255,0.25);
        }
        .print-toolbar .btn-print {
          background: #667eea;
          color: white;
        }
        .print-toolbar .btn-print:hover {
          background: #5569d9;
        }

        /* Report print view */
        .report-view {
          max-width: 900px;
          margin: 0 auto;
          padding: 40px 32px;
          background: white;
          color: #1a1a2e;
        }
        .report-header {
          text-align: center;
          border-bottom: 3px solid #667eea;
          padding-bottom: 24px;
          margin-bottom: 32px;
        }
        .report-header h1 {
          margin: 0 0 8px 0;
          font-size: 28px;
          font-weight: 700;
          color: #1a1a2e;
        }
        .report-header .subtitle {
          font-size: 15px;
          color: #5b657a;
          margin: 0;
        }
        .report-summary-grid {
          display: grid;
          grid-template-columns: 1fr 300px;
          gap: 32px;
          margin-bottom: 32px;
        }
        .report-chart-box {
          border: 1px solid #d2d8e5;
          border-radius: 12px;
          padding: 20px;
          background: #fafbfd;
        }
        .report-legend-box {
          border: 1px solid #d2d8e5;
          border-radius: 12px;
          padding: 16px;
          background: #fafbfd;
        }
        .report-legend-row {
          display: flex;
          align-items: center;
          gap: 8px;
          padding: 6px 0;
          border-bottom: 1px solid #eef0f5;
          font-size: 13px;
        }
        .report-legend-row:last-child {
          border-bottom: none;
        }

        /* Results table */
        .results-table {
          width: 100%;
          border-collapse: collapse;
          font-size: 13px;
          margin-top: 8px;
        }
        .results-table thead th {
          background: #f2f5fb;
          border: 1px solid #d2d8e5;
          padding: 10px 14px;
          text-align: left;
          font-weight: 700;
          color: #1b1f2e;
          font-size: 12px;
          text-transform: uppercase;
          letter-spacing: 0.5px;
        }
        .results-table tbody td {
          border: 1px solid #d2d8e5;
          padding: 10px 14px;
          color: #1b1f2e;
        }
        .results-table tbody tr:nth-child(even) {
          background: #f9fafb;
        }

        /* Print Styles for PDF Export */
        @media print {
          body {
            background: white !important;
          }
          .no-print, .print-toolbar {
            display: none !important;
          }
          .print-only {
            display: block !important;
          }
          .report-view {
            padding: 0;
            max-width: 100%;
          }
          .report-chart-box, .report-legend-box {
            border: 1px solid #bbb !important;
            background: white !important;
            box-shadow: none !important;
          }
          .results-table thead {
            display: table-header-group;
          }
          .results-table tbody tr {
            page-break-inside: avoid;
            break-inside: avoid;
          }
          .chart-container {
            box-shadow: none !important;
            border: 1px solid #bbb !important;
            background: white !important;
            break-inside: avoid;
            page-break-inside: avoid;
          }
          .presentation-header {
            border-bottom: 2px solid #667eea;
            padding-bottom: 20px;
            margin-bottom: 30px;
            color: #1a1a2e !important;
          }
          .presentation-header h2 {
            color: #1a1a2e !important;
          }
          svg path[d*="M"] {
            stroke-width: 3 !important;
          }
          .report-summary-grid {
            break-inside: avoid;
            page-break-inside: avoid;
          }
          .page-break-before {
            page-break-before: always;
            break-before: page;
          }
          /* Ensure colors are visible in print */
          * {
            -webkit-print-color-adjust: exact !important;
            print-color-adjust: exact !important;
            color-adjust: exact !important;
          }
          @page {
            margin: 0.6in;
            size: letter;
          }
        }

        .print-only {
          display: none;
        }

        .profile-card {
          background: var(--surface);
          border-radius: 12px;
          padding: 16px;
          cursor: pointer;
          transition: all 0.2s ease;
          border: 1px solid var(--border);
        }

        .profile-card:hover {
          background: var(--surface-2);
          border-color: var(--border);
          transform: translateY(-2px);
        }

        .delete-profile-btn {
          background: rgba(255, 107, 107, 0.2);
          border: none;
          border-radius: 6px;
          color: #ff6b6b;
          cursor: pointer;
          padding: 6px 10px;
          font-size: 12px;
          font-weight: 600;
          transition: all 0.2s ease;
        }

        .delete-profile-btn:hover {
          background: rgba(255, 107, 107, 0.4);
        }

        .print-header {
          display: flex;
          justify-content: space-between;
          align-items: center;
          margin-bottom: 30px;
          padding-bottom: 20px;
          border-bottom: 3px solid #667eea;
        }

        .print-logo {
          max-width: 150px;
          max-height: 80px;
          object-fit: contain;
        }

        .print-footer {
          margin-top: 40px;
          padding-top: 20px;
          border-top: 2px solid #eee;
          text-align: center;
          font-size: 12px;
          color: #666;
        }
      `}</style>

      {/* Header - hidden in print mode */}
      {!printMode && <div style={{
        padding: '30px 40px',
        borderBottom: '1px solid var(--header-border)',
        display: 'flex',
        justifyContent: 'space-between',
        alignItems: 'center',
        background: 'var(--header-bg)',
        backdropFilter: 'blur(20px)',
      }}>
        <div>
          <h1 style={{
            fontFamily: "'Playfair Display', serif",
            fontSize: '32px',
            fontWeight: 700,
            margin: 0,
            background: 'var(--title-gradient)',
            WebkitBackgroundClip: 'text',
            WebkitTextFillColor: 'transparent',
            letterSpacing: '-0.5px',
          }}>
            Score Distribution Visualizer
          </h1>
          <p style={{
            margin: '8px 0 0 0',
            color: themeColors.textMuted,
            fontSize: '14px',
            fontWeight: 600,
            letterSpacing: '2px',
            textTransform: 'uppercase',
          }}>
            Bell Curve Analysis Tool
          </p>
        </div>
        
        <div style={{ display: 'flex', gap: '12px', alignItems: 'center' }}>
          <button
            className="mode-btn inactive no-print"
            onClick={() => setShowHelpPanel(true)}
            title="View the walkthrough guide"
          >
             Help
          </button>
          <button
            className="mode-btn inactive no-print"
            onClick={() => setShowBrandingPanel(true)}
            title="Configure school branding"
          >
             Branding
          </button>
          <button
            className="mode-btn inactive no-print"
            onClick={() => setShowThemePanel(true)}
            title="Customize theme and colors"
          >
             Theme
          </button>
          <button
            className="mode-btn inactive no-print"
            onClick={() => setShowProfilesPanel(true)}
            title="Manage student profiles"
          >
             Profiles
          </button>
          <button
            className={`mode-btn ${mode === 'input' ? 'active' : 'inactive'} no-print`}
            onClick={() => setMode('input')}
          >
             Input Mode
          </button>
          <button
            className={`mode-btn ${mode === 'presentation' ? 'active' : 'inactive'} no-print`}
            onClick={() => setMode('presentation')}
          >
             Presentation
          </button>
          {mode === 'presentation' && tests.length > 0 && !printMode && (
            <button
              className="mode-btn inactive no-print"
              onClick={() => setPrintMode(true)}
              title="Print preview"
            >
               Print Preview
            </button>
          )}
        </div>
      </div>}

      {/* Branding Configuration Panel */}
      {showBrandingPanel && (
        <div style={{
          position: 'fixed',
          top: 0,
          left: 0,
          right: 0,
          bottom: 0,
          background: 'rgba(0, 0, 0, 0.8)',
          backdropFilter: 'blur(10px)',
          display: 'flex',
          alignItems: 'center',
          justifyContent: 'center',
          zIndex: 1000,
          padding: '20px',
        }} className="no-print">
          <div style={{
            background: themeColors.cardBg,
            borderRadius: '24px',
            padding: '40px',
            maxWidth: '600px',
            width: '100%',
            border: `1px solid ${themeColors.cardBorder}`,
            maxHeight: '80vh',
            overflowY: 'auto',
            boxShadow: 'var(--shadow)',
          }}>
            <h2 style={{
              margin: '0 0 30px 0',
              fontSize: '28px',
              fontWeight: 700,
              color: themeColors.text,
            }}>
               Custom Branding
            </h2>

            <div style={{ display: 'flex', flexDirection: 'column', gap: '24px' }}>
              <div>
                <label style={{
                  display: 'block',
                  marginBottom: '8px',
                  fontSize: '14px',
                  fontWeight: 600,
                  color: themeColors.textSecondary,
                }}>
                  School Name
                </label>
                <input
                  type="text"
                  value={branding.schoolName}
                  onChange={(e) => setBranding({ ...branding, schoolName: e.target.value })}
                  className="input-field"
                  placeholder="Enter school name"
                  style={{ width: '100%' }}
                />
              </div>

              <div>
                <label style={{
                  display: 'block',
                  marginBottom: '8px',
                  fontSize: '14px',
                  fontWeight: 600,
                  color: themeColors.textSecondary,
                }}>
                  School Logo
                </label>
                <input
                  type="file"
                  accept="image/*"
                  onChange={handleLogoUpload}
                  className="input-field"
                  style={{ width: '100%' }}
                />
                {branding.schoolLogo && (
                  <div style={{ marginTop: '12px', textAlign: 'center' }}>
                    <img
                      src={branding.schoolLogo}
                      alt="School Logo Preview"
                      style={{
                        maxWidth: '200px',
                        maxHeight: '100px',
                        objectFit: 'contain',
                        border: `2px solid ${themeColors.cardBorder}`,
                        borderRadius: '8px',
                        padding: '10px',
                        background: 'var(--surface-2)',
                      }}
                    />
                  </div>
                )}
              </div>

              <div>
                <label style={{
                  display: 'block',
                  marginBottom: '8px',
                  fontSize: '14px',
                  fontWeight: 600,
                  color: themeColors.textSecondary,
                }}>
                  Primary Color
                </label>
                <input
                  type="color"
                  value={branding.primaryColor}
                  onChange={(e) => setBranding({ ...branding, primaryColor: e.target.value })}
                  style={{
                    width: '100%',
                    height: '50px',
                    border: `2px solid ${themeColors.cardBorder}`,
                    borderRadius: '12px',
                    cursor: 'pointer',
                    background: 'var(--surface-2)',
                  }}
                />
              </div>

              <div>
                <label style={{
                  display: 'block',
                  marginBottom: '8px',
                  fontSize: '14px',
                  fontWeight: 600,
                  color: themeColors.textSecondary,
                }}>
                  Report Footer Text
                </label>
                <textarea
                  value={branding.footerText}
                  onChange={(e) => setBranding({ ...branding, footerText: e.target.value })}
                  className="input-field"
                  placeholder="Optional footer text for printed reports"
                  style={{ width: '100%', minHeight: '80px', resize: 'vertical' }}
                />
              </div>
            </div>

            <div style={{ display: 'flex', gap: '12px', marginTop: '30px' }}>
              <button
                className="add-btn"
                onClick={() => setShowBrandingPanel(false)}
                style={{ flex: 1 }}
              >
                Save & Close
              </button>
              <button
                className="control-btn"
                onClick={() => setShowBrandingPanel(false)}
                style={{ padding: '14px 28px' }}
              >
                Cancel
              </button>
            </div>
          </div>
        </div>
      )}

      {/* Theme Customization Panel */}
      {showThemePanel && (
        <div style={{
          position: 'fixed',
          top: 0,
          left: 0,
          right: 0,
          bottom: 0,
          background: 'rgba(0, 0, 0, 0.8)',
          backdropFilter: 'blur(10px)',
          display: 'flex',
          alignItems: 'center',
          justifyContent: 'center',
          zIndex: 1000,
          padding: '20px',
        }} className="no-print">
          <div style={{
            background: themeColors.panelBg,
            borderRadius: '24px',
            padding: '40px',
            maxWidth: '600px',
            width: '100%',
            border: `1px solid ${themeColors.cardBorder}`,
            maxHeight: '80vh',
            overflowY: 'auto',
          }}>
            <h2 style={{
              margin: '0 0 30px 0',
              fontSize: '28px',
              fontWeight: 700,
              color: themeColors.text,
            }}>
               Theme Customization
            </h2>

            <div style={{ display: 'flex', flexDirection: 'column', gap: '32px' }}>
              {/* Theme Mode Selection */}
              <div>
                <label style={{
                  display: 'block',
                  marginBottom: '16px',
                  fontSize: '14px',
                  fontWeight: 600,
                  color: themeColors.textSecondary,
                  textTransform: 'uppercase',
                  letterSpacing: '1px',
                }}>
                  Display Mode
                </label>
                <div style={{ display: 'flex', gap: '12px' }}>
                  <button
                    className={theme === 'dark' ? 'add-btn' : 'control-btn'}
                    onClick={() => setTheme('dark')}
                    style={{ flex: 1, padding: '16px' }}
                  >
                     Dark Mode
                  </button>
                  <button
                    className={theme === 'light' ? 'add-btn' : 'control-btn'}
                    onClick={() => setTheme('light')}
                    style={{ flex: 1, padding: '16px' }}
                  >
                     Light Mode
                  </button>
                </div>
                <p style={{
                  marginTop: '12px',
                  fontSize: '13px',
                  color: themeColors.textMuted,
                  lineHeight: '1.6',
                }}>
                  Choose between dark and light interface themes
                </p>
              </div>

              {/* Bell Curve Color Selection */}
              <div>
                <label style={{
                  display: 'block',
                  marginBottom: '16px',
                  fontSize: '14px',
                  fontWeight: 600,
                  color: themeColors.textSecondary,
                  textTransform: 'uppercase',
                  letterSpacing: '1px',
                }}>
                  Bell Curve Color
                </label>
                <div style={{ display: 'grid', gridTemplateColumns: 'repeat(5, 1fr)', gap: '12px' }}>
                  {['#667eea', '#4ECDC4', '#FF6B6B', '#9B7EDE', '#00B894', '#E17055', '#FFE66D', '#FD79A8', '#74B9FF', '#764ba2'].map((color) => (
                    <div
                      key={color}
                      style={{
                        width: '100%',
                        aspectRatio: '1',
                        borderRadius: '12px',
                        backgroundColor: color,
                        cursor: 'pointer',
                        border: bellCurveColor === color ? '4px solid ' + themeColors.text : '2px solid ' + themeColors.cardBorder,
                        transition: 'all 0.2s ease',
                        boxShadow: bellCurveColor === color ? `0 4px 12px ${color}66` : 'none',
                      }}
                      onClick={() => setBellCurveColor(color)}
                      title={color}
                    />
                  ))}
                </div>
                <p style={{
                  marginTop: '12px',
                  fontSize: '13px',
                  color: themeColors.textMuted,
                  lineHeight: '1.6',
                }}>
                  Customize the color of the bell curve visualization
                </p>
              </div>

              {/* Preview */}
              <div style={{
                background: themeColors.cardBg,
                border: `1px solid ${themeColors.cardBorder}`,
                borderRadius: '16px',
                padding: '20px',
              }}>
                <p style={{
                  margin: '0 0 12px 0',
                  fontSize: '13px',
                  fontWeight: 600,
                  color: themeColors.textSecondary,
                  textTransform: 'uppercase',
                  letterSpacing: '1px',
                }}>
                  Preview
                </p>
                <div style={{
                  background: 'var(--surface)',
                  borderRadius: '12px',
                  padding: '16px',
                  display: 'flex',
                  alignItems: 'center',
                  justifyContent: 'center',
                }}>
                  <div style={{
                    width: '60px',
                    height: '60px',
                    borderRadius: '50%',
                    background: `linear-gradient(135deg, ${bellCurveColor} 0%, ${bellCurveColor}99 100%)`,
                    boxShadow: `0 4px 20px ${bellCurveColor}40`,
                  }} />
                </div>
              </div>
            </div>

            <div style={{ display: 'flex', gap: '12px', marginTop: '30px' }}>
              <button
                className="add-btn"
                onClick={() => setShowThemePanel(false)}
                style={{ flex: 1 }}
              >
                Save & Close
              </button>
              <button
                className="control-btn"
                onClick={() => setShowThemePanel(false)}
                style={{ padding: '14px 28px' }}
              >
                Cancel
              </button>
            </div>
          </div>
        </div>
      )}

      {/* Profiles Management Panel */}
      {showProfilesPanel && (
        <div style={{
          position: 'fixed',
          top: 0,
          left: 0,
          right: 0,
          bottom: 0,
          background: 'rgba(0, 0, 0, 0.8)',
          backdropFilter: 'blur(10px)',
          display: 'flex',
          alignItems: 'center',
          justifyContent: 'center',
          zIndex: 1000,
          padding: '20px',
        }} className="no-print">
          <div style={{
            background: themeColors.cardBg,
            borderRadius: '24px',
            padding: '40px',
            maxWidth: '700px',
            width: '100%',
            border: `1px solid ${themeColors.cardBorder}`,
            maxHeight: '80vh',
            overflowY: 'auto',
            boxShadow: 'var(--shadow)',
          }}>
            <h2 style={{
              margin: '0 0 30px 0',
              fontSize: '28px',
              fontWeight: 700,
              color: themeColors.text,
            }}>
               Student Profiles
            </h2>

            <div style={{ marginBottom: '24px' }}>
              <button
                className="add-btn"
                onClick={startNewProfile}
                style={{ width: '100%' }}
              >
                 Start New Profile
              </button>
            </div>

            <div style={{ display: 'flex', gap: '12px', marginBottom: '24px' }}>
              <button
                className="control-btn"
                onClick={handleExportProfiles}
                style={{ flex: 1, padding: '14px 18px' }}
              >
                 Export Profiles
              </button>
              <button
                className="control-btn"
                onClick={() => importInputRef.current?.click()}
                style={{ flex: 1, padding: '14px 18px' }}
              >
                 Import Profiles
              </button>
              <input
                ref={importInputRef}
                type="file"
                accept="application/json"
                onChange={handleImportProfiles}
                style={{ display: 'none' }}
              />
            </div>

            {savedProfiles.length === 0 ? (
              <div style={{
                textAlign: 'center',
                padding: '60px 20px',
                color: themeColors.textMuted,
              }}>
                <div style={{ fontSize: '48px', marginBottom: '16px' }}></div>
                <p style={{ margin: 0, fontSize: '16px' }}>
                  No saved profiles yet. Save your first student profile!
                </p>
              </div>
            ) : (
              <div style={{ display: 'flex', flexDirection: 'column', gap: '12px' }}>
                {savedProfiles.map((profile) => (
                  <div key={profile.id} className="profile-card">
                    <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'start' }}>
                      <div style={{ flex: 1 }} onClick={() => loadProfile(profile)}>
                        <div style={{ fontWeight: 700, fontSize: '18px', marginBottom: '8px', color: themeColors.text }}>
                          {profile.studentName}
                        </div>
                        <div style={{ fontSize: '13px', color: themeColors.textSecondary, marginBottom: '4px' }}>
                          Assessment: {profile.assessmentDate ? new Date(profile.assessmentDate).toLocaleDateString() : 'No date'}
                        </div>
                        <div style={{ fontSize: '13px', color: themeColors.textSecondary, marginBottom: '4px' }}>
                          Tests: {profile.tests.length}
                        </div>
                        <div style={{ fontSize: '12px', color: themeColors.textMuted }}>
                          Saved: {new Date(profile.savedAt).toLocaleDateString()} {new Date(profile.savedAt).toLocaleTimeString()}
                        </div>
                        {currentProfileId === profile.id && (
                          <div style={{
                            display: 'inline-block',
                            marginTop: '8px',
                            padding: '4px 10px',
                            background: 'rgba(0, 184, 148, 0.2)',
                            color: '#00b894',
                            borderRadius: '6px',
                            fontSize: '11px',
                            fontWeight: 700,
                            textTransform: 'uppercase',
                            letterSpacing: '0.5px',
                          }}>
                            Currently Loaded
                          </div>
                        )}
                      </div>
                      <button
                        className="delete-profile-btn"
                        onClick={(e) => {
                          e.stopPropagation();
                          deleteProfile(profile.id);
                        }}
                      >
                        Delete
                      </button>
                    </div>
                  </div>
                ))}
              </div>
            )}

            <div style={{ display: 'flex', gap: '12px', marginTop: '30px' }}>
              <button
                className="control-btn"
                onClick={() => setShowProfilesPanel(false)}
                style={{ flex: 1, padding: '14px 28px' }}
              >
                Close
              </button>
            </div>
          </div>
        </div>
      )}

      {/* Help & Walkthrough Panel */}
      {showHelpPanel && (
        <div style={{
          position: 'fixed',
          top: 0,
          left: 0,
          right: 0,
          bottom: 0,
          background: 'rgba(0, 0, 0, 0.8)',
          backdropFilter: 'blur(10px)',
          display: 'flex',
          alignItems: 'center',
          justifyContent: 'center',
          zIndex: 1000,
          padding: '20px',
        }} className="no-print">
          <div style={{
            background: themeColors.cardBg,
            borderRadius: '24px',
            padding: '40px',
            maxWidth: '700px',
            width: '100%',
            border: `1px solid ${themeColors.cardBorder}`,
            maxHeight: '80vh',
            overflowY: 'auto',
            boxShadow: 'var(--shadow)',
          }}>
            <h2 style={{
              margin: '0 0 30px 0',
              fontSize: '28px',
              fontWeight: 700,
              color: themeColors.text,
            }}>
               Quick Walkthrough
            </h2>

            <div style={{ display: 'flex', flexDirection: 'column', gap: '18px' }}>
              {HELP_STEPS.map((step, index) => (
                <div key={step.title} style={{
                  background: themeColors.inputBg,
                  borderRadius: '16px',
                  padding: '18px 20px',
                  border: `1px solid ${themeColors.cardBorder}`,
                }}>
                  <div style={{
                    fontSize: '14px',
                    fontWeight: 700,
                    color: themeColors.text,
                    marginBottom: '8px',
                    textTransform: 'uppercase',
                    letterSpacing: '1px',
                  }}>
                    {index + 1}. {step.title}
                  </div>
                  <div style={{ fontSize: '15px', color: themeColors.textSecondary }}>
                    {step.body}
                  </div>
                </div>
              ))}
            </div>

            <div style={{ display: 'flex', gap: '12px', marginTop: '30px' }}>
              <button
                className="add-btn"
                onClick={() => setShowHelpPanel(false)}
                style={{ flex: 1 }}
              >
                Got it
              </button>
              <button
                className="control-btn"
                onClick={() => setShowHelpPanel(false)}
                style={{ padding: '14px 28px' }}
              >
                Close
              </button>
            </div>
          </div>
        </div>
      )}

      <div style={{ padding: printMode ? '0' : '40px', maxWidth: printMode ? 'none' : '1400px', margin: '0 auto' }}>
        {mode === 'input' ? (
          /* INPUT MODE */
          <div style={{ display: 'grid', gridTemplateColumns: '1fr 1fr', gap: '40px' }}>
            {/* Left Panel - Form */}
            <div>
              {/* Student Info */}
              <div style={{
                background: themeColors.cardBg,
                borderRadius: '20px',
                padding: '28px',
                marginBottom: '28px',
                border: `1px solid ${themeColors.cardBorder}`,
              }}>
                <h3 style={{
                  margin: '0 0 20px 0',
                  fontSize: '18px',
                  fontWeight: 700,
                  color: themeColors.text,
                  letterSpacing: '1px',
                  textTransform: 'uppercase',
                }}>
                   Student Information
                </h3>
                <div style={{ display: 'flex', gap: '16px', marginBottom: '16px' }}>
                  <input
                    type="text"
                    placeholder="Student Name"
                    value={studentName}
                    onChange={(e) => setStudentName(e.target.value)}
                    className="input-field"
                    style={{ flex: 1 }}
                  />
                  <input
                    type="date"
                    value={assessmentDate}
                    onChange={(e) => setAssessmentDate(e.target.value)}
                    className="input-field"
                    style={{ width: '180px' }}
                  />
                </div>
                <button
                  className="add-btn"
                  onClick={saveCurrentProfile}
                  disabled={!studentName}
                  style={{ width: '100%' }}
                  title="Save this student's profile and assessments"
                >
                   Save Profile
                </button>
                {currentProfileId && (
                  <div style={{
                    marginTop: '12px',
                    padding: '8px 12px',
                    background: 'rgba(0, 184, 148, 0.18)',
                    borderRadius: '8px',
                    fontSize: '13px',
                    color: '#00b894',
                    textAlign: 'center',
                    fontWeight: 600,
                  }}>
                     Profile saved
                  </div>
                )}
              </div>

              {/* Add Test */}
              <div style={{
                background: themeColors.cardBg,
                borderRadius: '20px',
                padding: '28px',
                marginBottom: '28px',
                border: `1px solid ${themeColors.cardBorder}`,
              }}>
                <h3 style={{
                  margin: '0 0 20px 0',
                  fontSize: '18px',
                  fontWeight: 700,
                  color: themeColors.text,
                  letterSpacing: '1px',
                  textTransform: 'uppercase',
                }}>
                   Add Test Score
                </h3>
                
                <div style={{ display: 'flex', gap: '16px', marginBottom: '20px' }}>
                  <div style={{ flex: 2, position: 'relative' }} ref={autocompleteRef}>
                    <input
                      type="text"
                      placeholder="Test/Section Name"
                      value={newTest.name}
                      onChange={handleTestNameChange}
                      ref={autocompleteInputRef}
                      className="input-field"
                      style={{ width: '100%' }}
                    />
                    {showAutocomplete && autocompleteSuggestions.length > 0 && autocompleteStyles && ReactDOM.createPortal(
                      <div
                        ref={autocompleteMenuRef}
                        style={{
                          ...autocompleteStyles,
                          background: 'var(--ui-dropdown-bg)',
                          border: '1px solid var(--border)',
                          borderRadius: '12px',
                          maxHeight: '300px',
                          overflowY: 'auto',
                          boxShadow: 'var(--shadow)',
                        }}
                      >
                        {autocompleteSuggestions.map((suggestion, index) => {
                          const isParentTest = typeof suggestion === 'object' && suggestion.subtests;
                          const displayName = typeof suggestion === 'string' ? suggestion : suggestion.name;
                          const subtestCount = isParentTest ? suggestion.subtests.length : 0;

                          return (
                            <div
                              key={index}
                              onClick={() => handleSuggestionClick(suggestion)}
                              style={{
                                padding: '12px 16px',
                                cursor: 'pointer',
                                borderBottom: index < autocompleteSuggestions.length - 1 ? '1px solid var(--border)' : 'none',
                                transition: 'background 0.2s ease',
                                color: 'var(--text)',
                              }}
                              onMouseEnter={(e) => {
                                e.currentTarget.style.background = 'var(--ui-dropdown-item-hover)';
                              }}
                              onMouseLeave={(e) => {
                                e.currentTarget.style.background = 'var(--ui-dropdown-bg)';
                              }}
                            >
                              <div style={{
                                fontSize: '14px',
                                color: isParentTest ? '#4ECDC4' : 'var(--text)',
                                fontWeight: isParentTest ? 600 : 400,
                              }}>
                                {isParentTest && ' '}{displayName}
                              </div>
                              {isParentTest && (
                                <div style={{
                                  fontSize: '11px',
                                  color: 'var(--text-subtle)',
                                  marginTop: '4px',
                                  fontStyle: 'italic',
                                }}>
                                   Auto-adds {subtestCount} subtest{subtestCount !== 1 ? 's' : ''}
                                </div>
                              )}
                            </div>
                          );
                        })}
                      </div>,
                      document.body
                    )}
                  </div>
                  <input
                    type="number"
                    placeholder="Score (40-160)"
                    value={newTest.score}
                    onChange={(e) => setNewTest({ ...newTest, score: e.target.value })}
                    className="input-field"
                    style={{ flex: 1 }}
                    min="40"
                    max="160"
                  />
                </div>

                <div style={{ marginBottom: '20px' }}>
                  <label style={{
                    display: 'block',
                    marginBottom: '12px',
                    fontSize: '13px',
                    fontWeight: 600,
                    color: themeColors.textSecondary,
                    textTransform: 'uppercase',
                    letterSpacing: '1px',
                  }}>
                    Select Color
                  </label>
                  <div className="color-picker">
                    {PRESET_COLORS.map((color) => (
                      <div
                        key={color.value}
                        className={`color-swatch ${newTest.color === color.value ? 'selected' : ''}`}
                        style={{ backgroundColor: color.value }}
                        onClick={() => setNewTest({ ...newTest, color: color.value })}
                        title={color.name}
                      />
                    ))}
                    <input
                      type="color"
                      value={newTest.color}
                      onChange={(e) => setNewTest({ ...newTest, color: e.target.value })}
                      title="Custom color"
                      style={{
                        width: '32px',
                        height: '32px',
                        borderRadius: '8px',
                        border: '2px solid var(--border)',
                        cursor: 'pointer',
                        background: 'transparent',
                      }}
                    />
                  </div>
                </div>

                <button
                  className="add-btn"
                  onClick={addTest}
                  disabled={!newTest.name || !newTest.score}
                  style={{ width: '100%' }}
                >
                  Add to Chart
                </button>
              </div>

              {/* Test List */}
              <div style={{
                background: themeColors.cardBg,
                borderRadius: '20px',
                padding: '28px',
                border: `1px solid ${themeColors.cardBorder}`,
              }}>
                <h3 style={{
                  margin: '0 0 20px 0',
                  fontSize: '18px',
                  fontWeight: 700,
                  color: themeColors.text,
                  letterSpacing: '1px',
                  textTransform: 'uppercase',
                }}>
                   Added Tests ({tests.length})
                </h3>
                
                {tests.length === 0 ? (
                  <div style={{
                    textAlign: 'center',
                    padding: '40px',
                    color: themeColors.textMuted,
                    fontSize: '15px',
                  }}>
                    No tests added yet. Add your first test above!
                  </div>
                ) : (
                  <div style={{ display: 'flex', flexDirection: 'column', gap: '12px' }}>
                    {tests.map((test) => {
                      const isEditing = editingTestId === test.id;

                      return (
                        <div key={test.id} className="test-card">
                          {isEditing ? (
                            <>
                              <div style={{ flex: 1, display: 'flex', flexDirection: 'column', gap: '12px' }}>
                                <input
                                  type="text"
                                  value={editingTest.name}
                                  onChange={(e) => setEditingTest({ ...editingTest, name: e.target.value })}
                                  className="input-field"
                                  placeholder="Test name"
                                  style={{ fontSize: '14px' }}
                                />
                                <div style={{ display: 'flex', gap: '12px', alignItems: 'center' }}>
                                  <input
                                    type="number"
                                    value={editingTest.score}
                                    onChange={(e) => setEditingTest({ ...editingTest, score: e.target.value })}
                                    className="input-field"
                                    placeholder="Score"
                                    min="40"
                                    max="160"
                                    style={{ flex: 1, fontSize: '14px' }}
                                  />
                                  <div style={{ display: 'flex', gap: '8px', flexWrap: 'wrap' }}>
                                    {PRESET_COLORS.map((color) => (
                                      <div
                                        key={color.value}
                                        style={{
                                          width: '28px',
                                          height: '28px',
                                          borderRadius: '50%',
                                        backgroundColor: color.value,
                                        cursor: 'pointer',
                                        border: editingTest.color === color.value ? '3px solid var(--primary-contrast)' : '2px solid var(--border)',
                                        transition: 'all 0.2s ease',
                                      }}
                                        onClick={() => setEditingTest({ ...editingTest, color: color.value })}
                                        title={color.name}
                                      />
                                    ))}
                                  </div>
                                </div>
                              </div>
                              <div style={{ display: 'flex', gap: '8px', flexDirection: 'column' }}>
                                <button
                                  className="control-btn"
                                  onClick={saveEditedTest}
                                  style={{ padding: '8px 16px', fontSize: '13px', background: 'rgba(0, 184, 148, 0.2)', color: '#00b894' }}
                                >
                                   Save
                                </button>
                                <button
                                  className="control-btn"
                                  onClick={cancelEditingTest}
                                  style={{ padding: '8px 16px', fontSize: '13px', background: 'rgba(255, 107, 107, 0.2)', color: '#ff6b6b' }}
                                >
                                   Cancel
                                </button>
                              </div>
                            </>
                          ) : (
                            <>
                              <div
                                style={{
                                  width: '14px',
                                  height: '40px',
                                  borderRadius: '7px',
                                  backgroundColor: test.color,
                                  flexShrink: 0,
                                }}
                              />
                              <div style={{ flex: 1 }}>
                                <div style={{ fontWeight: 700, fontSize: '15px', marginBottom: '4px' }}>
                                  {test.name}
                                </div>
                                <div style={{
                                  fontSize: '13px',
                                  color: themeColors.textMuted,
                                }}>
                                  Score: {test.score} ({formatPercentile(getPercentileRank(test.score))} %ile)  {getScoreDescription(test.score)}
                                </div>
                              </div>
                              <div style={{ display: 'flex', gap: '8px' }}>
                                <button
                                  className="control-btn"
                                  onClick={() => startEditingTest(test)}
                                  style={{ padding: '8px 16px', fontSize: '13px' }}
                                >
                                   Edit
                                </button>
                                <button
                                  className="remove-btn"
                                  onClick={() => removeTest(test.id)}
                                >
                                  Remove
                                </button>
                              </div>
                            </>
                          )}
                        </div>
                      );
                    })}
                  </div>
                )}
              </div>
            </div>

            {/* Right Panel - Preview */}
            <div>
              <div className="chart-container">
                <h3 style={{
                  margin: '0 0 24px 0',
                  fontSize: '18px',
                  fontWeight: 700,
                  color: themeColors.text,
                  letterSpacing: '1px',
                  textTransform: 'uppercase',
                }}>
                   Live Preview
                </h3>
                
                <svg viewBox="0 -100 800 480" style={{ width: '100%', height: 'auto' }}>
                  {/* Grid lines */}
                {[55, 70, 85, 100, 115, 130, 145].map((score) => (
                  <line
                    key={score}
                    x1={getScoreX(score)}
                    y1={chartTopPadding}
                    x2={getScoreX(score)}
                    y2={chartBottomY}
                    stroke="var(--chart-grid)"
                    strokeDasharray="4,4"
                  />
                ))}

                  {/* Average range highlight (85-115) */}
                  <path
                    d={averageAreaPath}
                    fill="var(--chart-average)"
                  />

                  {/* Bell curve */}
                  <path
                    d={bellPath}
                    fill={`${bellCurveColor}26`}
                    stroke="url(#curveGradient)"
                    strokeWidth="3"
                  />

                  {/* Gradient definition */}
                  <defs>
                    <linearGradient id="curveGradient" x1="0%" y1="0%" x2="100%" y2="0%">
                      <stop offset="0%" stopColor={bellCurveColor} />
                      <stop offset="50%" stopColor={bellCurveColor} stopOpacity="0.7" />
                      <stop offset="100%" stopColor={bellCurveColor} />
                    </linearGradient>
                  </defs>

                  {/* Score labels */}
                  {SCORE_LABELS.map(({ score, label }) => (
                    <g key={score}>
                      <text
                        x={getScoreX(score)}
                        y="330"
                        textAnchor="middle"
                        fill="var(--chart-label)"
                        fontSize="12"
                        fontWeight="600"
                        fontFamily="Nunito, sans-serif"
                      >
                        {score}
                      </text>
                      <text
                        x={getScoreX(score)}
                        y="350"
                        textAnchor="middle"
                        fill="var(--chart-label-subtle)"
                        fontSize="9"
                        fontFamily="Nunito, sans-serif"
                      >
                        {label}
                      </text>
                    </g>
                  ))}

                  {/* Average range label */}
                  <text
                    x={getScoreX(100)}
                    y="370"
                    textAnchor="middle"
                    fill="var(--chart-label-muted)"
                    fontSize="10"
                    fontFamily="Nunito, sans-serif"
                    fontWeight="600"
                  >
                     Average Range (85-115) 
                  </text>

                  {/* Score markers with stacking */}
                  {getStackedPositions(tests).map(({ test, x, y, baseY }) => (
                    <g key={test.id} className="score-marker">
                      {/* Vertical line to base of curve */}
                      <line
                        x1={x}
                        y1={baseY}
                        x2={x}
                        y2={chartBottomY}
                        stroke={test.color}
                        strokeWidth="2"
                        strokeDasharray="4,4"
                        opacity="0.6"
                      />
                      {/* Connector line if stacked */}
                      {y < baseY && (
                        <line
                          x1={x}
                          y1={y + 12}
                          x2={x}
                          y2={baseY}
                          stroke={test.color}
                          strokeWidth="2"
                          opacity="0.4"
                        />
                      )}
                      {/* Marker dot */}
                      <circle
                        cx={x}
                        cy={y}
                        r="12"
                        fill={test.color}
                        stroke="white"
                        strokeWidth="3"
                      />
                      {/* Score label on marker */}
                      <text
                        x={x}
                        y={y + 4}
                        textAnchor="middle"
                        fill={getContrastTextColor(test.color)}
                        fontSize="9"
                        fontWeight="700"
                        fontFamily="Nunito, sans-serif"
                      >
                        {test.score}
                      </text>
                    </g>
                  ))}
                </svg>

                {/* Legend */}
                {tests.length > 0 && (
                  <div style={{
                    display: 'flex',
                    flexWrap: 'wrap',
                    gap: '10px',
                    marginTop: '24px',
                  }}>
                    {tests.map((test) => (
                      <div key={test.id} className="legend-item">
                        <div
                          style={{
                            width: '16px',
                            height: '16px',
                            borderRadius: '50%',
                            backgroundColor: test.color,
                          }}
                        />
                        <span style={{ fontSize: '13px', fontWeight: 600 }}>
                          {test.name}: {test.score}
                        </span>
                      </div>
                    ))}
                  </div>
                )}
              </div>

              {/* Info Panel */}
              <div className="info-panel">
                <h4 style={{
                  margin: '0 0 12px 0',
                  fontSize: '14px',
                  fontWeight: 700,
                  color: themeColors.text,
                }}>
                   Understanding the Bell Curve
                </h4>
                <p style={{
                  margin: 0,
                  fontSize: '13px',
                  lineHeight: '1.7',
                  color: themeColors.textSecondary,
                }}>
                  The <strong>shaded area</strong> represents the average range (85-115), where most scores fall.
                  Scores are measured on a standard scale where 100 is the mean average and each 15 points
                  represents one standard deviation from the mean.
                </p>
              </div>
            </div>
          </div>
        ) : printMode ? (
          /* REPORT PRINT VIEW */
          <div>
            {/* Print toolbar - hidden when actually printing */}
            <div className="print-toolbar">
              <div style={{ display: 'flex', alignItems: 'center', gap: '12px' }}>
                <button className="btn-back" onClick={() => setPrintMode(false)}>
                   Back to Presentation
                </button>
                <span style={{ fontSize: '14px', opacity: 0.7 }}>Report Preview</span>
              </div>
              <button className="btn-print" onClick={handlePrint}>
                 Print / Save PDF
              </button>
            </div>

            <div className="report-view">
              {/*  PAGE 1: SUMMARY  */}

              {/* Report Header */}
              <div className="report-header">
                {branding.schoolLogo && (
                  <img
                    src={branding.schoolLogo}
                    alt="School Logo"
                    style={{ maxWidth: '120px', maxHeight: '60px', objectFit: 'contain', marginBottom: '12px' }}
                  />
                )}
                <h1>
                  {studentName
                    ? `${studentName}'s Assessment Report`
                    : 'Student Assessment Report'}
                </h1>
                {branding.schoolName && (
                  <p className="subtitle">{branding.schoolName}</p>
                )}
                {assessmentDate && (
                  <p className="subtitle">
                    Assessment Date: {new Date(assessmentDate).toLocaleDateString('en-US', {
                      year: 'numeric', month: 'long', day: 'numeric'
                    })}
                  </p>
                )}
              </div>

              {/* Summary grid: Chart + Legend */}
              {getVisibleTests().length > 0 && (() => {
                const selectedTests = getVisibleTests();
                const sortedTests = [...selectedTests].sort((a, b) => b.score - a.score);
                const scoreGroups = groupTestsByScore(selectedTests);
                const dotStyle = getDotStyle(selectedTests.length);

                return (
                  <div className="report-summary-grid">
                    {/* LEFT: Bell curve chart (clean, minimal) */}
                    <div className="report-chart-box">
                      <h3 style={{ margin: '0 0 12px 0', fontSize: '15px', fontWeight: 700, color: '#1b1f2e' }}>
                        Score Distribution
                      </h3>
                      <svg viewBox="0 0 800 380" style={{ width: '100%', height: 'auto' }}>
                        {/* Grid lines */}
                        {[55, 70, 85, 100, 115, 130, 145].map((score) => (
                          <line
                            key={score}
                            x1={getScoreX(score)}
                            y1={chartTopPadding}
                            x2={getScoreX(score)}
                            y2={chartBottomY}
                            stroke="#d2d8e5"
                            strokeDasharray="4,4"
                          />
                        ))}

                        {/* Average range highlight */}
                        <path d={averageAreaPath} fill="rgba(27, 31, 46, 0.06)" />

                        {/* Bell curve */}
                        <path
                          d={bellPath}
                          fill={`${bellCurveColor}20`}
                          stroke={bellCurveColor}
                          strokeWidth="2.5"
                        />

                        {/* Gradient definition */}
                        <defs>
                          <filter id="printGlow">
                            <feGaussianBlur stdDeviation="2" result="blur" />
                            <feMerge>
                              <feMergeNode in="blur" />
                              <feMergeNode in="SourceGraphic" />
                            </feMerge>
                          </filter>
                        </defs>

                        {/* Score labels on x-axis */}
                        {SCORE_LABELS.map(({ score, label }) => (
                          <g key={score}>
                            <text x={getScoreX(score)} y="330" textAnchor="middle" fill="#2c344b" fontSize="12" fontWeight="600" fontFamily="Nunito, sans-serif">
                              {score}
                            </text>
                            <text x={getScoreX(score)} y="348" textAnchor="middle" fill="#6c7489" fontSize="9" fontFamily="Nunito, sans-serif">
                              {label}
                            </text>
                          </g>
                        ))}

                        {/* Average range label */}
                        <text x={getScoreX(100)} y="368" textAnchor="middle" fill="#4b556b" fontSize="10" fontFamily="Nunito, sans-serif" fontWeight="600">
                           Average Range (85-115) 
                        </text>

                        {/* Score dots */}
                        {dotStyle.clusterMode ? (
                          /* Cluster-only mode (25+ tests): one dot per unique score */
                          Array.from(scoreGroups.entries()).map(([score, testsAtScore]) => {
                            const x = getScoreX(score);
                            const y = getScoreY(score);
                            return (
                              <g key={`cluster-${score}`}>
                                <circle cx={x} cy={y} r={dotStyle.dotRadius + 2} fill={testsAtScore[0].color} stroke="white" strokeWidth="1.5" />
                                {testsAtScore.length > 1 && (
                                  <text x={x} y={y - dotStyle.dotRadius - 4} textAnchor="middle" fill="#1b1f2e" fontSize="8" fontWeight="700" fontFamily="Nunito, sans-serif">
                                    {testsAtScore.length}
                                  </text>
                                )}
                              </g>
                            );
                          })
                        ) : (
                          /* Normal mode: individual dots, slightly offset if same score */
                          (() => {
                            const allDots = [];
                            scoreGroups.forEach((testsAtScore, score) => {
                              const x = getScoreX(score);
                              const baseY = getScoreY(score);
                              if (testsAtScore.length === 1) {
                                allDots.push(
                                  <g key={testsAtScore[0].id}>
                                    <circle cx={x} cy={baseY} r={dotStyle.dotRadius} fill={testsAtScore[0].color} stroke="white" strokeWidth="1.5" />
                                  </g>
                                );
                              } else {
                                /* Cluster: one shared dot with N badge */
                                allDots.push(
                                  <g key={`cluster-${score}`}>
                                    <circle cx={x} cy={baseY} r={dotStyle.dotRadius + 2} fill={testsAtScore[0].color} stroke="white" strokeWidth="1.5" />
                                    <text x={x} y={baseY - dotStyle.dotRadius - 4} textAnchor="middle" fill="#1b1f2e" fontSize="8" fontWeight="700" fontFamily="Nunito, sans-serif">
                                      {testsAtScore.length}
                                    </text>
                                  </g>
                                );
                              }
                            });
                            return allDots;
                          })()
                        )}
                      </svg>
                    </div>

                    {/* RIGHT: Score Legend */}
                    <div className="report-legend-box">
                      <h3 style={{ margin: '0 0 10px 0', fontSize: '14px', fontWeight: 700, color: '#1b1f2e', textTransform: 'uppercase', letterSpacing: '0.5px' }}>
                        Score Legend
                      </h3>
                      <div style={{ maxHeight: '320px', overflowY: 'auto' }}>
                        {sortedTests.map((test) => (
                          <div key={test.id} className="report-legend-row">
                            <div style={{ width: '10px', height: '10px', borderRadius: '50%', backgroundColor: test.color, flexShrink: 0 }} />
                            <div style={{ flex: 1, minWidth: 0 }}>
                              <div style={{ fontWeight: 600, color: '#1b1f2e', whiteSpace: 'nowrap', overflow: 'hidden', textOverflow: 'ellipsis' }}>
                                {test.name}
                              </div>
                            </div>
                            <div style={{ textAlign: 'right', flexShrink: 0, fontSize: '12px' }}>
                              <span style={{ fontWeight: 700, color: test.color }}>{test.score}</span>
                              <span style={{ color: '#5b657a', marginLeft: '6px' }}>({formatPercentile(getPercentileRank(test.score))})</span>
                            </div>
                          </div>
                        ))}
                      </div>
                    </div>
                  </div>
                );
              })()}

              {/* Notes/Interpretation section */}
              {computedSummary && (
                <div style={{
                  border: '1px solid #d2d8e5',
                  borderRadius: '12px',
                  padding: '20px',
                  marginBottom: '32px',
                  background: '#fafbfd',
                }}>
                  <h3 style={{ margin: '0 0 10px 0', fontSize: '15px', fontWeight: 700, color: '#1b1f2e' }}>
                    Summary & Interpretation
                  </h3>
                  <p style={{ margin: 0, fontSize: '13px', lineHeight: 1.7, color: '#3b455c' }}>
                    {computedSummary}
                  </p>
                </div>
              )}

              {/*  PAGE 2+: FULL RESULTS TABLE  */}
              {getVisibleTests().length > 0 && (() => {
                const selectedTests = getVisibleTests();
                const sortedTests = [...selectedTests].sort((a, b) => b.score - a.score);

                return (
                  <div className="page-break-before">
                    <h2 style={{ margin: '0 0 16px 0', fontSize: '20px', fontWeight: 700, color: '#1b1f2e', borderBottom: '2px solid #667eea', paddingBottom: '10px' }}>
                      Full Results
                    </h2>
                    <table className="results-table">
                      <thead>
                        <tr>
                          <th style={{ width: '30px' }}></th>
                          <th>Test Name</th>
                          <th style={{ width: '100px' }}>Standard Score</th>
                          <th style={{ width: '90px' }}>Percentile</th>
                          <th style={{ width: '120px' }}>Range</th>
                        </tr>
                      </thead>
                      <tbody>
                        {sortedTests.map((test) => (
                          <tr key={test.id}>
                            <td>
                              <div style={{ width: '12px', height: '12px', borderRadius: '50%', backgroundColor: test.color, margin: '0 auto' }} />
                            </td>
                            <td style={{ fontWeight: 600 }}>{test.name}</td>
                            <td style={{ fontWeight: 700, color: test.color, textAlign: 'center' }}>{test.score}</td>
                            <td style={{ textAlign: 'center' }}>{formatPercentile(getPercentileRank(test.score))}</td>
                            <td>{getScoreDescription(test.score)}</td>
                          </tr>
                        ))}
                      </tbody>
                    </table>

                    {/* Summary statistics */}
                    <div style={{ display: 'flex', gap: '24px', marginTop: '24px', padding: '16px', background: '#f2f5fb', borderRadius: '8px', fontSize: '13px' }}>
                      <div><strong>Tests:</strong> {sortedTests.length}</div>
                      <div><strong>Mean Score:</strong> {Math.round(sortedTests.reduce((sum, t) => sum + t.score, 0) / sortedTests.length)}</div>
                      <div><strong>Highest:</strong> {Math.max(...sortedTests.map(t => t.score))}</div>
                      <div><strong>Lowest:</strong> {Math.min(...sortedTests.map(t => t.score))}</div>
                    </div>
                  </div>
                );
              })()}

              {/* Report footer */}
              <div style={{
                marginTop: '40px',
                paddingTop: '16px',
                borderTop: '1px solid #d2d8e5',
                fontSize: '11px',
                color: '#5b657a',
                textAlign: 'center',
              }}>
                {branding.footerText && <p style={{ margin: '0 0 6px 0' }}>{branding.footerText}</p>}
                <p style={{ margin: 0 }}>
                  Generated on {new Date().toLocaleDateString('en-US', { year: 'numeric', month: 'long', day: 'numeric' })}
                  {branding.schoolName && `  ${branding.schoolName}`}
                </p>
              </div>
            </div>
          </div>
        ) : (
          /* PRESENTATION MODE */
          <div>
            {/* Print-only header with branding */}
            <div className="print-only print-header" style={{ display: 'none' }}>
              <div>
                {branding.schoolLogo && (
                  <img
                    src={branding.schoolLogo}
                    alt="School Logo"
                    className="print-logo"
                  />
                )}
              </div>
              <div style={{ textAlign: 'right' }}>
                {branding.schoolName && (
                  <h1 style={{
                    margin: '0 0 8px 0',
                    fontSize: '24px',
                    fontWeight: 700,
                    color: '#1a1a2e',
                  }}>
                    {branding.schoolName}
                  </h1>
                )}
                <p style={{
                  margin: 0,
                  fontSize: '14px',
                  color: '#666',
                }}>
                  Student Assessment Report
                </p>
              </div>
            </div>

            <div className="presentation-header">
              {studentName && (
                <h2 style={{
                  fontFamily: "'Playfair Display', serif",
                  fontSize: '42px',
                  fontWeight: 700,
                  margin: '0 0 10px 0',
                  background: 'var(--title-gradient)',
                  WebkitBackgroundClip: 'text',
                  WebkitTextFillColor: 'transparent',
                }}>
                  {studentName}'s Score Profile
                </h2>
              )}
              {assessmentDate && (
                <p style={{
                  color: themeColors.textMuted,
                  fontSize: '16px',
                  margin: 0,
                }}>
                  Assessment Date: {new Date(assessmentDate).toLocaleDateString('en-US', {
                    year: 'numeric',
                    month: 'long',
                    day: 'numeric'
                  })}
                </p>
              )}
            </div>

            {/* Main content area with side-by-side layout */}
            <div style={{ display: 'flex', gap: '32px', alignItems: 'flex-start' }}>
              {/* Left column - Test Selection and Score Cards */}
              <div style={{ width: '320px', flexShrink: 0 }}>
                {/* Test Selection Panel */}
                {tests.length > 0 && (
                  <div style={{
                    background: themeColors.cardBg,
                    borderRadius: '20px',
                    padding: '20px',
                    marginBottom: '20px',
                    border: `1px solid ${themeColors.cardBorder}`,
                  }}>
                    <div style={{
                      display: 'flex',
                      justifyContent: 'space-between',
                      alignItems: 'center',
                      marginBottom: '16px',
                    }}>
                      <h3 style={{
                        margin: 0,
                        fontSize: '14px',
                        fontWeight: 700,
                        color: themeColors.text,
                        letterSpacing: '1px',
                        textTransform: 'uppercase',
                      }}>
                         Select Tests
                      </h3>
                      <div style={{ display: 'flex', gap: '8px' }}>
                        <button className="control-btn" onClick={showAllTests} style={{ fontSize: '11px', padding: '6px 10px' }}>
                          Show All
                        </button>
                        <button className="control-btn" onClick={hideAllTests} style={{ fontSize: '11px', padding: '6px 10px' }}>
                          Hide All
                        </button>
                      </div>
                    </div>

                    <div style={{
                      display: 'flex',
                      flexDirection: 'column',
                      gap: '8px',
                      maxHeight: '300px',
                      overflowY: 'auto',
                    }}>
                      {tests.map((test) => {
                        const isChecked = visibleTestIds.has(test.id);
                        const isFocused = focusedTestId === test.id;
                        const isHovered = hoveredTestId === test.id;
                        return (
                          <div
                            key={test.id}
                            ref={(el) => { sidebarRowRefs.current[test.id] = el; }}
                            className={`checkbox-card ${isChecked ? 'checked' : ''}`}
                            onClick={(e) => {
                              // If clicking the checkbox area, toggle visibility
                              if (e.target.closest('.custom-checkbox')) {
                                toggleTestVisibility(test.id);
                              } else {
                                // Otherwise, set as active test
                                setActiveTestId(test.id);
                                // Ensure test is visible when clicked
                                if (!visibleTestIds.has(test.id)) {
                                  toggleTestVisibility(test.id);
                                }
                              }
                            }}
                            onMouseEnter={() => setHoveredTestId(test.id)}
                            onMouseLeave={() => setHoveredTestId(null)}
                            style={{
                              color: test.color,
                              padding: '10px 14px',
                              background: isFocused
                                ? `${test.color}25`
                                : isHovered
                                  ? `${test.color}15`
                                  : undefined,
                              borderLeft: isFocused ? `3px solid ${test.color}` : '3px solid transparent',
                              transition: 'all 0.15s ease',
                            }}
                          >
                            <div
                              className={`custom-checkbox ${isChecked ? 'checked' : ''}`}
                              onClick={(e) => {
                                e.stopPropagation();
                                toggleTestVisibility(test.id);
                              }}
                              style={{
                                borderColor: isChecked ? test.color : undefined,
                                background: isChecked ? test.color : 'transparent',
                                width: '20px',
                                height: '20px',
                              }}
                            >
                              {isChecked && <span className="checkmark" style={{ color: getContrastTextColor(test.color), fontSize: '12px' }}></span>}
                            </div>
                            <div
                              style={{
                                width: '8px',
                                height: '28px',
                                borderRadius: '4px',
                                backgroundColor: test.color,
                                flexShrink: 0,
                              }}
                            />
                            <div style={{ flex: 1 }}>
                              <div style={{
                                fontWeight: isFocused ? 800 : 700,
                                fontSize: '13px',
                                color: isFocused ? test.color : themeColors.text,
                                marginBottom: '2px',
                              }}>
                                {test.name}
                              </div>
                              <div style={{
                                fontSize: '11px',
                                color: themeColors.textMuted,
                              }}>
                                Score: <span style={{ color: test.color, fontWeight: 700 }}>{test.score}</span> ({formatPercentile(getPercentileRank(test.score))})
                              </div>
                            </div>
                          </div>
                        );
                      })}
                    </div>
                  </div>
                )}

                {/* Test Details Panel - Single panel that shows focused test */}
                <div style={{
                  background: themeColors.cardBg,
                  borderRadius: '14px',
                  padding: '16px',
                  border: `1px solid ${themeColors.cardBorder}`,
                  borderLeft: focusedTest ? `4px solid ${focusedTest.color}` : `4px solid ${themeColors.cardBorder}`,
                  minHeight: '140px',
                }}>
                  <h4 style={{
                    margin: '0 0 12px 0',
                    fontSize: '12px',
                    fontWeight: 700,
                    color: themeColors.textMuted,
                    letterSpacing: '1px',
                    textTransform: 'uppercase',
                  }}>
                     Test Details
                  </h4>
                  {focusedTest ? (
                    <>
                      <div style={{
                        display: 'flex',
                        alignItems: 'center',
                        gap: '10px',
                        marginBottom: '12px',
                      }}>
                        <div
                          style={{
                            width: '14px',
                            height: '14px',
                            borderRadius: '50%',
                            backgroundColor: focusedTest.color,
                          }}
                        />
                        <h4 style={{
                          margin: 0,
                          fontSize: '15px',
                          fontWeight: 700,
                          color: focusedTest.color,
                        }}>
                          {focusedTest.name}
                        </h4>
                      </div>
                      <div style={{
                        fontSize: '36px',
                        fontWeight: 800,
                        color: focusedTest.color,
                        marginBottom: '4px',
                        lineHeight: 1,
                      }}>
                        {focusedTest.score}
                      </div>
                      <div style={{
                        fontSize: '14px',
                        color: themeColors.textSecondary,
                        fontWeight: 700,
                        marginBottom: '6px',
                      }}>
                        {formatPercentile(getPercentileRank(focusedTest.score))} Percentile
                      </div>
                      <div style={{
                        fontSize: '13px',
                        color: themeColors.textMuted,
                        fontWeight: 600,
                        marginBottom: '8px',
                      }}>
                        {getScoreDescription(focusedTest.score)} Range
                      </div>
                      <div style={{
                        fontSize: '11px',
                        color: themeColors.textMuted,
                        fontStyle: 'italic',
                        borderTop: `1px solid ${themeColors.cardBorder}`,
                        paddingTop: '8px',
                        marginTop: '4px',
                      }}>
                        {activeTestId === focusedTest.id ? ' Pinned selection' : ' Click to pin selection'}
                      </div>
                    </>
                  ) : (
                    <div style={{
                      display: 'flex',
                      flexDirection: 'column',
                      alignItems: 'center',
                      justifyContent: 'center',
                      padding: '20px',
                      color: themeColors.textMuted,
                      textAlign: 'center',
                    }}>
                      <div style={{ fontSize: '24px', marginBottom: '8px' }}></div>
                      <div style={{ fontSize: '13px' }}>
                        Select a test from the list or hover over a marker to see details
                      </div>
                    </div>
                  )}
                </div>
              </div>

              {/* Right column - Chart */}
              <div style={{ flex: 1, minWidth: 0 }}>
                <div className="chart-container" style={{ marginBottom: '32px', position: 'relative' }}>
              {/* Hover instruction */}
              <p style={{
                margin: '0 0 16px 0',
                fontSize: '13px',
                color: themeColors.textMuted,
              }}>
                 Hover over any score marker to see the test name
              </p>

              <svg viewBox="0 -100 800 540" style={{ width: '100%', height: 'auto' }}>
                {/* Grid lines */}
                {[55, 70, 85, 100, 115, 130, 145].map((score) => (
                  <line
                    key={score}
                    x1={getScoreX(score)}
                    y1={chartTopPadding}
                    x2={getScoreX(score)}
                    y2={chartBottomY}
                    stroke="var(--chart-grid)"
                    strokeDasharray="4,4"
                  />
                ))}

                {/* Average range highlight (85-115) */}
                <path
                  d={averageAreaPath}
                  fill="var(--chart-average)"
                />

                {/* Bell curve */}
                <path
                  d={bellPath}
                  fill="var(--chart-bell-fill)"
                  stroke="url(#curveGradientPres)"
                  strokeWidth="3"
                />

                {/* Gradient definition */}
                <defs>
                  <linearGradient id="curveGradientPres" x1="0%" y1="0%" x2="100%" y2="0%">
                    <stop offset="0%" stopColor="#667eea" />
                    <stop offset="50%" stopColor="#764ba2" />
                    <stop offset="100%" stopColor="#667eea" />
                  </linearGradient>
                  <filter id="glow">
                    <feGaussianBlur stdDeviation="3" result="coloredBlur"/>
                    <feMerge>
                      <feMergeNode in="coloredBlur"/>
                      <feMergeNode in="SourceGraphic"/>
                    </feMerge>
                  </filter>
                  <filter id="tooltipShadow">
                    <feDropShadow dx="0" dy="2" stdDeviation="4" floodOpacity="0.5"/>
                  </filter>
                </defs>

                {/* Score labels on x-axis */}
                {SCORE_LABELS.map(({ score, label }) => (
                  <g key={score}>
                    <text
                      x={getScoreX(score)}
                      y="330"
                      textAnchor="middle"
                      fill="var(--chart-label)"
                      fontSize="14"
                      fontWeight="700"
                      fontFamily="Nunito, sans-serif"
                    >
                      {score}
                    </text>
                    <text
                      x={getScoreX(score)}
                      y="350"
                      textAnchor="middle"
                      fill="var(--chart-label-muted)"
                      fontSize="11"
                      fontFamily="Nunito, sans-serif"
                    >
                      {label}
                    </text>
                    <text
                      x={getScoreX(score)}
                      y="365"
                      textAnchor="middle"
                      fill="var(--chart-label-subtle)"
                      fontSize="9"
                      fontFamily="Nunito, sans-serif"
                      fontStyle="italic"
                    >
                      {formatPercentile(getPercentileRank(score))} %ile
                    </text>
                  </g>
                ))}

                {/* Average range indicator */}
                <text
                  x={getScoreX(100)}
                  y="390"
                  textAnchor="middle"
                  fill="var(--chart-label-muted)"
                  fontSize="12"
                  fontFamily="Nunito, sans-serif"
                  fontWeight="600"
                >
                   Average Range (85-115) 
                </text>

                {/* Score markers - grouped by exact score */}
                {(() => {
                  const scoreGroups = groupTestsByScore(getVisibleTests());
                  const markers = [];

                  scoreGroups.forEach((testsAtScore, score) => {
                    const x = getScoreX(score);
                    const baseY = getScoreY(score);
                    const isCluster = testsAtScore.length > 1;
                    const clusterId = `cluster-${score}`;
                    const isClusterOpen = openClusterId === clusterId;

                    // Check if any test in this cluster is hovered or active
                    const hasHoveredTest = testsAtScore.some(t => t.id === hoveredTestId);
                    const hasActiveTest = testsAtScore.some(t => t.id === activeTestId);
                    const hasFocusedTest = testsAtScore.some(t => t.id === focusedTestId);

                    // For single markers
                    if (!isCluster) {
                      const test = testsAtScore[0];
                      const isHovered = hoveredTestId === test.id;
                      const isActive = activeTestId === test.id;
                      const isFocused = focusedTestId === test.id;
                      const isHidden = (hoveredTestId !== null || activeTestId !== null) && !isHovered && !isActive;
                      const textColor = getContrastTextColor(test.color);

                      markers.push(
                        <g
                          key={test.id}
                          className="score-marker"
                          onMouseEnter={() => setHoveredTestId(test.id)}
                          onMouseLeave={() => setHoveredTestId(null)}
                          onClick={() => setActiveTestId(test.id)}
                          style={{
                            cursor: 'pointer',
                            opacity: isHidden ? 0.2 : 1,
                            transition: 'opacity 0.2s ease',
                          }}
                        >
                          {/* Vertical line to curve */}
                          <line
                            x1={x}
                            y1={baseY}
                            x2={x}
                            y2={chartBottomY}
                            stroke={test.color}
                            strokeWidth="2"
                            strokeDasharray="6,4"
                            opacity={isHidden ? 0.3 : 0.7}
                          />
                          {/* Marker dot */}
                          <circle
                            cx={x}
                            cy={baseY}
                            r={isFocused ? 22 : 18}
                            fill={test.color}
                            stroke="white"
                            strokeWidth={isFocused ? 4 : 3}
                            filter={isFocused ? "url(#glow)" : "none"}
                            style={{ transition: 'all 0.2s ease' }}
                          />
                          {/* Score on marker */}
                          <text
                            x={x}
                            y={baseY + 5}
                            textAnchor="middle"
                            fill={textColor}
                            fontSize={isFocused ? "14" : "12"}
                            fontWeight="800"
                            fontFamily="Nunito, sans-serif"
                            style={{ transition: 'all 0.2s ease', pointerEvents: 'none' }}
                          >
                            {test.score}
                          </text>

                          {/* Tooltip on hover for single marker */}
                          {isHovered && (
                            <g className="tooltip">
                              <rect
                                x={x - Math.max(test.name.length * 4.5 + 16, 80)}
                                y={baseY - 80}
                                width={Math.max(test.name.length * 9 + 32, 160)}
                                height="54"
                                rx="10"
                                fill="#1a1a2e"
                                stroke={test.color}
                                strokeWidth="2"
                                filter="url(#tooltipShadow)"
                              />
                              <polygon
                                points={`${x - 10},${baseY - 26} ${x + 10},${baseY - 26} ${x},${baseY - 18}`}
                                fill="#1a1a2e"
                                stroke={test.color}
                                strokeWidth="2"
                              />
                              <rect x={x - 9} y={baseY - 28} width="18" height="4" fill="#1a1a2e" />
                              <text
                                x={x}
                                y={baseY - 56}
                                textAnchor="middle"
                                fill="#ffffff"
                                fontSize="14"
                                fontWeight="700"
                                fontFamily="Nunito, sans-serif"
                              >
                                {test.name}
                              </text>
                              <text
                                x={x}
                                y={baseY - 38}
                                textAnchor="middle"
                                fill={test.color}
                                fontSize="12"
                                fontWeight="600"
                                fontFamily="Nunito, sans-serif"
                              >
                                {formatPercentile(getPercentileRank(test.score))} Percentile
                              </text>
                            </g>
                          )}
                        </g>
                      );
                    } else {
                      // Cluster marker for multiple tests at same score
                      const primaryColor = testsAtScore[0].color;
                      const isHidden = (hoveredTestId !== null || activeTestId !== null) && !hasHoveredTest && !hasActiveTest;

                      markers.push(
                        <g
                          key={clusterId}
                          className="cluster-marker"
                          onMouseEnter={() => !isClusterOpen && setOpenClusterId(clusterId)}
                          onClick={() => setOpenClusterId(isClusterOpen ? null : clusterId)}
                          style={{
                            cursor: 'pointer',
                            opacity: isHidden ? 0.2 : 1,
                            transition: 'opacity 0.2s ease',
                          }}
                        >
                          {/* Vertical line to curve */}
                          <line
                            x1={x}
                            y1={baseY}
                            x2={x}
                            y2={chartBottomY}
                            stroke={primaryColor}
                            strokeWidth="2"
                            strokeDasharray="6,4"
                            opacity={isHidden ? 0.3 : 0.7}
                          />
                          {/* Cluster marker - gradient ring */}
                          <circle
                            cx={x}
                            cy={baseY}
                            r={hasFocusedTest || isClusterOpen ? 24 : 20}
                            fill="url(#clusterGradient)"
                            stroke="white"
                            strokeWidth={hasFocusedTest || isClusterOpen ? 4 : 3}
                            filter={hasFocusedTest || isClusterOpen ? "url(#glow)" : "none"}
                            style={{ transition: 'all 0.2s ease' }}
                          />
                          {/* Score on marker */}
                          <text
                            x={x}
                            y={baseY + 4}
                            textAnchor="middle"
                            fill="white"
                            fontSize="12"
                            fontWeight="800"
                            fontFamily="Nunito, sans-serif"
                            style={{ pointerEvents: 'none' }}
                          >
                            {score}
                          </text>
                          {/* Badge showing count */}
                          <circle
                            cx={x + 16}
                            cy={baseY - 14}
                            r="10"
                            fill="#667eea"
                            stroke="white"
                            strokeWidth="2"
                          />
                          <text
                            x={x + 16}
                            y={baseY - 10}
                            textAnchor="middle"
                            fill="white"
                            fontSize="10"
                            fontWeight="800"
                            fontFamily="Nunito, sans-serif"
                            style={{ pointerEvents: 'none' }}
                          >
                            {testsAtScore.length}
                          </text>
                        </g>
                      );
                    }
                  });

                  return markers;
                })()}

                {/* Gradient for cluster markers */}
                <defs>
                  <linearGradient id="clusterGradient" x1="0%" y1="0%" x2="100%" y2="100%">
                    <stop offset="0%" stopColor="#667eea" />
                    <stop offset="100%" stopColor="#764ba2" />
                  </linearGradient>
                </defs>
              </svg>

              {/* Cluster Legend Popover - rendered outside SVG */}
              {openClusterId && (() => {
                const score = parseInt(openClusterId.replace('cluster-', ''));
                const testsAtScore = getVisibleTests().filter(t => t.score === score);
                if (testsAtScore.length === 0) return null;

                // Calculate position relative to chart
                const xPercent = ((score - 40) / 120) * 100;
                const popoverLeft = xPercent < 50 ? `${xPercent + 5}%` : `${xPercent - 25}%`;

                return (
                  <div
                    className="cluster-popover"
                    style={{
                      position: 'absolute',
                      left: popoverLeft,
                      top: '80px',
                      background: themeColors.cardBg,
                      border: `2px solid ${themeColors.primary}`,
                      borderRadius: '12px',
                      padding: '12px',
                      minWidth: '200px',
                      maxWidth: '280px',
                      boxShadow: '0 8px 32px rgba(0,0,0,0.3)',
                      zIndex: 100,
                    }}
                  >
                    <div style={{
                      fontSize: '11px',
                      fontWeight: 700,
                      color: themeColors.textMuted,
                      marginBottom: '8px',
                      textTransform: 'uppercase',
                      letterSpacing: '0.5px',
                    }}>
                      {testsAtScore.length} tests at score {score}
                    </div>
                    <div style={{ display: 'flex', flexDirection: 'column', gap: '6px' }}>
                      {testsAtScore.map(test => {
                        const isItemHovered = hoveredTestId === test.id;
                        const isItemActive = activeTestId === test.id;
                        return (
                          <div
                            key={test.id}
                            onMouseEnter={() => setHoveredTestId(test.id)}
                            onMouseLeave={() => setHoveredTestId(null)}
                            onClick={() => {
                              setActiveTestId(test.id);
                              setOpenClusterId(null);
                            }}
                            style={{
                              display: 'flex',
                              alignItems: 'center',
                              gap: '8px',
                              padding: '8px 10px',
                              borderRadius: '8px',
                              cursor: 'pointer',
                              background: isItemActive
                                ? `${test.color}30`
                                : isItemHovered
                                  ? `${test.color}20`
                                  : 'transparent',
                              borderLeft: isItemActive ? `3px solid ${test.color}` : '3px solid transparent',
                              transition: 'all 0.15s ease',
                            }}
                          >
                            <div
                              style={{
                                width: '10px',
                                height: '10px',
                                borderRadius: '50%',
                                backgroundColor: test.color,
                                flexShrink: 0,
                              }}
                            />
                            <div style={{ flex: 1, minWidth: 0 }}>
                              <div style={{
                                fontSize: '13px',
                                fontWeight: 600,
                                color: isItemActive ? test.color : themeColors.text,
                                whiteSpace: 'nowrap',
                                overflow: 'hidden',
                                textOverflow: 'ellipsis',
                              }}>
                                {test.name}
                              </div>
                              <div style={{
                                fontSize: '11px',
                                color: themeColors.textMuted,
                              }}>
                                {formatPercentile(getPercentileRank(test.score))} Percentile
                              </div>
                            </div>
                          </div>
                        );
                      })}
                    </div>
                    <div style={{
                      fontSize: '10px',
                      color: themeColors.textMuted,
                      marginTop: '8px',
                      paddingTop: '8px',
                      borderTop: `1px solid ${themeColors.cardBorder}`,
                      textAlign: 'center',
                    }}>
                      Click a test to select  Press Esc to close
                    </div>
                  </div>
                );
              })()}
                </div>
              </div>
            </div>

            {tests.length === 0 && (
              <div style={{
                textAlign: 'center',
                padding: '80px 40px',
                background: themeColors.cardBg,
                borderRadius: '20px',
                color: themeColors.textMuted,
              }}>
                <div style={{ fontSize: '48px', marginBottom: '16px' }}></div>
                <p style={{ fontSize: '18px', margin: 0 }}>
                  Switch to Input Mode to add test scores
                </p>
              </div>
            )}

            {/* Assessment Summary */}
            {tests.length > 0 && (
              <>
                <div style={{
                  background: themeColors.cardBg,
                  borderRadius: '20px',
                  padding: '28px',
                  marginBottom: '32px',
                  border: `1px solid ${themeColors.cardBorder}`,
                }}>
                  <h3 style={{
                    margin: '0 0 20px 0',
                    fontSize: '18px',
                    fontWeight: 700,
                    color: themeColors.text,
                    letterSpacing: '1px',
                    textTransform: 'uppercase',
                  }}>
                     Editable Summary
                  </h3>
                  <p style={{
                    margin: '0 0 12px 0',
                    fontSize: '13px',
                    color: themeColors.textMuted,
                  }}>
                    Customize the auto-generated summary for this student. Leave blank to use the default narrative.
                  </p>
                  <textarea
                    value={summaryOverride}
                    onChange={(e) => setSummaryOverride(e.target.value)}
                    placeholder={generateSummary()}
                    className="input-field"
                    style={{ width: '100%', minHeight: '140px', resize: 'vertical' }}
                  />
                  <div style={{ display: 'flex', justifyContent: 'flex-end', marginTop: '12px' }}>
                    <button
                      className="control-btn"
                      onClick={() => setSummaryOverride('')}
                    >
                      Reset to Auto Summary
                    </button>
                  </div>
                </div>

                <div style={{
                  background: themeColors.cardBg,
                  borderRadius: '20px',
                  padding: '28px',
                  marginBottom: '32px',
                  border: `1px solid ${themeColors.cardBorder}`,
                }}>
                  <h3 style={{
                    margin: '0 0 20px 0',
                    fontSize: '18px',
                    fontWeight: 700,
                    color: themeColors.text,
                    letterSpacing: '1px',
                    textTransform: 'uppercase',
                  }}>
                     Assessment Summary
                  </h3>
                  <div style={{
                    fontSize: '15px',
                    lineHeight: '1.8',
                    color: themeColors.text,
                    textAlign: 'justify',
                  }}>
                    {computedSummary}
                  </div>
                </div>
              </>
            )}

            {/* Parent-Friendly Explanation (visible in print) */}
            {tests.length > 0 && (
              <div className="print-only" style={{
                display: 'none',
                background: '#f8f9fa',
                borderRadius: '12px',
                padding: '24px',
                marginBottom: '24px',
                border: '1px solid #ddd',
              }}>
                <h3 style={{
                  margin: '0 0 16px 0',
                  fontSize: '18px',
                  fontWeight: 700,
                  color: '#1a1a2e',
                }}>
                  Understanding Your Child's Assessment Results
                </h3>
                <p style={{
                  margin: '0 0 12px 0',
                  fontSize: '14px',
                  lineHeight: '1.6',
                  color: '#333',
                }}>
                  This report shows your child's test scores plotted on a bell curve, which represents how scores typically distribute across a population. The bell curve helps visualize where your child's performance falls relative to expected norms.
                </p>
                <p style={{
                  margin: '0 0 12px 0',
                  fontSize: '14px',
                  lineHeight: '1.6',
                  color: '#333',
                }}>
                  <strong>The Average Range (85-115):</strong> Most students score in this range (about 68% of all test-takers). Scores in this range indicate typical, age-appropriate performance.
                </p>
                <p style={{
                  margin: 0,
                  fontSize: '14px',
                  lineHeight: '1.6',
                  color: '#333',
                }}>
                  <strong>Score Scale:</strong> Scores are standardized with an average of 100 and typically range from 40 to 160. Each 15-point increment represents one standard deviation from the average.
                </p>
              </div>
            )}

            {/* Interpretation Guide */}
            {tests.length > 0 && (
              <div style={{
                background: themeColors.cardBg,
                borderRadius: '20px',
                padding: '28px',
                border: `1px solid ${themeColors.cardBorder}`,
              }}>
                <h3 style={{
                  margin: '0 0 20px 0',
                  fontSize: '18px',
                  fontWeight: 700,
                  color: themeColors.text,
                }}>
                   Score Interpretation Guide
                </h3>
                <div style={{
                  display: 'grid',
                  gridTemplateColumns: 'repeat(auto-fit, minmax(200px, 1fr))',
                  gap: '16px',
                }}>
                  {[
                    { range: '130+', label: 'Very High', desc: 'Top 2%' },
                    { range: '115-129', label: 'High', desc: 'Top 16%' },
                    { range: '85-114', label: 'Average', desc: 'Middle 68%' },
                    { range: '70-84', label: 'Low', desc: 'Bottom 16%' },
                    { range: 'Below 70', label: 'Very Low', desc: 'Bottom 2%' },
                  ].map((item) => (
                    <div
                      key={item.range}
                      style={{
                        padding: '16px',
                        background: 'var(--surface-2)',
                        borderRadius: '12px',
                      }}
                    >
                      <div style={{
                        fontSize: '16px',
                        fontWeight: 700,
                        marginBottom: '4px',
                      }}>
                        {item.range}
                      </div>
                      <div style={{
                        fontSize: '13px',
                        color: themeColors.textSecondary,
                      }}>
                        {item.label}  {item.desc}
                      </div>
                    </div>
                  ))}
                </div>
              </div>
            )}

            {/* Print-only footer with branding */}
            <div className="print-only print-footer" style={{ display: 'none' }}>
              {branding.footerText && (
                <p style={{ margin: '0 0 10px 0' }}>
                  {branding.footerText}
                </p>
              )}
              <p style={{ margin: 0 }}>
                Generated on {new Date().toLocaleDateString('en-US', {
                  year: 'numeric',
                  month: 'long',
                  day: 'numeric'
                })}
                {branding.schoolName && `  ${branding.schoolName}`}
              </p>
            </div>
          </div>
        )}
      </div>
    </div>
  );
}



        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<BellCurveApp />);
    </script>
</body>
</html>
